{% include 'header.html' %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro de Madrid - Informaci√≥n de Estaci√≥n</title>
    
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/png" href="/static/logos/Logomarca_azul.png">
    <link rel="apple-touch-icon" href="/static/logos/Logomarca_azul.png">
    
    <!-- Archivos CSS -->
    <link rel="stylesheet" href="/static/css/modern-trains.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}">
    <link rel="stylesheet" href="/static/css/stations.css">
    
    <style>
        /* Variables CSS para temas */
        :root {
            --bg-primary: #f7f7f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f9fa;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #e9ecef;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --metro-main: #0065FE;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .main-content {
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 2.5em;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .page-header p {
            font-size: 1.2em;
            color: var(--text-secondary);
        }

        /* Bot√≥n de favoritos */
        .favorite-btn {
            background: var(--bg-secondary);
            border: 2px solid #ddd;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .favorite-btn:hover {
            background: #fff3cd;
            border-color: #ffc107;
            transform: scale(1.1);
        }

        .favorite-btn.active {
            background: #ffc107;
            border-color: #ffb300;
            color: #fff;
        }

        .favorite-btn.active:hover {
            background: #ffb300;
            border-color: #ff8f00;
        }

        /* Bot√≥n de favoritos */
        .favorite-btn {
            background: var(--bg-secondary);
            border: 2px solid #ddd;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .favorite-btn:hover {
            background: #fff3cd;
            border-color: #ffc107;
            transform: scale(1.1);
        }

        .favorite-btn.active {
            background: #ffc107;
            border-color: #ffb300;
            color: #fff;
        }

        .favorite-btn.active:hover {
            background: #ffb300;
            border-color: #ff8f00;
        }

        /* Secci√≥n de b√∫squeda */
        .search-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .search-container-centered {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        .search-title {
            color: var(--metro-main);
            margin-bottom: 25px;
            font-size: 2em;
            font-weight: 700;
        }

        .search-form-centered {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .search-input-container {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-input-container input {
            width: 100%;
            padding: 18px 20px;
            border: 3px solid var(--border-color);
            border-radius: 25px;
            font-size: 18px;
            transition: all 0.3s ease;
            background: var(--bg-tertiary);
            box-shadow: var(--shadow);
            color: var(--text-primary);
        }

        .search-input-container input:focus {
            outline: none;
            border-color: var(--metro-main);
            background: var(--bg-secondary);
            box-shadow: 0 4px 20px rgba(0,174,239,0.2);
            transform: translateY(-2px);
        }

        .search-btn-rocket {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--metro-main) 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .search-btn-rocket:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .search-tips {
            color: var(--text-secondary);
            font-size: 0.95em;
            line-height: 1.5;
            margin: 0;
            opacity: 0.8;
        }

        /* Informaci√≥n de estaci√≥n */
        .station-info {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            display: none;
        }

        .station-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .station-icon {
            font-size: 3em;
            color: var(--metro-main);
        }

        .station-details h3 {
            font-size: 2em;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .station-details p {
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .station-status {
            background: #28a745;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .refresh-btn {
            background: var(--metro-main);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        /* Secciones de informaci√≥n */
        .schedules-section,
        .model-3d-section,
        .detailed-info,
        .lines-section {
            margin-bottom: 30px;
        }

        .schedules-section h4,
        .model-3d-section h4,
        .lines-section h4 {
            color: var(--metro-main);
            font-size: 1.5em;
            margin-bottom: 15px;
        }

        .detailed-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .info-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .info-card h5 {
            color: var(--metro-main);
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
        }

        .footer p {
            margin: 5px 0;
        }

        /* Estados de carga y error */
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .no-data {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* L√≠neas */
        .lines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .line-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .line-logo {
            width: 40px;
            height: 40px;
        }

        .line-info h5 {
            margin: 0;
            color: var(--text-primary);
        }

        .line-info p {
            margin: 5px 0 0 0;
            color: var(--text-secondary);
            font-size: 0.9em;
        }

        /* Autocompletado */
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 12px 12px;
            box-shadow: var(--shadow);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .autocomplete-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            transition: background-color 0.2s ease;
        }

        .autocomplete-item:hover,
        .autocomplete-item.selected {
            background-color: var(--bg-tertiary);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-multilogo {
            margin-right: 12px;
            display: flex;
            align-items: center;
        }

        .autocomplete-info {
            flex: 1;
        }

        .autocomplete-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .autocomplete-details {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        /* Encabezados de l√≠nea en autocompletado */
        .autocomplete-line-header {
            background: var(--bg-tertiary);
            padding: 12px 20px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: bold;
            color: var(--text-primary);
            font-size: 0.95em;
        }

        .autocomplete-line-icon {
            flex-shrink: 0;
        }

        .autocomplete-line-title {
            flex: 1;
        }

        .autocomplete-line-count {
            background: var(--metro-main);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: normal;
        }

        /* Encabezados de estaci√≥n en autocompletado */
        .autocomplete-station-header {
            background: var(--metro-main);
            color: white;
            padding: 15px 20px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: bold;
            font-size: 1.1em;
        }

        .autocomplete-station-name {
            flex: 1;
        }

        .autocomplete-station-count {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: normal;
        }

        /* CSS extra para multilogo */
        .autocomplete-multilogo {
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }


        /* CSS para la imagen 3D y estado en la p√°gina principal */
        .station-3d-section {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 32px;
            margin-top: 24px;
            padding: 18px 18px 10px 18px;
            background: #f8f9fa;
            border-radius: 14px;
            border: 1px solid #e9ecef;
            align-items: start;
        }
        
        .model-3d-column {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
        }
        
        .status-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
            justify-content: flex-start;
        }
        
        .model-3d-image {
            max-width: 600px;
            width: auto;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.10);
            margin-bottom: 8px;
        }
        .model-3d-caption {
            margin-top: 4px;
            font-size: 0.92em;
            color: #888;
            font-style: italic;
        }
        .elevators-status-card,
        .last-update-card {
            background: #fff;
            border-radius: 8px;
            padding: 16px 18px 12px 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
            margin-bottom: 0;
        }
        
        .last-update-card h4 {
            margin: 0 0 10px 0;
            flex-basis: 50%;
            color: #333;
            font-size: 1.08em;
        }
        .elevator-status-item {
            padding: 5px 0;
        }
        .status-text {
            white-space: nowrap;
            color: #b22222;
            font-weight: 600;
            font-size: 1em;
        }
        .update-time {
            font-size: 1em;
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }
        .update-source {
            font-size: 0.92em;
            color: #888;
            margin-bottom: 2px;
        }
        .update-realtime {
            font-size: 0.85em;
            color: #28a745;
            font-weight: 500;
        }
        @media (max-width: 900px) {
            .station-3d-section {
                grid-template-columns: 1fr;
                gap: 18px;
                padding: 10px;
            }
            .model-3d-image {
                max-width: 400px;
                max-height:min-content;
            }
        }

        /* CSS para conexiones */
        .connections-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .connection-item {
            display: flex;
            align-items: center;
            background: var(--bg-tertiary);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .connection-item:hover {
            background: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .connection-item span {
            font-weight: 500;
            color: var(--text-primary);
        }

        .station-header-block {
            margin-bottom: 18px;
            text-align: left;
        }
        .station-title {
            font-size: 2.1em;
            font-weight: 700;
            margin-bottom: 6px;
            margin-top: 0;
        }
        .station-lines-row {
            display: flex;
            gap: 8px;
            margin: 10px 0 0 0;
            align-items: center;
            justify-content: flex-start;
        }
        .station-line-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: #fff;
            box-shadow: 0 1px 4px rgba(0,0,0,0.07);
            border: 1px solid #eee;
        }

        /* Mensaje de estaci√≥n cerrada */
        .closed-message {
            text-align: center;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .closed-message h5 {
            color: #666;
            margin-bottom: 10px;
        }
        
        .closed-message p {
            color: #555;
            margin-bottom: 8px;
        }
        
        .closed-message small {
            color: #888;
            font-style: italic;
        }

        /* Modal para imagen 3D */
        #model3dModal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            align-items: center;
            justify-content: center;
        }

        .model3d-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            margin: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .model3d-modal-img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .model3d-modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: #fff;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10000;
        }

        .model3d-modal-close:hover {
            color: #ccc;
        }

        .model3d-modal-title {
            color: #fff;
            text-align: center;
            margin-top: 15px;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* Cursor pointer para imagen 3D clickeable */
        .model-3d-image {
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .model-3d-image:hover {
            transform: scale(1.02);
        }

    </style>
</head>
<body>
    <div class="main-content">
        <div id="searchHeaderBlock">
            <div class="page-header">
                <h1>
                    <img src="/static/logos/MetroMadridLogo_10.svg" alt="Metro de Madrid" class="header-icon">
                    Informaci√≥n de Estaci√≥n
                </h1>
                <p>Consulta datos en tiempo real de cualquier estaci√≥n del Metro de Madrid</p>
            </div>

            <!-- Secci√≥n de b√∫squeda -->
            <div class="search-section">
                <div class="search-container-centered">
                    <h2 class="search-title">Buscar Estaci√≥n</h2>
                    <form class="search-form-centered" id="stationSearchForm" onsubmit="return goToStation(event)">
                        <div class="search-input-container">
                            <input type="text" id="stationSearchInput" name="station" placeholder="Busca una estaci√≥n..." autocomplete="off" required>
                            <div class="autocomplete-results" id="autocompleteResults"></div>
                        </div>
                        <button class="search-btn-rocket" type="submit">üöÄ</button>
                    </form>
                    <p class="search-tips">
                        üí° Ejemplos: "Sol", "Callao", "Gran V√≠a", "Alonso Mart√≠nez"<br>
                        ‚ö° Al hacer clic en "Cargar" se ejecutar√° el scraper para obtener datos actualizados
                    </p>
                </div>
            </div>
        </div>
        <button id="showSearchBtn" style="position: fixed; top: 100px; right: 30px; z-index: 2000; font-size: 2em; background: #fff; border: 2px solid #1976d2; border-radius: 50%; box-shadow: 0 2px 8px #0002; cursor: pointer; width: 56px; height: 56px; align-items: center; justify-content: center; color: #1976d2;">üîç</button>

        <!-- Informaci√≥n de la estaci√≥n -->
        <div id="stationInfo" style="display: none;">
            <div class="station-header-block">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <h2 class="station-title">Cargando...</h2>
                    <button id="favoriteStationBtn" class="favorite-btn" onclick="toggleFavoriteStation()" title="A√±adir a favoritos" style="display: none;">
                        ‚≠ê
                    </button>
                </div>
                <div class="station-lines-row">
                    <!-- Los iconos de l√≠neas se cargar√°n por JavaScript -->
                </div>
            </div>
            
            <!-- Selector de l√≠nea y tira de paradas cercanas -->
            <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 24px;">
                <div id="paradasCercanasContainer"></div>
            </div>
            
            <!-- Contenedor para pr√≥ximos trenes -->
            <div id="modernTrainsContainer">
                <!-- Los trenes se cargar√°n aqu√≠ -->
            </div>
            
        </div>

        <!-- Imagen 3D y Estado de Escaleras/Ascensores -->
        <div class="station-3d-section" id="model3dSection" style="display: grid;">
            <div class="model-3d-column">
                <img id="model3dImage" class="model-3d-image" src="/static/model_3D/linea_1/alto_del_arenal.png" alt="Modelo 3D estaci√≥n" loading="lazy" />
                <div class="model-3d-caption">Vista 2D del modelo 3D de la estaci√≥n</div>
            </div>
            <div class="status-column">
                <div class="elevators-status-card">
                    <h4>üõó Estado de Escaleras y Ascensores</h4>
                    <div id="elevatorsStatus">
                        <div class="elevator-status-item">
                            <span class="status-label">Ascensores:</span>
                            <span class="status-indicator">
                                <span class="status-dot" id="elevatorDot"></span>
                                <span class="status-text" id="elevatorText">Cargando...</span>
                            </span>
                        </div>
                        <div class="elevator-status-item">
                            <span class="status-label">Escaleras:</span>
                            <span class="status-indicator">
                                <span class="status-dot" id="escalatorDot"></span>
                                <span class="status-text" id="escalatorText">Cargando...</span>
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="last-update-card">
                    <h4>üïí √öltima Actualizaci√≥n</h4>
                    <div id="lastUpdate">
                        <div class="update-time" id="lastUpdateTime">Cargando...</div>
                        <div class="update-source" id="updateSource">Base de datos</div>
                        <div class="update-realtime" id="updateRealtime" style="display: none;">
                            <span class="realtime-indicator">‚ö°</span>
                            <span class="realtime-text">Tiempo real</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Informaci√≥n detallada -->
        <div class="detailed-info" id="detailedInfo">
            <div class="info-card services-card">
                <h5>üõ†Ô∏è Servicios Disponibles</h5>
                <div id="servicesContent"></div>
            </div>

            <div class="info-card accesses-card">
                <h5>üö™ Accesos</h5>
                <div id="accessesContent"></div>
            </div>

            <div class="info-card connections-card">
                <h5>üîó Conexiones</h5>
                <div id="connectionsContent"></div>
            </div>
        </div>

        <!-- L√≠neas -->
        <div class="lines-section">
            <h4>L√≠neas que pasan por esta estaci√≥n</h4>
            <div class="lines-grid" id="linesGrid"></div>
        </div>

        
    </div>

    <div class="footer">
        <p>¬© 2025 Metro de Madrid - Sistema de Informaci√≥n de Estaciones</p>
        <p>Datos actualizados en tiempo real</p>
    </div>
</div>

<!-- Script del sistema moderno de trenes -->
<script src="/static/js/modern-trains.js"></script>

<script>
    // Variables globales
    let currentStationName = '';
    let currentStationId = '';
    let currentStationLines = [];

    // Configuraci√≥n de l√≠neas
    const LINE_COLORS = {
        '1': '#00AEEF', '2': '#FF0000', '3': '#FFDF00', '4': '#824100',
        '5': '#339900', '6': '#999999', '7': '#FF6600', '8': '#FF69B4',
        '9': '#990066', '10': '#000099', '11': '#006600', '12': '#999933',
        'Ramal': '#FF0000'
    };

    const LINE_LOGOS = {
        '1': '/static/logos/lineas/linea-1.svg',
        '2': '/static/logos/lineas/linea-2.svg',
        '3': '/static/logos/lineas/linea-3.svg',
        '4': '/static/logos/lineas/linea-4.svg',
        '5': '/static/logos/lineas/linea-5.svg',
        '6': '/static/logos/lineas/linea-6-circular.svg',
        '7': '/static/logos/lineas/linea-7.svg',
        '8': '/static/logos/lineas/linea-8.svg',
        '9': '/static/logos/lineas/linea-9.svg',
        '10': '/static/logos/lineas/linea-10.svg',
        '11': '/static/logos/lineas/linea-11.svg',
        '12': '/static/logos/lineas/linea-12-metrosur.svg',
        'Ramal': '/static/logos/lineas/ramal.svg'
    };

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Script de station.html cargado');
        try {
            initializeEventListeners();
            console.log('‚úÖ Event listeners inicializados correctamente');
        } catch (error) {
            console.error('‚ùå Error inicializando event listeners:', error);
        }
    });

    // Inicializar event listeners
    function initializeEventListeners() {
        console.log('üîß Inicializando event listeners...');
        
        const searchForm = document.getElementById('stationSearchForm');
        const searchInput = document.getElementById('stationSearchInput');

        console.log('üìù Search form encontrado:', !!searchForm);
        console.log('üîç Search input encontrado:', !!searchInput);

        if (searchForm) {
            searchForm.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('üì§ Formulario enviado');
                goToStation(e);
            });
        }

        if (searchInput) {
            searchInput.addEventListener('input', function() {
                console.log('‚å®Ô∏è Input detectado');
                handleSearchInput();
            });
            searchInput.addEventListener('keydown', function(e) {
                console.log('‚å®Ô∏è Keydown detectado:', e.key);
                handleSearchKeydown(e);
            });
            searchInput.addEventListener('focus', function() {
                console.log('üéØ Focus detectado');
                handleSearchFocus();
            });
        }

        // Cerrar autocompletado al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-input-container')) {
                hideAutocomplete();
            }
        });
        
        console.log('‚úÖ Event listeners configurados');
    }

    // Variables para autocompletado
    let autocompleteTimeout;
    let selectedIndex = -1;
    let autocompleteData = [];

    // Manejar input de b√∫squeda
    function handleSearchInput() {
        console.log('üîç handleSearchInput ejecutado');
        const searchInput = document.getElementById('stationSearchInput');
        const query = searchInput.value.trim();
        
        console.log('üìù Query actual:', query);
        
            clearTimeout(autocompleteTimeout);
        
        if (query.length < 2) {
            console.log('‚ùå Query muy corta, ocultando autocompletado');
            hideAutocomplete();
            return;
        }
        
        console.log('‚è∞ Configurando timeout para b√∫squeda');
        autocompleteTimeout = setTimeout(() => {
            console.log('üîç Ejecutando b√∫squeda de estaciones');
            searchStations(query);
        }, 300);
    }

    // Manejar teclas en el input
    function handleSearchKeydown(e) {
        console.log('‚å®Ô∏è handleSearchKeydown ejecutado, tecla:', e.key);
        const results = document.querySelectorAll('.autocomplete-item');
        
        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                selectedIndex = Math.min(selectedIndex + 1, results.length - 1);
                updateSelection(results);
                break;
            case 'ArrowUp':
                e.preventDefault();
                selectedIndex = Math.max(selectedIndex - 1, -1);
                updateSelection(results);
                break;
            case 'Enter':
                e.preventDefault();
                if (selectedIndex >= 0 && autocompleteData[selectedIndex]) {
                    console.log('‚úÖ Seleccionando estaci√≥n del autocompletado');
                    selectStation(autocompleteData[selectedIndex]);
                } else {
                    console.log('üîç Buscando estaci√≥n manualmente');
                    goToStation(e);
                }
                break;
            case 'Escape':
                hideAutocomplete();
                break;
        }
    }

    // Manejar focus en el input
    function handleSearchFocus() {
        console.log('üéØ handleSearchFocus ejecutado');
        const searchInput = document.getElementById('stationSearchInput');
        const query = searchInput.value.trim();
        
        if (query.length >= 2) {
            console.log('üîç Query v√°lida en focus, buscando estaciones');
            searchStations(query);
        }
    }

    // Buscar estaciones para autocompletado
    async function searchStations(query) {
        console.log('üîç searchStations ejecutado con query:', query);
        try {
            const url = `/api/station/search?q=${encodeURIComponent(query)}`;
            console.log('üåê Haciendo petici√≥n a:', url);
            
            const response = await fetch(url);
            console.log('üì° Respuesta recibida:', response.status);
            
            const data = await response.json();
            console.log('üìä Datos recibidos:', data);
            
            autocompleteData = data.slice(0, 10); // Limitar a 10 resultados
            console.log('üìã Datos de autocompletado:', autocompleteData);
            
            showAutocomplete(autocompleteData);
        } catch (error) {
            console.error('‚ùå Error buscando estaciones:', error);
            hideAutocomplete();
        }
    }

    // Mostrar autocompletado
    function showAutocomplete(stations) {
        const autocompleteResults = document.getElementById('autocompleteResults');
        if (!autocompleteResults) return;
        if (!stations || stations.length === 0) {
            hideAutocomplete();
            return;
        }
        // Agrupar por nombre de estaci√≥n
        const estacionesPorNombre = {};
        stations.forEach(station => {
            const nombre = station.nombre || 'Sin nombre';
            if (!estacionesPorNombre[nombre]) {
                estacionesPorNombre[nombre] = [];
            }
            estacionesPorNombre[nombre].push(station);
        });
        let html = '';
        Object.keys(estacionesPorNombre).forEach(nombreEstacion => {
            const estaciones = estacionesPorNombre[nombreEstacion];
            // Para el autocompletado, usa la primera l√≠nea por defecto
            const id_fijo = estaciones[0].id_fijo;
            const linea = estaciones[0].linea;
            // Logos de l√≠neas
            let logos = '';
            estaciones.forEach(station => {
                const lineLogo = LINE_LOGOS[station.linea] || '/static/logos/lineas/_ml.svg';
                logos += `<img src="${lineLogo}" alt="L√≠nea ${station.linea}" title="L√≠nea ${station.linea}" style="width: 26px; height: 26px; margin-right: 6px; vertical-align: middle;">`;
            });
            html += `
                <div class="autocomplete-item" data-nombre='${nombreEstacion}' data-id_fijo='${id_fijo}' data-linea='${linea}'>
                    <div class="autocomplete-multilogo">${logos}</div>
                    <div class="autocomplete-info">
                        <div class="autocomplete-name">${nombreEstacion}</div>
                        <div class="autocomplete-details">ID: ${id_fijo}</div>
                    </div>
                </div>
            `;
        });
        autocompleteResults.innerHTML = html;
        autocompleteResults.style.display = 'block';
        selectedIndex = -1;
        // A√±adir event listeners a los elementos del autocompletado
        const autocompleteItems = autocompleteResults.querySelectorAll('.autocomplete-item');
        autocompleteItems.forEach((item, index) => {
            item.addEventListener('click', function() {
                const id_fijo = this.getAttribute('data-id_fijo');
                const linea = this.getAttribute('data-linea');
                window.location.href = `/station/${linea}/${id_fijo}`;
            });
            item.addEventListener('mouseenter', function() {
                selectedIndex = index;
                updateSelection(autocompleteItems);
            });
        });
    }

    // Ocultar autocompletado
    function hideAutocomplete() {
        const autocompleteResults = document.getElementById('autocompleteResults');
        if (autocompleteResults) {
            autocompleteResults.style.display = 'none';
        }
        selectedIndex = -1;
    }

    // Actualizar selecci√≥n en autocompletado
    function updateSelection(items) {
        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        });
    }

    // Seleccionar estaci√≥n por nombre y l√≠neas
    function selectStationByName(nombre, id_fijo, lineas) {
        currentStationName = nombre;
        currentStationId = id_fijo;
        currentStationLines = lineas;
        const searchInput = document.getElementById('stationSearchInput');
        searchInput.value = nombre;
        hideAutocomplete();
        const stationInfo = document.getElementById('stationInfo');
        if (stationInfo) {
            stationInfo.style.display = 'block';
        }
        // Actualizar nombre de estaci√≥n
        const stationNameElement = document.getElementById('stationName');
        if (stationNameElement) {
            stationNameElement.textContent = nombre;
        }
        // Actualizar ID de estaci√≥n
        const stationIdElement = document.getElementById('stationId');
        if (stationIdElement) {
            stationIdElement.textContent = `ID: ${id_fijo}`;
        }
        // Actualizar logos de l√≠neas
        const linesGrid = document.getElementById('linesGrid');
        if (linesGrid) {
            let logos = '';
            lineas.forEach(linea => {
                const lineLogo = LINE_LOGOS[linea] || '/static/logos/lineas/_ml.svg';
                logos += `<img src="${lineLogo}" alt="L√≠nea ${linea}" title="L√≠nea ${linea}" style="width: 36px; height: 36px; margin-right: 10px;">`;
            });
            linesGrid.innerHTML = logos;
        }
        
        // Actualizar datos para favoritos (usando primera l√≠nea si hay varias)
        const primeraLinea = lineas && lineas.length > 0 ? String(lineas[0]) : '1';
        updateCurrentStationData(nombre, id_fijo, primeraLinea);
        
        // Cargar accesos desde GTFS
        loadAccessesFromGTFS(nombre);
        // Cargar conexiones
        loadConnections(nombre);
        // Cargar estado de ascensores
        loadElevatorsStatus(nombre);
        // Cargar datos de la estaci√≥n
        searchStationWithNinjaScrap(nombre);
        // Cargar imagen 3D
        showModel3D(lineas, nombre);
        
        // Cargar pr√≥ximos trenes usando el nombre de la estaci√≥n
        loadModernTrains(nombre, 'modernTrainsContainer');
    }

    // Funci√≥n para cargar accesos desde GTFS
    function loadAccessesFromGTFS(stationName) {
        const accessesContent = document.getElementById('accessesContent');
        const servicesContent = document.getElementById('servicesContent');
        if (!accessesContent) return;
        
        // Mostrar indicador de carga
        accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde GTFS...</div>';
        if (servicesContent) {
            servicesContent.innerHTML = '<div class="loading">üîÑ Cargando servicios...</div>';
        }
        
        fetch(`/api/station/accesses/gtfs/${encodeURIComponent(stationName)}`)
            .then(res => res.json())
            .then(data => {
            if (data.error) {
                    console.error('Error cargando accesos GTFS:', data.error);
                    accessesContent.innerHTML = '<div class="no-data">No se pudieron cargar los accesos.</div>';
                    if (servicesContent) {
                        servicesContent.innerHTML = '<div class="no-data">No se pudieron cargar los servicios.</div>';
                    }
                return;
            }
            
                if (!data.accesos || data.accesos.length === 0) {
                    accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles para esta estaci√≥n.</div>';
                } else {
                    // Crear tabla de accesos
                    let html = `<div class="line-data-header"> ${data.estacion.nombre} <span style='font-size:0.9em; color:#888;'>ID: ${data.estacion.id_fijo || data.estacion.id || ''}</span></div>`;            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
            html += '</tr></thead><tbody>';
            
                    data.accesos.forEach(acceso => {
                    html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;"><strong>${acceso.vestibulo || 'No especificado'}</strong></td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre || acceso.nombre_acceso || 'No especificado'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                    html += '</tr>';
            });
            
            html += '</tbody></table>';
                    html += `<div style="margin-top: 10px; font-size: 12px; color: #666;">Total: ${data.accesos.length} accesos | √öltima actualizaci√≥n: ${new Date().toLocaleString('es-ES')}</div>`;
                    
                    accessesContent.innerHTML = html;
                    console.log(`‚úÖ Accesos GTFS cargados: ${data.accesos.length} accesos`);
                }
                
                // Mostrar servicios si est√°n disponibles
                if (servicesContent && data.servicios && data.servicios.length > 0) {
                    let servicesHtml = `<div class="line-data-header" ${data.estacion.nombre}</div>`;
                    servicesHtml += '<div class="services-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px;">';
                    
                    data.servicios.forEach(servicio => {
                        servicesHtml += `<span style="background: #e3f2fd; color: #1976d2; padding: 6px 12px; border-radius: 20px; font-size: 0.9em; border: 1px solid #bbdefb;">${servicio}</span>`;
                    });
                    
                    servicesHtml += '</div>';
                    servicesHtml += `<div style="margin-top: 10px; font-size: 12px; color: #666;">Total: ${data.servicios.length} servicios</div>`;
                    
                    servicesContent.innerHTML = servicesHtml;
                    console.log(`‚úÖ Servicios cargados: ${data.servicios.length} servicios`);
                } else if (servicesContent) {
                    servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles para esta estaci√≥n.</div>';
                }
            })
            .catch(error => {
                console.error('Error cargando accesos GTFS:', error);
                accessesContent.innerHTML = '<div class="no-data">Error cargando accesos desde GTFS.</div>';
                if (servicesContent) {
                    servicesContent.innerHTML = '<div class="no-data">Error cargando servicios.</div>';
                }
            });
    }

    // Funci√≥n para cargar conexiones
    function loadConnections(stationName) {
        const connectionsContent = document.getElementById('connectionsContent');
        if (!connectionsContent) return;
        
        // Mostrar indicador de carga
        connectionsContent.innerHTML = '<div class="loading">üîÑ Cargando conexiones...</div>';
        
        fetch(`/api/station/connections/${encodeURIComponent(stationName)}`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    console.error('Error cargando conexiones:', data.error);
                    connectionsContent.innerHTML = '<div class="no-data">No se pudieron cargar las conexiones.</div>';
            return;
        }
        
                if (!data.conexiones || data.conexiones.length === 0) {
                    connectionsContent.innerHTML = '<div class="no-data">No hay conexiones disponibles para esta estaci√≥n.</div>';
                    return;
                }
                
                // Crear lista de conexiones
                let html = `<div class="line-data-header">üîó Conexiones - ${data.estacion.nombre}</div>`;
                html += '<div class="connections-list">';
                
                data.conexiones.forEach(conexion => {
                    const linea = conexion.linea || conexion;
                    let displayText = '';
                    let lineLogo = '/static/logos/lineas/_ml.svg'; // Logo por defecto
                    
                    // Determinar el texto y logo seg√∫n el tipo de conexi√≥n
                    if (typeof linea === 'string') {
                        const lineaLower = linea.toLowerCase();
                        
                        if (lineaLower.includes('renfe') || lineaLower.includes('cercan√≠as') || lineaLower.includes('cercanias')) {
                            displayText = 'Cercan√≠as Renfe';
                            lineLogo = '/static/logos/cercanias-renfe.svg';
                        } else if (lineaLower.includes('intercambiador') || lineaLower.includes('interurbanos')) {
                            displayText = 'Autobuses Interurbanos';
                            lineLogo = '/static/logos/autobuses-interurbanos.svg';
                        } else if (lineaLower.includes('largo recorrido') || lineaLower.includes('largo-recorrido')) {
                            displayText = 'Autobuses Largo Recorrido';
                            lineLogo = '/static/logos/autobuses-de-largo-recorrido.svg';
                        } else if (lineaLower.includes('aeropuerto') || lineaLower.includes('expres')) {
                            displayText = 'Autob√∫s Expres Aeropuerto';
                            lineLogo = '/static/logos/autobus-expres-aeropuerto.svg';
                        } else if (lineaLower.includes('tren') || lineaLower.includes('estaci√≥n de tren')) {
                            displayText = 'Estaci√≥n de Tren';
                            lineLogo = '/static/logos/estacion-de-tren.svg';
                        } else if (lineaLower.includes('ml')) {
                            // Metro Ligero
                            const numero = linea.match(/\d+/);
                            if (numero) {
                                displayText = `Metro Ligero ${numero[0]}`;
                                lineLogo = `/static/logos/lineas/ml${numero[0]}.svg`;
                            } else {
                                displayText = 'Metro Ligero';
                                lineLogo = '/static/logos/lineas/_ml.svg';
                            }
                        } else if (lineaLower.includes('ramal') || lineaLower === 'r') {
                            displayText = 'Ramal';
                            lineLogo = '/static/logos/lineas/ramal.svg';
                        } else if (/^\d+$/.test(linea)) {
                            // Si es solo un n√∫mero, es una l√≠nea de metro
                            displayText = `L√≠nea ${linea}`;
                            lineLogo = `/static/logos/lineas/linea-${linea}.svg`;
                        } else if (lineaLower.includes('l√≠nea') || lineaLower.includes('linea')) {
                            // Extraer n√∫mero de l√≠nea
                            const numero = linea.match(/\d+/);
                            if (numero) {
                                displayText = `L√≠nea ${numero[0]}`;
                                lineLogo = `/static/logos/lineas/linea-${numero[0]}.svg`;
                            } else {
                                displayText = linea;
                            }
                        } else {
                            displayText = linea;
                        }
                    } else if (typeof linea === 'number') {
                        displayText = `L√≠nea ${linea}`;
                        lineLogo = `/static/logos/lineas/linea-${linea}.svg`;
                    } else {
                        displayText = String(linea);
                    }
                    
                    html += `
                        <div class="connection-item">
                            <img src="${lineLogo}" alt="${displayText}" class="connection-logo">
                            <span class="connection-text">${displayText}</span>
                        </div>
                    `;
                });
                
                html += '</div>';
                html += `<div style="margin-top: 10px; font-size: 12px; color: #666;">Total: ${data.conexiones.length} conexiones</div>`;
                
                connectionsContent.innerHTML = html;
                console.log(`‚úÖ Conexiones cargadas: ${data.conexiones.length} conexiones`);
            })
            .catch(error => {
                console.error('Error cargando conexiones:', error);
                connectionsContent.innerHTML = '<div class="no-data">Error cargando conexiones.</div>';
            });
    }

    // Funci√≥n para buscar estaci√≥n
    function goToStation(event) {
        event.preventDefault();
        const input = document.getElementById('stationSearchInput');
        const query = input.value.trim();
        
        if (!query) return false;
        
        // Buscar la estaci√≥n para obtener el ID
        fetch(`/api/station/search?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                if (data && data.length > 0) {
                    // Usar la primera coincidencia
                    const estacion = data[0];
                    window.location.href = `/station/${estacion.id_fijo}`;
                } else {
                    // Si no encuentra coincidencias, mostrar error
                    console.log('No se encontr√≥ la estaci√≥n. Intenta con otro nombre.');
                }
            })
            .catch(error => {
                console.error('Error buscando estaci√≥n:', error);
                console.log('Error al buscar la estaci√≥n. Int√©ntalo de nuevo.');
            });
        
        return false;
    }

    // Funci√≥n para buscar estaci√≥n con NinjaScrap
    async function searchStationWithNinjaScrap(stationName) {
        if (!stationName) return;
        
        try {
            const response = await fetch(`/api/station/ninjascrap/${encodeURIComponent(stationName)}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            displayRealtimeData(data);
            loadIntelligentData(stationName);
            
        } catch (error) {
            console.error('Error en searchStationWithNinjaScrap:', error);
            console.log('Error al obtener datos de la estaci√≥n. Int√©ntalo de nuevo.');
        }
    }

    // Funci√≥n para mostrar datos en tiempo real del scraper Ninja
    function displayRealtimeData(data) {
        console.log('üìä Datos en tiempo real recibidos del scraper Ninja:', data);
        
        // Actualizar estado de ascensores si est√° disponible
        if (data.estado_ascensores && data.estado_escaleras) {
            console.log(`üõó Estado ascensores: ${data.estado_ascensores}`);
            console.log(`üõó Estado escaleras: ${data.estado_escaleras}`);
            
            // Actualizar los indicadores de estado
            showElevatorStatus(
                data.estado_ascensores === 'Operativo' ? 'operativo' : 'no-operativo',
                data.estado_ascensores === 'Operativo' ? 'operativo' : 'no-operativo',
                data.estado_ascensores
            );
            
            showEscalatorStatus(
                data.estado_escaleras === 'Operativo' ? 'operativo' : 'no-operativo',
                data.estado_escaleras === 'Operativo' ? 'operativo' : 'no-operativo',
                data.estado_escaleras
            );
        }
        
        // Actualizar √∫ltima actualizaci√≥n si est√° disponible
        if (data.last_update) {
            console.log(`üïê √öltima actualizaci√≥n: ${data.last_update}`);
            const lastUpdateElement = document.getElementById('lastUpdateTime');
            if (lastUpdateElement) {
                lastUpdateElement.textContent = data.last_update;
            }
            
            const updateSourceElement = document.getElementById('updateSource');
            if (updateSourceElement) {
                updateSourceElement.textContent = 'Tiempo real (NinjaScrap)';
            }
        }
        
        // Mostrar pr√≥ximos trenes si est√°n disponibles
        if (data.proximos_trenes_html) {
            console.log(`üöÑ Pr√≥ximos trenes HTML recibido: ${data.proximos_trenes_html.length} caracteres`);
            // NO cargar aqu√≠ para evitar conflictos - ya se carga en el bloque principal
        }
        
        // Mostrar informaci√≥n adicional
        console.log(`üìã Estaci√≥n: ${data.station_name}`);
        console.log(`üöá L√≠nea: ${data.linea}`);
        console.log(`üîó URL: ${data.station_url}`);
        console.log(`‚è∞ Timestamp: ${data.timestamp_scraping}`);
    }

    // Funci√≥n para cargar datos inteligentes
    function loadIntelligentData(stationName) {
        console.log('Cargando datos inteligentes para:', stationName);
        // Aqu√≠ puedes a√±adir la l√≥gica para cargar datos adicionales
    }

    // Funci√≥n para actualizar los datos de trenes
    function refreshTrainsData() {
        const refreshBtn = document.getElementById('refreshTrainsBtn');
        const lastUpdateTime = document.getElementById('lastUpdateTime');
        
        // Obtener el nombre de la estaci√≥n del input de b√∫squeda
        const searchInput = document.getElementById('stationSearchInput');
        const stationName = searchInput ? searchInput.value.trim() : '';
        
        if (!stationName) {
            console.warn('‚ùå No hay estaci√≥n seleccionada para actualizar');
            console.log('Por favor, selecciona una estaci√≥n primero');
            return;
        }
        
        // Mostrar estado de carga en el icono del header
        const refreshIcon = document.querySelector('.refresh-icon');
        if (refreshIcon) {
            refreshIcon.textContent = '‚è≥';
            refreshIcon.style.opacity = '0.5';
            refreshIcon.style.pointerEvents = 'none';
        }
        
        // Mostrar estado de carga en el bot√≥n principal si existe
        if (refreshBtn) {
            refreshBtn.classList.add('loading');
            refreshBtn.textContent = 'üîÑ Actualizando...';
            refreshBtn.disabled = true;
        }
        
        console.log(`üîÑ Actualizando trenes para: ${stationName}`);
        
        // Actualizar los trenes usando la funci√≥n correcta
        loadModernTrains(stationName, 'modernTrainsContainer');
    }

    // Mostrar imagen 3D
    function showModel3D(lineas, nombreEstacion) {
        console.log(`üéØ showModel3D llamada con:`, { lineas, nombreEstacion });
        
        const model3dSection = document.getElementById('model3dSection');
        const model3dImage = document.getElementById('model3dImage');
        
        console.log(`üîç Elementos DOM encontrados:`, { 
            model3dSection: !!model3dSection, 
            model3dImage: !!model3dImage 
        });
        
        if (!model3dSection || !model3dImage) {
            console.error(`‚ùå No se encontraron elementos DOM para imagen 3D`);
            return;
        }
        
        // Si no hay l√≠neas, ocultar la secci√≥n
        if (!lineas || lineas.length === 0) {
            console.warn(`‚ö†Ô∏è No hay l√≠neas para mostrar imagen 3D`);
            model3dSection.style.display = 'none';
            return;
        }
        
        const nombreArchivo = nombreEstacion.toLowerCase()
            .replace(/ /g, '_')
            .replace(/-/g, '')  // Eliminar guiones
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '');
        
        console.log(`üìù Transformaci√≥n de nombre: "${nombreEstacion}" ‚Üí "${nombreArchivo}"`);
        
        // Usar la primera l√≠nea para determinar la carpeta
        const primeraLinea = lineas[0];
        let carpetaLinea = `linea_${primeraLinea}`;
        
        // Casos especiales para algunas l√≠neas
        if (primeraLinea.toLowerCase() === 'ramal') {
            carpetaLinea = 'linea_Ramal';
        }
        
        console.log(`üìÇ Carpeta de l√≠nea: "${carpetaLinea}" (l√≠nea: ${primeraLinea})`);
        
        // Construir la ruta local
        let imgPath = `/static/model_3D/${carpetaLinea}/${nombreArchivo}.png`;
        
        // Casos especiales para ciertas estaciones
        if (nombreArchivo === "sol") {
            imgPath = `/static/model_3D/${carpetaLinea}/sol.png`;
        }
        
        console.log(`üñºÔ∏è Ruta final de imagen: ${imgPath}`);
        
        // Cargar imagen con manejo de errores
        model3dImage.onerror = function() {
            console.warn(`‚ùå No se pudo cargar la imagen 3D local: ${imgPath}`);
            // Intentar con la URL externa como fallback
            const fallbackPath = `http://estacions.albertguillaumes.cat/img/madrid/${nombreArchivo}.png`;
            console.log(`üîÑ Intentando con fallback externo: ${fallbackPath}`);
            model3dImage.src = fallbackPath;
            model3dImage.onerror = function() {
                console.error(`‚ùå Fallback externo tambi√©n fall√≥, ocultando secci√≥n 3D`);
                model3dSection.style.display = 'none';
            };
        };
        
        model3dImage.onload = function() {
            console.log(`‚úÖ Imagen 3D cargada correctamente: ${imgPath}`);
            model3dImage.style.display = 'block';
            model3dSection.style.display = 'grid';
        };
        
        // Cargar imagen
        model3dImage.src = imgPath;
        
        // Click para ampliar
        model3dImage.onclick = function() {
            showModalImage(imgPath, `Modelo 3D - ${nombreEstacion}`);
        };
        
        console.log(`üèóÔ∏è Iniciando carga de imagen 3D: ${imgPath}`);
    }

    // Modal para imagen 3D
    function showModalImage(imgPath, caption) {
        let modal = document.getElementById('model3dModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'model3dModal';
            modal.innerHTML = `
                <div class="model3d-modal-content">
                    <span class="model3d-modal-close" id="closeModel3dModal">&times;</span>
                    <img src="${imgPath}" alt="${caption}" class="model3d-modal-img">
                    <div class="model3d-modal-title">${caption}</div>
                </div>
            `;
            document.body.appendChild(modal);
            } else {
            modal.querySelector('img').src = imgPath;
            modal.querySelector('.model3d-modal-title').textContent = caption;
            modal.style.display = 'flex';
        }
        modal.style.display = 'flex';
        document.getElementById('closeModel3dModal').onclick = function() {
            modal.style.display = 'none';
        };
        modal.onclick = function(e) {
            if (e.target === modal) modal.style.display = 'none';
        };
    }

    // Funci√≥n para cargar estado de ascensores
    function loadElevatorsStatus(stationName) {
        const elevatorsSection = document.getElementById('elevatorsStatusSection');
        if (!elevatorsSection) return;
        
        // Mostrar la secci√≥n
        elevatorsSection.style.display = 'block';
        
        // Mostrar indicador de carga
        document.getElementById('elevatorText').textContent = 'Cargando...';
        document.getElementById('escalatorText').textContent = 'Cargando...';
        document.getElementById('lastUpdateTime').textContent = 'Cargando...';
        document.getElementById('updateSource').textContent = 'Base de datos';
        document.getElementById('updateRealtime').style.display = 'none';
        
        fetch(`/api/station/elevators/${encodeURIComponent(stationName)}`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    console.error('Error cargando estado de ascensores:', data.error);
                    showElevatorStatus('error', 'error', 'Error al cargar datos');
                    showEscalatorStatus('error', 'error', 'Error al cargar datos');
                    document.getElementById('lastUpdateTime').textContent = 'Error';
                    document.getElementById('updateSource').textContent = 'Error';
                    return;
                }
                
                // Actualizar estado de ascensores
                const ascensores = data.ascensores;
                showElevatorStatus(
                    ascensores.operativo ? 'operativo' : 'no-operativo',
                    ascensores.operativo ? 'operativo' : 'no-operativo',
                    ascensores.estado
                );
                
                // Actualizar estado de escaleras
                showEscalatorStatus(
                    ascensores.escaleras_operativo ? 'operativo' : 'no-operativo',
                    ascensores.escaleras_operativo ? 'operativo' : 'no-operativo',
                    ascensores.escaleras
                );
                
                // Actualizar √∫ltima actualizaci√≥n
                document.getElementById('lastUpdateTime').textContent = data.ultima_actualizacion;
                document.getElementById('updateSource').textContent = data.fuente_datos;
                
                // Mostrar indicador de tiempo real si corresponde
                if (data.fuente_datos === 'Tiempo real') {
                    document.getElementById('updateRealtime').style.display = 'flex';
                } else {
                    document.getElementById('updateRealtime').style.display = 'none';
                }
                
                console.log(`‚úÖ Estado de ascensores cargado: ${ascensores.estado} (${data.fuente_datos})`);
            })
            .catch(error => {
                console.error('Error cargando estado de ascensores:', error);
                showElevatorStatus('desconocido', 'desconocido', 'No disponible');
                showEscalatorStatus('desconocido', 'desconocido', 'No disponible');
                document.getElementById('lastUpdateTime').textContent = 'Error';
                document.getElementById('updateSource').textContent = 'Error de conexi√≥n';
                document.getElementById('updateRealtime').style.display = 'none';
            });
    }

    // Funci√≥n para mostrar estado de ascensor
    function showElevatorStatus(dotClass, textClass, text) {
        const dot = document.getElementById('elevatorDot');
        const textElement = document.getElementById('elevatorText');
        
        // Limpiar clases anteriores
        dot.className = 'status-dot';
        textElement.className = 'status-text';
        
        // A√±adir nuevas clases
        dot.classList.add(dotClass);
        textElement.classList.add(textClass);
        textElement.textContent = text;
    }

    // Funci√≥n para mostrar estado de escaleras
    function showEscalatorStatus(dotClass, textClass, text) {
        const dot = document.getElementById('escalatorDot');
        const textElement = document.getElementById('escalatorText');
        
        // Limpiar clases anteriores
        dot.className = 'status-dot';
        textElement.className = 'status-text';
        
        // A√±adir nuevas clases
        dot.classList.add(dotClass);
        textElement.classList.add(textClass);
        textElement.textContent = text;
    }

    // Funci√≥n para extraer par√°metros de la URL
    function getStationParamsFromUrl() {
        // /station/NUMERO/ID o /station/Ramal/ID
        const match = window.location.pathname.match(/\/station\/(\d+|Ramal)\/(\d+)/);
        if (match) {
            return { lineNumber: match[1], stationId: match[2] };
        }
        // /station/id/ID
        const matchId = window.location.pathname.match(/\/station\/id\/(\d+)/);
        if (matchId) {
            return { stationId: matchId[1] };
        }
        return null;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const params = getStationParamsFromUrl();
        if (params && params.lineNumber && params.stationId) {
            // Usar una sola llamada a la API moderna que devuelve todos los datos
            fetch(`/api/station/${params.lineNumber}/${params.stationId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) return;
                    console.log('üìä Datos recibidos de la API de estaci√≥n:', data);
                    
                    const stationData = data.data.static;
                    
                    // 1. Renderizar tira de paradas y selector de l√≠nea
                    renderParadasCercanas(
                        data.data.paradas_cercanas,
                        stationData.line,
                        stationData.id_fijo,
                        data.data.lineas_disponibles
                    );
                    
                    // 2. Mostrar info principal de la estaci√≥n
                    const stationTitle = document.querySelector('.station-title');
                    if (stationTitle) stationTitle.textContent = stationData.name;
                    const stationInfo = document.getElementById('stationInfo');
                    if (stationInfo) stationInfo.style.display = 'block';
                    
                    // 3. Cargar servicios y accesos usando los datos correctos de la l√≠nea
                    loadAccessesFromAPI(stationData);
                    loadConnections(stationData.id_fijo);  // Usar ID en lugar de nombre
                    loadElevatorsStatus(stationData.id_fijo);  // Usar ID en lugar de nombre
                    searchStationWithNinjaScrap(stationData.name);
                    showModel3D([String(stationData.line)], stationData.name);
                    
                    // 4. Establecer el nombre en el input para que loadModernTrains lo encuentre
                    const searchInput = document.getElementById('stationSearchInput');
                    if (searchInput) {
                        searchInput.value = stationData.name;
                    }
                    
                    // 5. Actualizar datos para favoritos
                    updateCurrentStationData(stationData.name, stationData.id_fijo, String(stationData.line));
                    
                    console.log('üöÑ Cargando trenes con:', { nombre: stationData.name, stationId: params.stationId });
                    loadModernTrains(stationData.name, 'modernTrainsContainer');
                });
        } else if (params && params.stationId) {
            // Solo la API antigua (como antes)
            fetch(`/api/station/detailed/${params.stationId}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) return;
                    const stationTitle = document.querySelector('.station-title');
                    if (stationTitle) stationTitle.textContent = data.nombre;
                    const stationInfo = document.getElementById('stationInfo');
                    if (stationInfo) stationInfo.style.display = 'block';
                    loadAccessesFromGTFS(data.nombre);
                    loadConnections(data.nombre);
                    loadElevatorsStatus(data.nombre);
                    searchStationWithNinjaScrap(data.nombre);
                    showModel3D([String(data.linea)], data.nombre);
                    
                    // Actualizar datos para favoritos
                    updateCurrentStationData(data.nombre, data.id_fijo || params.stationId, String(data.linea));
                    
                    if (data.id_modal) {
                        loadModernTrains(data.id_modal, 'modernTrainsContainer');
                    } else if (data.nombre) {
                        loadModernTrains(data.nombre, 'modernTrainsContainer');
                    } else {
                        console.warn('No se pudo obtener nombre o id_modal, usando stationId como fallback:', params.stationId);
                        loadModernTrains(params.stationId, 'modernTrainsContainer');
                    }
                });
        }
    });

    // Funci√≥n para mostrar los datos de trenes crudos
    function displayRawTrainsData(data, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        console.log('üìä Datos recibidos en displayRawTrainsData:', data);
        
        // Verificar si tenemos datos de trenes
        if (!data.trains_data || !data.trains_data.lineas || data.trains_data.lineas.length === 0) {
            container.innerHTML = `
                <div class="no-trains-message">
                    <h4>üöÑ Pr√≥ximos Trenes</h4>
                    <p>No hay informaci√≥n disponible en este momento</p>
                    <small>√öltima actualizaci√≥n: ${new Date().toLocaleTimeString()}</small>
                </div>
            `;
            return;
        }
        
        let html = '<div class="modern-trains-container">';
        html += '<div class="trains-header">';
        html += '<h4>üöÑ Pr√≥ximos Trenes</h4>';
        html += '<div s class="trains-status">';
        html += `<span class="status-indicator online"></span>`;
        html += `<small>Actualizado: ${new Date().toLocaleTimeString()}</small>`;
        html += `<span class="refresh-icon" onclick="refreshTrainsData()" title="Actualizar trenes">               üîÑ</span>`;

        html += '</div>';
        html += '</div>';
        
        html += '<div class="trains-content">';
        
        // Mostrar cada l√≠nea - usar data.trains_data.lineas
        data.trains_data.lineas.forEach(linea => {
            html += '<div class="line-container">';
            html += `<div class="line-header" style="border-left: 4px solid ${linea.color}">`;
            html += `<img src="${linea.logo}" alt="L√≠nea ${linea.numero}" class="line-logo">`;
            html += `<span class="line-name">${linea.nombre}</span>`;
            html += '</div>';
            
            html += '<div class="directions-container">';
            linea.direcciones.forEach(direccion => {
                html += '<div class="direction">';
                html += `<div class="destination">${direccion.destino}</div>`;
                
                if (direccion.sin_prevision) {
                    html += '<div class="no-prediction">Sin previsi√≥n</div>';
                } else {
                    html += '<div class="times">';
                    direccion.tiempos.forEach((tiempo, index) => {
                        const isNext = index === 0;
                        html += `<span class="time ${isNext ? 'next' : ''}">${tiempo} min</span>`;
                    });
                    html += '</div>';
                }
                html += '</div>';
            });
            html += '</div>';
            html += '</div>';
        });
        
        html += '</div>'; // trains-content
        html += '</div>'; // modern-trains-container
        
        container.innerHTML = html;
    }

    // Al cargar la estaci√≥n, llamar a esta funci√≥n:
    function loadStation3D(stationName) {
        fetch(`/api/station/model3d/${encodeURIComponent(stationName)}`)
            .then(res => res.json())
            .then(data => {
                const section = document.getElementById('station3dSection');
                const img = document.getElementById('station3dImg');
                const link = document.getElementById('station3dLink');
                if (data && data.available && data.model_path) {
                    section.style.display = 'block';
                    img.src = data.download_url;
                    link.href = data.download_url;
                    img.alt = `Modelo 3D de ${stationName}`;
                } else {
                    section.style.display = 'none';
                }
            })
            .catch(() => {
                document.getElementById('station3dSection').style.display = 'none';
            });
    }

    function renderStationLines(stationData) {
        // L√≠nea principal
        let lines = [String(stationData.linea)];
        // A√±adir correspondencias si existen
        if (stationData.correspondencias && Array.isArray(stationData.correspondencias)) {
            stationData.correspondencias.forEach(l => {
                if (!lines.includes(String(l))) lines.push(String(l));
            });
        }
        // Generar HTML de iconos
        let html = '<div class="station-lines-row">';
        lines.forEach(linea => {
            let svgName = `linea-${linea}.svg`;
            if (linea === '6') svgName = 'linea-6-circular.svg';
            if (linea === '12') svgName = 'linea-12-metrosur.svg';
            if (linea.toLowerCase() === 'ramal') svgName = 'ramal.svg';
            html += `<img src="/static/logos/lineas/${svgName}" alt="L√≠nea ${linea}" class="station-line-icon">`;
        });
        html += '</div>';
        return html;
    }

    // Funci√≥n para cargar accesos directamente desde los datos de la API
    function loadAccessesFromAPI(stationData) {
        console.log('üö™ Cargando accesos desde API:', stationData);
        
        const accessesContainer = document.getElementById('accessesContent');
        const servicesContainer = document.getElementById('servicesContent');
        
        if (!accessesContainer) {
            console.warn('‚ùå No se encontr√≥ el contenedor de accesos');
            return;
        }
        
        // ===== CARGAR ACCESOS =====
        if (!stationData.vestibulos || stationData.vestibulos.length === 0) {
            accessesContainer.innerHTML = `
                <div class="no-data-message">
                    <span class="icon">üö™</span>
                    <p>No hay informaci√≥n de accesos disponible</p>
                </div>
            `;
        } else {
            // Procesar vest√≠bulos y nombres de acceso
            let html = `<div class="line-data-header">${stationData.name} - Accesos</div>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRES DE ACCESO</th>';
            html += '</tr></thead><tbody>';
            
            // Procesar vest√≠bulos
            if (stationData.vestibulos && stationData.vestibulos.length > 0) {
                stationData.vestibulos.forEach(vestibulo => {
                    const vestibulos = vestibulo.split(',');
                    vestibulos.forEach(v => {
                        const vestibulo_clean = v.trim();
                        // Obtener nombres de acceso correspondientes
                        let nombres_acceso = '';
                        if (stationData.nombres_acceso && stationData.nombres_acceso.length > 0) {
                            nombres_acceso = stationData.nombres_acceso[0].split(',').map(n => n.trim()).join(', ');
                        }
                        
                        html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;"><strong>${vestibulo_clean}</strong></td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${nombres_acceso}</td>`;
                        html += '</tr>';
                    });
                });
            }
            
            html += '</tbody></table>';
            html += `<div style="margin-top: 10px; font-size: 12px; color: #666;">√öltima actualizaci√≥n: ${new Date().toLocaleString('es-ES')}</div>`;
            
            accessesContainer.innerHTML = html;
            console.log('‚úÖ Accesos cargados desde vest√≠bulos y nombres_acceso');
        }
        
        // ===== CARGAR SERVICIOS =====
        if (servicesContainer) {
            if (!stationData.servicios_detallados || stationData.servicios_detallados.length === 0) {
                servicesContainer.innerHTML = `
                    <div class="no-data-message">
                        <span class="icon">üõ†Ô∏è</span>
                        <p>No hay servicios disponibles</p>
                    </div>
                `;
            } else {
                // Mapear servicios a emojis
                const serviceEmojis = {
                    'Ascensores': 'üõó',
                    'ascensores': 'üõó',
                    'Escaleras mec√°nicas': '‚¨ÜÔ∏è',
                    'escaleras mec√°nicas': '‚¨ÜÔ∏è',
                    'escaleras': '‚¨ÜÔ∏è',
                    'Cobertura m√≥vil': 'üì±',
                    'cobertura m√≥vil': 'üì±',
                    'm√≥vil': 'üì±',
                    'Desfibrilador': 'üíì',
                    'desfibrilador': 'üíì',
                    'Estaci√≥n accesible': '‚ôø',
                    'estaci√≥n accesible': '‚ôø',
                    'accesible': '‚ôø',
                    'Oficina de gesti√≥n TTP': 'üè¢',
                    'oficina': 'üè¢',
                    'TTP': 'üè¢',
                    'Quioscos ONCE': 'üóûÔ∏è',
                    'quioscos': 'üóûÔ∏è',
                    'ONCE': 'üóûÔ∏è',
                    'Bibliometro': 'üìö',
                    'bibliometro': 'üìö',
                    'Tiendas': 'üõçÔ∏è',
                    'tiendas': 'üõçÔ∏è',
                    'Aparcamiento': 'üÖøÔ∏è',
                    'aparcamiento': 'üÖøÔ∏è',
                    'parking': 'üÖøÔ∏è'
                };
                
                let servicesHtml = `<div class="line-data-header">${stationData.name} - Servicios</div>`;
                servicesHtml += '<div class="services-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px;">';
                
                stationData.servicios_detallados.forEach(servicio => {
                    // Buscar emoji correspondiente
                    let emoji = 'üõ†Ô∏è'; // emoji por defecto
                    const servicioLower = servicio.toLowerCase();
                    for (const [key, value] of Object.entries(serviceEmojis)) {
                        if (servicioLower.includes(key.toLowerCase())) {
                            emoji = value;
                            break;
                        }
                    }
                    
                    servicesHtml += `<span style="background: #e3f2fd; color: #1976d2; padding: 6px 12px; border-radius: 20px; font-size: 0.9em; border: 1px solid #bbdefb;">${emoji} ${servicio}</span>`;
                });
                
                servicesHtml += '</div>';
                servicesHtml += `<div style="margin-top: 10px; font-size: 12px; color: #666;">Total: ${stationData.servicios_detallados.length} servicios</div>`;
                
                servicesContainer.innerHTML = servicesHtml;
                console.log('‚úÖ Servicios cargados:', stationData.servicios_detallados.length);
            }
        }
    }

    // Funci√≥n para cargar trenes modernos
    function loadModernTrains(stationId, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        // Obtener el nombre de la estaci√≥n del input de b√∫squeda
        const searchInput = document.getElementById('stationSearchInput');
        const stationName = searchInput ? searchInput.value.trim() : '';
        
        // Si no hay nombre en el input, intentar usar el stationId directamente
        if (!stationName) {
            console.log('No hay nombre en el input, usando stationId directamente:', stationId);
            // Usar la funci√≥n que acepta ID directamente
            if (typeof updateModernTrainsById === 'function') {
                updateModernTrainsById(stationId, containerId);
            } else {
                console.error('No se pudo obtener el nombre de la estaci√≥n y updateModernTrainsById no est√° disponible');
                container.innerHTML = `
                    <div class="modern-trains-container">
                        <div class="trains-header">
                            <h4>üöÑ Pr√≥ximos Trenes</h4>
                            <div class="trains-status">
                                <span class="status-indicator error"></span>
                                <small>Error</small>
                            </div>
                        </div>
                        <div class="trains-content">
                            <div class="error-message">‚ùå No se pudo obtener el nombre de la estaci√≥n</div>
                        </div>
                    </div>
                `;
            }
            return;
        }
        
        // Mostrar indicador de carga
        container.innerHTML = `
            <div class="modern-trains-container">
                <div class="trains-header">
                    <h4>üöÑ Pr√≥ximos Trenes</h4>
                    <div class="trains-status">
                        <span class="status-indicator loading"></span>
                        <small>Cargando...</small>
                    </div>
                </div>
                <div class="trains-content">
                    <div class="loading-message">üîÑ Cargando pr√≥ximos trenes...</div>
                </div>
            </div>
        `;
        
        // Hacer fetch al endpoint
        fetch(`/api/station/raw-trains/${encodeURIComponent(stationName)}`)
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    // Verificar si es porque no tiene id_modal (estaci√≥n cerrada)
                    if (data.error.includes('id_modal no disponible')) {
                        container.innerHTML = `
                            <div class="modern-trains-container">
                                <div class="trains-header">
                                    <h4>üöÑ Pr√≥ximos Trenes</h4>
                                    <div class="trains-status">
                                        <span class="status-indicator closed"></span>
                                        <small>Cerrada</small>
                                    </div>
                                </div>
                                <div class="trains-content">
                                    <div class="closed-message">
                                        <h5>üöß Estaci√≥n Cerrada</h5>
                                        <p>Esta estaci√≥n est√° actualmente cerrada o en construcci√≥n.</p>
                                        <p><strong>No hay servicio de trenes disponible.</strong></p>
                                        <small>üí° Prueba con otra estaci√≥n cercana</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Otro tipo de error
                        container.innerHTML = `
                            <div class="modern-trains-container">
                                <div class="trains-header">
                                    <h4>üöÑ Pr√≥ximos Trenes</h4>
                                    <div class="trains-status">
                                        <span class="status-indicator error"></span>
                                        <small>Error</small>
                                    </div>
                                </div>
                                <div class="trains-content">
                                    <div class="error-message">‚ùå ${data.error}</div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    // Mostrar los trenes
                    displayRawTrainsData(data, containerId);
                }
            })
            .catch(error => {
                console.error('Error cargando trenes:', error);
                container.innerHTML = `
                    <div class="modern-trains-container">
                        <div class="trains-header">
                            <h4>üöÑ Pr√≥ximos Trenes</h4>
                            <div class="trains-status">
                                <span class="status-indicator error"></span>
                                <small>Error</small>
                            </div>
                        </div>
                        <div class="trains-content">
                            <div class="error-message">‚ùå No se pudieron cargar los trenes</div>
                        </div>
                    </div>
                `;
            });
    }

    // Renderizar la tira de paradas cercanas y el selector de l√≠nea
    function renderParadasCercanas(paradas, lineaActual, idActual, lineasDisponibles) {
        // Tira de circulitos
        const container = document.getElementById('paradasCercanasContainer');
        if (!container) return;
        
        // Detectar si es una l√≠nea circular
        const isCircular = ['6', '12'].includes(String(lineaActual));
        
        // Obtener color de la l√≠nea
        const lineColor = LINE_COLORS[lineaActual] || '#1976d2';
        
        // A√±adir clase especial para l√≠neas circulares
        const circularClass = isCircular ? ' circular' : '';
        let html = `<div class="station-strip${circularClass}" style="--line-color: ${lineColor}">`;
        html += '<div class="station-connector"></div>';
        
        paradas.forEach(parada => {
            const isActual = parada.is_actual;
            html += `
                <div style="display: flex; flex-direction: column; align-items: center;">
                    <a href="/station/${parada.linea}/${parada.id_fijo}" 
                       title="${parada.name} (L√≠nea ${parada.linea})"
                       class="station-dot${isActual ? ' active' : ''}"></a>
                    <span class="station-dot-label">${parada.name}</span>
                </div>
            `;
        });
        html += '</div>';
        
        // Selector de l√≠neas con iconos
        html += '<div class="line-selector">';
        lineasDisponibles.forEach(linea => {
            const selected = (linea == lineaActual) ? 'selected' : '';
            const logo = LINE_LOGOS[linea] || '/static/logos/lineas/_ml.svg';
            html += `<img src="${logo}" alt="L√≠nea ${linea}" class="line-icon ${selected}" title="L√≠nea ${linea}" onclick="window.location.href='/station/${linea}/${idActual}'">`;
        });
        html += '</div>';
        
        container.innerHTML = html;
        
        // Log para verificar si es circular
        if (isCircular) {
            console.log(`üîÑ L√≠nea circular ${lineaActual} detectada - Mostrando ${paradas.length} estaciones en bucle`);
        }
    }

    // Funci√≥n para hacer toggle del buscador
    function toggleSearchHeader() {
        const searchHeader = document.getElementById('searchHeaderBlock');
        const showSearchBtn = document.getElementById('showSearchBtn');
        
        if (!searchHeader || !showSearchBtn) return;
        
        // Si est√° oculto, mostrarlo
        if (searchHeader.style.display === 'none') {
            searchHeader.style.display = '';
            showSearchBtn.innerHTML = '‚ùå'; // Cambiar icono a X para cerrar
            // Scroll al buscador
            setTimeout(() => {
                searchHeader.scrollIntoView({behavior: 'smooth'});
            }, 100);
        } else {
            // Si est√° visible, ocultarlo
            searchHeader.style.display = 'none';
            showSearchBtn.innerHTML = 'üîç'; // Volver al icono de lupa
        }
    }

    // Mostrar/ocultar buscador seg√∫n la URL
    function checkAndToggleSearchHeader() {
        const isStationPage = window.location.pathname.match(/\/station\/(\d+|Ramal)\/(\d+)/);
        const searchHeader = document.getElementById('searchHeaderBlock');
        const showSearchBtn = document.getElementById('showSearchBtn');
        
        if (isStationPage) {
            if (searchHeader) searchHeader.style.display = 'none';
            if (showSearchBtn) {
                showSearchBtn.style.display = 'flex';
                showSearchBtn.innerHTML = 'üîç'; // Asegurar que empiece con lupa
            }
        } else {
            if (searchHeader) searchHeader.style.display = '';
            if (showSearchBtn) showSearchBtn.style.display = 'none';
        }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        checkAndToggleSearchHeader();
        const showSearchBtn = document.getElementById('showSearchBtn');
        if (showSearchBtn) {
            showSearchBtn.onclick = toggleSearchHeader;
        }
    });
    
    // ============================================================================
    // SISTEMA DE FAVORITOS PARA ESTACIONES
    // ============================================================================
    
    let isUserLoggedIn = {{ 'true' if current_user.is_authenticated else 'false' }};
    let currentStationData = null;
    
    // Verificar si el usuario est√° logueado
    async function checkUserLogin() {
        try {
            const response = await fetch('/api/favorites/lines');
            isUserLoggedIn = response.status !== 401;
        } catch (error) {
            isUserLoggedIn = false;
        }
    }
    
    async function loadStationFavoriteStatus() {
        if (!isUserLoggedIn || !currentStationData) return;
        
        try {
            const response = await fetch(`/api/favorites/check/station/${currentStationData.station_id}/${currentStationData.line_id}`);
            const data = await response.json();
            
            const btn = document.getElementById('favoriteStationBtn');
            if (btn) {
                btn.style.display = 'block'; // Mostrar el bot√≥n
                if (data.is_favorite) {
                    btn.classList.add('active');
                    btn.title = 'Eliminar de favoritos';
                } else {
                    btn.classList.remove('active');
                    btn.title = 'A√±adir a favoritos';
                }
            }
        } catch (error) {
            console.error('Error checking station favorite status:', error);
        }
    }
    
    async function toggleFavoriteStation() {
        if (!isUserLoggedIn) {
            alert('Debes iniciar sesi√≥n para usar favoritos');
            return;
        }
        
        if (!currentStationData) {
            alert('Error: datos de estaci√≥n no disponibles');
            return;
        }

        const btn = document.getElementById('favoriteStationBtn');
        const isCurrentlyFavorite = btn.classList.contains('active');
        
        try {
            if (isCurrentlyFavorite) {
                // Eliminar de favoritos
                const response = await fetch(`/api/favorites/stations/${currentStationData.station_id}/${currentStationData.line_id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    btn.classList.remove('active');
                    btn.title = 'A√±adir a favoritos';
                    
                    // Actualizar contador en el header
                    if (window.reloadFavoritesCounter) {
                        window.reloadFavoritesCounter();
                    }
                    console.log('‚úÖ Estaci√≥n eliminada de favoritos');
                } else {
                    console.error('‚ùå Error eliminando estaci√≥n de favoritos:', data.error);
                }
            } else {
                // A√±adir a favoritos
                const response = await fetch('/api/favorites/stations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        station_id: currentStationData.station_id,
                        line_id: currentStationData.line_id,
                        station_name: currentStationData.station_name
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    btn.classList.add('active');
                    btn.title = 'Eliminar de favoritos';
                    
                    // Actualizar contador en el header
                    if (window.reloadFavoritesCounter) {
                        window.reloadFavoritesCounter();
                    }
                    console.log('‚úÖ Estaci√≥n a√±adida a favoritos');
                } else {
                    console.error('‚ùå Error a√±adiendo estaci√≥n a favoritos:', data.error);
                }
            }
        } catch (error) {
            console.error('Error toggling station favorite:', error);
            console.error('Error al actualizar favoritos');
        }
    }
    
    // Hook para capturar cuando se carga una estaci√≥n y actualizar datos de favoritos
    function updateCurrentStationData(stationName, stationId, lineId) {
        currentStationData = {
            station_name: stationName,
            station_id: stationId,
            line_id: lineId
        };
        
        // Cargar estado de favorito despu√©s de un breve delay para asegurar que el bot√≥n existe
        setTimeout(() => {
            loadStationFavoriteStatus();
        }, 500);
    }
</script>
</body>
</html>
