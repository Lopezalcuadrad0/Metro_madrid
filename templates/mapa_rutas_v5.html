{% extends "base.html" %}
{% block title %}Metro Madrid - Mapa de Rutas v5.0{% endblock %}
{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f7f7f7;
    height: 100vh;
    overflow: hidden;
  }

  #map {
    position: absolute;
    top: 44px;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
  }

  /* Panel de control m√°s compacto */
  #control-panel {
    position: fixed;
    top: 56px;
    left: 15px;
    z-index: 2000;
    background: rgba(255, 255, 255, 0.97);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    padding: 16px;
    color: #333;
    font-size: 14px;
    width: 320px;
    max-height: 85vh;
    overflow-y: auto;
    transition: transform 0.5s ease;
    backdrop-filter: blur(10px);
  }

  /* Estado oculto del panel */
  #control-panel.hidden {
    transform: translateX(-100%);
  }

  /* La X se queda flotando cuando el panel se oculta */
  #control-panel.hidden .panel-header #hide-panel-btn {
    position: fixed;
    top: 66px;
    left: 16px;
    z-index: 2002;
    transform: translateX(0);
    transition: all 0.6s ease;
  }

  /* Efecto de entrada del panel */
  #control-panel.show {
    animation: slideInBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  @keyframes slideInBounce {
    0% {
      transform: translateY(-100%) scale(0.8);
      opacity: 0;
    }
    70% {
      transform: translateY(10px) scale(1.05);
      opacity: 0.9;
    }
    100% {
      transform: translateY(0) scale(1);
      opacity: 1;
    }
  }

  /* Responsive para m√≥vil */
  @media (max-width: 768px) {
    #control-panel {
      left: 2%;
      right: 2%;
      width: 96%;
      max-width: none;
      bottom: 15px;
      top: auto;
      max-height: 60vh;
      border-radius: 10px;
      padding: 12px;
    }

    #control-panel.hidden {
      transform: translateX(-100%);
    }

    #control-panel.hidden .panel-header #hide-panel-btn {
      position: fixed;
      bottom: 25px;
      left: 4%;
      top: auto;
    }
  }

  /* Header del panel */
  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e74c3c;
  }

  .panel-title {
    font-weight: bold;
    color: #e74c3c;
    font-size: 16px;
  }

  #hide-panel-btn {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  #hide-panel-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
  }

  /* Secciones del panel */
  .panel-section {
    margin-bottom: 16px;
    padding: 12px;
    background: rgba(248, 249, 250, 0.8);
    border-radius: 8px;
    border-left: 4px solid #0066cc;
  }

  .section-title {
    font-weight: 600;
    color: #0066cc;
    margin-bottom: 10px;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* B√∫squeda de rutas */
  .search-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .search-input-group {
    position: relative;
  }

  .search-input {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #e0e6ed;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s;
  }

  .search-input:focus {
    outline: none;
    border-color: #0066cc;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
  }

  .suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    max-height: 150px;
    overflow-y: auto;
    z-index: 2001;
    display: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .suggestion-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    font-size: 13px;
  }

  .suggestion-item:hover {
    background: #f8f9fa;
  }

  .suggestion-item:last-child {
    border-bottom: none;
  }

  .search-button {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s;
  }

  .search-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
  }

  .search-button:disabled {
    background: #95a5a6;
    cursor: not-allowed;
    transform: none;
  }

  /* Informaci√≥n de ruta */
  .route-info {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    padding: 12px;
    border-radius: 8px;
    margin-top: 10px;
    display: none;
  }

  .route-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 8px;
  }

  .route-stat {
    text-align: center;
  }

  .route-stat-value {
    font-size: 18px;
    font-weight: bold;
  }

  .route-stat-label {
    font-size: 11px;
    opacity: 0.9;
  }

  /* Controles de capa */
  .layer-controls {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .control-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
  }

  .control-item input[type="checkbox"] {
    accent-color: #e74c3c;
  }

  /* Loading y mensajes */
  .loading-overlay {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }

  .spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #e74c3c;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .message {
    padding: 8px 12px;
    border-radius: 6px;
    margin: 8px 0;
    font-size: 13px;
    display: none;
  }

  .message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  /* Bot√≥n de mostrar panel (cuando est√° oculto) */
  #show-panel-btn {
    display: none;
    position: fixed;
    top: 66px;
    left: 15px;
    z-index: 2001;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  #show-panel-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
  }

  /* Efecto de entrada del bot√≥n hamburguesa */
  #show-panel-btn.show {
    display: flex;
    animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  @keyframes bounceIn {
    0% {
      transform: scale(0) rotate(-180deg);
      opacity: 0;
    }
    50% {
      transform: scale(1.2) rotate(-90deg);
      opacity: 0.8;
    }
    100% {
      transform: scale(1) rotate(0deg);
      opacity: 1;
    }
  }

  /* Estilos para marcadores y mapas */
  .station-marker {
    border: 2px solid white !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
    transition: all 0.3s ease !important;
  }

  .route-marker-origin {
    background: #27ae60 !important;
    border: 3px solid white !important;
    box-shadow: 0 0 15px rgba(39, 174, 96, 0.6) !important;
  }

  .route-marker-destination {
    background: #e74c3c !important;
    border: 3px solid white !important;
    box-shadow: 0 0 15px rgba(231, 76, 60, 0.6) !important;
  }

  /* Estilos personalizados para clusters de marcadores */
  .marker-cluster {
    background: transparent !important;
    border: none !important;
    border-radius: 50% !important;
    box-shadow: none !important;
  }

  .marker-cluster-small {
    background: transparent !important;
  }

  .marker-cluster-medium {
    background: transparent !important;
  }

  .marker-cluster-large {
    background: transparent !important;
  }

  /* Estilos para tooltips de estaciones */
  .station-tooltip {
    background: rgba(0, 0, 0, 0.8) !important;
    color: white !important;
    border: none !important;
    border-radius: 8px !important;
    padding: 8px 12px !important;
    font-size: 13px !important;
    font-weight: bold !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
  }

  .station-tooltip::before {
    border-top-color: rgba(0, 0, 0, 0.8) !important;
  }

  /* Estilos para tooltips de clusters */
  .cluster-tooltip {
    background: rgba(255, 255, 255, 0.95) !important;
    color: #333 !important;
    border: 2px solid #0055a4 !important;
    border-radius: 8px !important;
    padding: 10px 15px !important;
    font-size: 12px !important;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
    max-width: 300px !important;
  }

  .cluster-tooltip::before {
    border-top-color: #0055a4 !important;
  }

  /* Bot√≥n de ubicaci√≥n flotante */
  #location-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 2001;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #e74c3c;
    border: 3px solid #c0392b;
    color: white;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    transition: all 0.3s ease;
  }

  #location-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
  }

  #location-btn:active {
    transform: scale(0.95);
  }

  /* Panel de ubicaci√≥n */
  .location-panel {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .location-buttons {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  .location-btn {
    flex: 1;
    padding: 10px 8px;
    border: none;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .location-btn.primary {
    background: #e74c3c;
    color: white;
  }

  .location-btn.secondary {
    background: #27ae60;
    color: white;
  }

  .location-btn.tertiary {
    background: #3498db;
    color: white;
  }

  .location-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .location-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  /* Panel de capas */
  .layers-panel {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  .layers-buttons {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  .layer-btn {
    flex: 1;
    padding: 10px 8px;
    border: 2px solid #ddd;
    border-radius: 8px;
    background: white;
    color: #333;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .layer-btn.active {
    background: #0066cc;
    color: white;
    border-color: #0066cc;
  }

  .layer-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  /* Responsive */
  @media (max-width: 768px) {
    #location-btn {
      bottom: 20px;
      right: 20px;
      width: 45px;
      height: 45px;
      font-size: 18px;
    }

    .location-buttons,
    .layers-buttons {
      flex-direction: column;
    }
  }
</style>
{% endblock %}

{% block content %}
<div id="map"></div>

<!-- Panel de control principal -->
<div id="control-panel">
  <div class="panel-header">
    <div class="panel-title">üó∫Ô∏è Calculadora de Rutas</div>
    <button id="hide-panel-btn">‚úï</button>
  </div>

  <!-- Secci√≥n de b√∫squeda de rutas -->
  <div class="panel-section">
    <div class="section-title">üîç Buscar Ruta</div>
    <div class="search-container">
      <div class="search-input-group">
        <input type="text" id="origen" class="search-input" placeholder="Estaci√≥n origen..." autocomplete="off">
        <div class="suggestions" id="origen-suggestions"></div>
      </div>
      <div class="search-input-group">
        <input type="text" id="destino" class="search-input" placeholder="Estaci√≥n destino..." autocomplete="off">
        <div class="suggestions" id="destino-suggestions"></div>
      </div>
      <button class="search-button" onclick="calcularRuta()" id="calc-btn">
        üöá Calcular Ruta √ìptima
      </button>
    </div>

    <div class="message error" id="error-message"></div>
    <div class="message success" id="success-message"></div>

    <!-- Informaci√≥n de la ruta calculada -->
    <div class="route-info" id="route-info">
      <div class="route-stats">
        <div class="route-stat">
          <div class="route-stat-value" id="route-time">--</div>
          <div class="route-stat-label">minutos</div>
        </div>
        <div class="route-stat">
          <div class="route-stat-value" id="route-transfers">--</div>
          <div class="route-stat-label">transbordos</div>
        </div>
        <div class="route-stat">
          <div class="route-stat-value" id="route-stations">--</div>
          <div class="route-stat-label">estaciones</div>
        </div>
      </div>
      <div style="font-size: 12px; text-align: center; opacity: 0.9;" id="route-algorithm">
        Algoritmo: <span id="algorithm-used">--</span>
      </div>
    </div>
  </div>

  <!-- Panel de ubicaci√≥n -->
  <div class="location-panel">
    <div class="section-title">üìç Tu ubicaci√≥n</div>
    <div class="location-buttons">
      <button class="location-btn primary" id="find-me-btn">
        üéØ Encontrar mi ubicaci√≥n
      </button>
      <button class="location-btn secondary" id="nearest-station-btn">
        üöá Estaci√≥n m√°s cercana
      </button>
      <button class="location-btn tertiary" id="nearby-stations-btn">
        üìç Estaciones cercanas
      </button>
    </div>
  </div>

  <!-- Panel de capas -->
  <div class="layers-panel">
    <div class="section-title">üéõÔ∏è Capas del mapa</div>
    <div class="layers-buttons">
      <button class="layer-btn active" id="toggle-stations-btn">
        üöâ Estaciones
      </button>
      <button class="layer-btn active" id="toggle-routes-btn">
        üöá L√≠neas
      </button>
      <button class="layer-btn" id="toggle-my-location-btn">
        üìç Mi ubicaci√≥n
      </button>
    </div>
  </div>

  <!-- Informaci√≥n del sistema -->
  <div class="panel-section">
    <div class="section-title">‚ÑπÔ∏è Estado del Sistema</div>
    <div style="font-size: 12px; line-height: 1.4;">
      <div><strong>Zoom:</strong> <span id="zoom-level">--</span></div>
      <div><strong>Centro:</strong> <span id="map-center">--</span></div>
      <div style="margin: 8px 0;">
        <button onclick="refreshMapData()" style="width: 100%; padding: 6px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
          üîÑ Actualizar Datos
        </button>
      </div>
      <div style="text-align: center; color: #666; font-size: 11px;" id="last-update">
        Sistema v5.0 - √öltima actualizaci√≥n: --
      </div>
    </div>
  </div>
</div>

<!-- Bot√≥n para mostrar panel cuando est√° oculto -->
<button id="show-panel-btn">‚ò∞</button>

<!-- Bot√≥n de ubicaci√≥n flotante -->
<button id="location-btn" title="Activar ubicaci√≥n">üìç</button>

<!-- Loading overlay -->
<div class="loading-overlay" id="loading-overlay">
  <div class="spinner"></div>
  <p>Calculando ruta √≥ptima...</p>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ========================================================================
    // 1. INICIALIZACI√ìN DEL MAPA Y VARIABLES GLOBALES
    // ========================================================================
    
    const map = L.map('map', {
        center: [40.4168, -3.7038],
        zoom: 12,
        minZoom: 10,
        maxZoom: 18
    });

    // Capas base
    const baseLayers = {
        light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© CARTO'
        }),
        dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '¬© CARTO'
        })
    };

    let currentBaseLayer = baseLayers.light;
    currentBaseLayer.addTo(map);

    // Variables globales
    const routeLayers = {};
    const lineColors = {};
    let stationClusterLayer = L.markerClusterGroup({
        maxClusterRadius: 30,
        disableClusteringAtZoom: 15
    });
    let currentRouteLayer = L.layerGroup();
    let estaciones = [];
    let routeMarkers = [];

    // ========================================================================
    // 2. FUNCIONES DE CARGA DE DATOS
    // ========================================================================

    async function loadAllData() {
        try {
            console.log('üîÑ Cargando datos del sistema...');
            
            const [routesResponse, stationsResponse] = await Promise.all([
                fetch('/static/data/metro_routes.json?v=' + new Date().getTime()),
                fetch('/api/stations/all?v=' + new Date().getTime())
            ]);

            if (!routesResponse.ok || !stationsResponse.ok) {
                throw new Error('Error al cargar datos del servidor');
            }

            const routesData = await routesResponse.json();
            const stationsData = await stationsResponse.json();

            // Procesar l√≠neas y rutas
            if (routesData.lines && Array.isArray(routesData.lines)) {
                routesData.lines.forEach(line => {
                    const lineId = line.line;
                    const lineColor = line.color || '#666666';
                    const lineName = line.name || `L√≠nea ${lineId}`;

                    lineColors[lineId] = { color: lineColor, name: lineName };

                    if (!routeLayers[lineId]) {
                        routeLayers[lineId] = L.layerGroup();
                    }

                    if (line.paths && Array.isArray(line.paths)) {
                        line.paths.forEach(path => {
                            const latLngs = path.map(coord => [coord[0], coord[1]]);
                            if (latLngs.length < 2) return;

                            const polyline = L.polyline(latLngs, {
                                color: lineColor,
                                weight: 4,
                                opacity: 0.7
                            });

                            polyline.bindTooltip(`${lineName}`, {
                                sticky: true,
                                className: 'route-tooltip'
                            });

                            routeLayers[lineId].addLayer(polyline);
                        });
                    }
                });

                Object.values(routeLayers).forEach(layer => layer.addTo(map));
            }

            // Procesar estaciones
            if (Array.isArray(stationsData)) {
                estaciones = stationsData;
                drawStations(stationsData);
            }

            updateLastUpdateTime();
            console.log('‚úÖ Datos cargados correctamente');

        } catch (error) {
            console.error('‚ùå Error cargando datos:', error);
            showMessage('Error al cargar los datos del mapa', 'error');
        }
    }

    function drawStations(stations) {
        stationClusterLayer.clearLayers();

        const stationsByName = {};

        stations.forEach(station => {
            if (!station.lat || !station.lon) return;

            const stationName = station.name;
            if (!stationsByName[stationName]) {
                stationsByName[stationName] = {
                    name: stationName,
                    lat: station.lat,
                    lon: station.lon,
                    lines: new Set(),
                    id_fijo: station.id
                };
            }

            stationsByName[stationName].lines.add(station.line);
        });

        Object.values(stationsByName).forEach(stationData => {
            const linesArray = Array.from(stationData.lines).sort();
            const mainLine = linesArray[0];
            const lineConfig = lineColors[mainLine] || { color: '#666666' };

            const marker = L.circleMarker([stationData.lat, stationData.lon], {
                radius: linesArray.length > 1 ? 8 : 5,
                fillColor: lineConfig.color,
                color: '#fff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.9,
                className: 'station-marker'
            });

            marker.stationData = stationData;

            marker.bindTooltip(
                `${stationData.name}<br><strong>L√≠neas:</strong> ${linesArray.join(', ')}`,
                {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -10],
                    className: 'station-tooltip'
                }
            );

            stationClusterLayer.addLayer(marker);
        });

        map.addLayer(stationClusterLayer);
    }

    // Configuraci√≥n mejorada de clusters
    function setupClusterConfiguration() {
        // Personalizar el estilo de los clusters
        stationClusterLayer.on('clusterclick', function(e) {
            const markers = e.layer.getAllChildMarkers();
            
            // Encontrar la l√≠nea principal (la que m√°s aparece en el cluster)
            const lineCounts = {};
            markers.forEach((marker) => {
                if (marker.stationData && marker.stationData.lines) {
                    marker.stationData.lines.forEach((line) => {
                        lineCounts[line] = (lineCounts[line] || 0) + 1;
                    });
                }
            });

            // Obtener la l√≠nea m√°s frecuente, en caso de empate elegir la menor
            let mainLine = "default";
            let maxCount = 0;
            let minLineNumber = Infinity;
            
            for (const [line, count] of Object.entries(lineCounts)) {
                const lineNumber = parseInt(line.replace("R", "99"));
                
                if (count > maxCount || (count === maxCount && lineNumber < minLineNumber)) {
                    maxCount = count;
                    mainLine = line;
                    minLineNumber = lineNumber;
                }
            }

            const lineConfig = lineColors[mainLine] || { color: '#666666' };
            
            // Crear tooltip con informaci√≥n del cluster
            const stationNames = markers.map(m => m.stationData.name).join(', ');
            const tooltipContent = `
                <div class="cluster-tooltip">
                    <strong>${markers.length} estaciones</strong><br>
                    <small>${stationNames}</small><br>
                    <small>L√≠nea principal: ${mainLine}</small>
                </div>
            `;

            e.layer.bindTooltip(tooltipContent, {
                permanent: false,
                direction: 'top',
                offset: [0, -10],
                className: 'cluster-tooltip'
            });
        });

        // Personalizar el estilo visual de los clusters
        stationClusterLayer.on('add', function() {
            const clusterElements = document.querySelectorAll('.marker-cluster');
            clusterElements.forEach(cluster => {
                const markers = cluster._leaflet_id ? stationClusterLayer.getLayer(cluster._leaflet_id)?.getAllChildMarkers() : [];
                if (markers && markers.length > 0) {
                    const lineCounts = {};
                    markers.forEach((marker) => {
                        if (marker.stationData && marker.stationData.lines) {
                            marker.stationData.lines.forEach((line) => {
                                lineCounts[line] = (lineCounts[line] || 0) + 1;
                            });
                        }
                    });

                    let mainLine = "default";
                    let maxCount = 0;
                    let minLineNumber = Infinity;
                    
                    for (const [line, count] of Object.entries(lineCounts)) {
                        const lineNumber = parseInt(line.replace("R", "99"));
                        
                        if (count > maxCount || (count === maxCount && lineNumber < minLineNumber)) {
                            maxCount = count;
                            mainLine = line;
                            minLineNumber = lineNumber;
                        }
                    }

                    const lineConfig = lineColors[mainLine] || { color: '#666666' };
                    
                    // Aplicar color de la l√≠nea principal al cluster
                    cluster.style.backgroundColor = lineConfig.color;
                    cluster.style.borderColor = '#fff';
                    cluster.style.color = '#fff';
                    cluster.style.fontWeight = 'bold';
                }
            });
        });
    }

    // ========================================================================
    // 3. AUTOCOMPLETADO Y B√öSQUEDA
    // ========================================================================

    function setupAutocomplete() {
        const origenInput = document.getElementById('origen');
        const destinoInput = document.getElementById('destino');
        const origenSuggestions = document.getElementById('origen-suggestions');
        const destinoSuggestions = document.getElementById('destino-suggestions');

        function setupInputAutocomplete(input, suggestionsDiv) {
            input.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 2) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                const uniqueStations = [...new Set(estaciones.map(e => e.name))]
                    .filter(name => name.toLowerCase().includes(query))
                    .sort()
                    .slice(0, 8);

                if (uniqueStations.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                suggestionsDiv.innerHTML = uniqueStations
                    .map(name => `<div class="suggestion-item" onclick="selectStation('${input.id}', '${name}')">${name}</div>`)
                    .join('');
                
                suggestionsDiv.style.display = 'block';
            });

            input.addEventListener('blur', function() {
                setTimeout(() => {
                    suggestionsDiv.style.display = 'none';
                }, 150);
            });
        }

        setupInputAutocomplete(origenInput, origenSuggestions);
        setupInputAutocomplete(destinoInput, destinoSuggestions);
    }

    window.selectStation = function(inputId, stationName) {
        document.getElementById(inputId).value = stationName;
        document.getElementById(inputId + '-suggestions').style.display = 'none';
    };

    // ========================================================================
    // 4. C√ÅLCULO Y VISUALIZACI√ìN DE RUTAS
    // ========================================================================

    window.calcularRuta = async function() {
        const origen = document.getElementById('origen').value.trim();
        const destino = document.getElementById('destino').value.trim();

        if (!origen || !destino) {
            showMessage('Por favor, ingresa estaci√≥n de origen y destino', 'error');
            return;
        }

        if (origen === destino) {
            showMessage('La estaci√≥n de origen y destino no pueden ser iguales', 'error');
            return;
        }

        const loadingOverlay = document.getElementById('loading-overlay');
        const calcBtn = document.getElementById('calc-btn');
        
        loadingOverlay.style.display = 'flex';
        calcBtn.disabled = true;

        try {
            console.log(`üöá Calculando ruta: ${origen} ‚Üí ${destino}`);
            
            const response = await fetch(`/api/v5/route?origen=${encodeURIComponent(origen)}&destino=${encodeURIComponent(destino)}&algoritmo=dijkstra_bidirectional&optimizacion=min_time`);
            const data = await response.json();

            if (data.success) {
                const ruta = data.data.ruta;
                showMessage(`Ruta calculada: ${ruta.tiempo_total} min, ${ruta.transbordos} transbordos`, 'success');
                
                // Mostrar informaci√≥n de la ruta
                document.getElementById('route-time').textContent = Math.round(ruta.tiempo_total * 10) / 10;
                document.getElementById('route-transfers').textContent = ruta.transbordos;
                document.getElementById('route-stations').textContent = ruta.estaciones;
                document.getElementById('algorithm-used').textContent = ruta.algoritmo;
                document.getElementById('route-info').style.display = 'block';

                // Visualizar ruta en el mapa
                visualizeRoute(data.data);
            } else {
                showMessage('Error: ' + data.error, 'error');
            }

        } catch (error) {
            console.error('‚ùå Error calculando ruta:', error);
            showMessage('Error conectando con el servidor', 'error');
        } finally {
            loadingOverlay.style.display = 'none';
            calcBtn.disabled = false;
        }
    };

    function visualizeRoute(routeData) {
        // Limpiar ruta anterior
        currentRouteLayer.clearLayers();
        
        if (!routeData.ruta.path || routeData.ruta.path.length === 0) {
            console.warn('No hay path en la ruta');
            return;
        }

        const path = routeData.ruta.path;
        let bounds = L.latLngBounds();

        // Crear marcadores para origen, destino y transbordos
        path.forEach((step, index) => {
            if (!step.coordenadas || step.coordenadas.length !== 2) return;

            const [lat, lon] = step.coordenadas;
            bounds.extend([lat, lon]);

            let markerClass = 'station-marker';
            let tooltipText = step.estacion;

            if (index === 0) {
                markerClass = 'route-marker-origin';
                tooltipText = `üöÄ ${step.estacion} (Origen)`;
            } else if (index === path.length - 1) {
                markerClass = 'route-marker-destination';
                tooltipText = `üéØ ${step.estacion} (Destino)`;
            } else if (step.es_transbordo) {
                markerClass = 'route-marker-transfer';
                tooltipText = `üîÑ ${step.estacion} (Transbordo)`;
            }

            const marker = L.circleMarker([lat, lon], {
                radius: index === 0 || index === path.length - 1 ? 10 : 7,
                className: markerClass,
                fillOpacity: 1
            });

            marker.bindTooltip(tooltipText, {
                permanent: false,
                direction: 'top',
                className: 'route-tooltip'
            });

            currentRouteLayer.addLayer(marker);
        });

        // Crear l√≠neas de la ruta
        for (let i = 0; i < path.length - 1; i++) {
            const current = path[i];
            const next = path[i + 1];

            if (!current.coordenadas || !next.coordenadas) continue;

            const currentLineColor = lineColors[current.linea]?.color || '#e74c3c';
            
            const routeLine = L.polyline([current.coordenadas, next.coordenadas], {
                color: currentLineColor,
                weight: 6,
                opacity: 0.8,
                dashArray: current.es_transbordo ? '10, 5' : null
            });

            currentRouteLayer.addLayer(routeLine);
        }

        // A√±adir al mapa y ajustar vista
        if (document.getElementById('toggleRoute').checked) {
            currentRouteLayer.addTo(map);
        }

        if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [20, 20] });
        }

        console.log('‚úÖ Ruta visualizada en el mapa');
    }

    // ========================================================================
    // 5. FUNCIONALIDAD DE UBICACI√ìN
    // ========================================================================

    let userLocationMarker = null;
    let userLocationCircle = null;

    // Obtener ubicaci√≥n del usuario
    function getUserLocation() {
        if (!navigator.geolocation) {
            showMessage('La geolocalizaci√≥n no est√° disponible en tu navegador', 'error');
            return;
        }

        const locationBtn = document.getElementById('location-btn');
        locationBtn.innerHTML = '‚è≥';
        locationBtn.disabled = true;

        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;

                // Centrar mapa en la ubicaci√≥n del usuario
                map.setView([lat, lng], 15);

                // Crear marcador de ubicaci√≥n
                if (userLocationMarker) {
                    map.removeLayer(userLocationMarker);
                }
                if (userLocationCircle) {
                    map.removeLayer(userLocationCircle);
                }

                userLocationMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-location-marker',
                        html: 'üìç',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);

                userLocationCircle = L.circle([lat, lng], {
                    color: '#e74c3c',
                    fillColor: '#e74c3c',
                    fillOpacity: 0.2,
                    radius: accuracy
                }).addTo(map);

                showMessage(`Ubicaci√≥n encontrada (precisi√≥n: ${Math.round(accuracy)}m)`, 'success');
                
                // Activar bot√≥n de ubicaci√≥n
                document.getElementById('toggle-my-location-btn').classList.add('active');
                
                locationBtn.innerHTML = 'üìç';
                locationBtn.disabled = false;
            },
            function(error) {
                let errorMessage = 'Error al obtener tu ubicaci√≥n';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Permiso denegado para acceder a la ubicaci√≥n';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Informaci√≥n de ubicaci√≥n no disponible';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Tiempo de espera agotado para obtener ubicaci√≥n';
                        break;
                }
                showMessage(errorMessage, 'error');
                
                locationBtn.innerHTML = 'üìç';
                locationBtn.disabled = false;
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    }

    // Encontrar estaci√≥n m√°s cercana
    function findNearestStation() {
        if (!userLocationMarker) {
            showMessage('Primero activa tu ubicaci√≥n', 'error');
            return;
        }

        const userLatLng = userLocationMarker.getLatLng();
        let nearestStation = null;
        let minDistance = Infinity;

        estaciones.forEach(station => {
            if (station.lat && station.lon) {
                const distance = userLatLng.distanceTo([station.lat, station.lon]);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStation = station;
                }
            }
        });

        if (nearestStation) {
            // Centrar en la estaci√≥n m√°s cercana
            map.setView([nearestStation.lat, nearestStation.lon], 16);
            
            // Resaltar la estaci√≥n
            const marker = L.circleMarker([nearestStation.lat, nearestStation.lon], {
                radius: 12,
                fillColor: '#27ae60',
                color: '#fff',
                weight: 3,
                fillOpacity: 0.8
            }).addTo(map);

            marker.bindTooltip(
                `üöá Estaci√≥n m√°s cercana: ${nearestStation.name}<br>Distancia: ${Math.round(minDistance)}m`,
                { permanent: true, className: 'station-tooltip' }
            );

            setTimeout(() => {
                map.removeLayer(marker);
            }, 5000);

            showMessage(`Estaci√≥n m√°s cercana: ${nearestStation.name} (${Math.round(minDistance)}m)`, 'success');
        }
    }

    // Encontrar estaciones cercanas
    function findNearbyStations() {
        if (!userLocationMarker) {
            showMessage('Primero activa tu ubicaci√≥n', 'error');
            return;
        }

        const userLatLng = userLocationMarker.getLatLng();
        const nearbyStations = [];
        const maxDistance = 1000; // 1km

        estaciones.forEach(station => {
            if (station.lat && station.lon) {
                const distance = userLatLng.distanceTo([station.lat, station.lon]);
                if (distance <= maxDistance) {
                    nearbyStations.push({ ...station, distance });
                }
            }
        });

        nearbyStations.sort((a, b) => a.distance - b.distance);

        if (nearbyStations.length > 0) {
            // Mostrar las 5 estaciones m√°s cercanas
            const topStations = nearbyStations.slice(0, 5);
            
            topStations.forEach(station => {
                const marker = L.circleMarker([station.lat, station.lon], {
                    radius: 8,
                    fillColor: '#3498db',
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 0.8
                }).addTo(map);

                marker.bindTooltip(
                    `${station.name}<br>${Math.round(station.distance)}m`,
                    { permanent: false, className: 'station-tooltip' }
                );
            });

            showMessage(`Encontradas ${nearbyStations.length} estaciones en 1km`, 'success');
        } else {
            showMessage('No hay estaciones cercanas en 1km', 'error');
        }
    }

    // ========================================================================
    // 6. CONTROLES DE CAPAS
    // ========================================================================

    function setupLayerControls() {
        // Bot√≥n de estaciones
        document.getElementById('toggle-stations-btn').addEventListener('click', function() {
            this.classList.toggle('active');
            if (this.classList.contains('active')) {
                map.addLayer(stationClusterLayer);
            } else {
                map.removeLayer(stationClusterLayer);
            }
        });

        // Bot√≥n de l√≠neas
        document.getElementById('toggle-routes-btn').addEventListener('click', function() {
            this.classList.toggle('active');
            Object.values(routeLayers).forEach(layer => {
                if (this.classList.contains('active')) {
                    map.addLayer(layer);
                } else {
                    map.removeLayer(layer);
                }
            });
        });

        // Bot√≥n de mi ubicaci√≥n
        document.getElementById('toggle-my-location-btn').addEventListener('click', function() {
            this.classList.toggle('active');
            if (this.classList.contains('active')) {
                if (userLocationMarker) {
                    map.addLayer(userLocationMarker);
                    if (userLocationCircle) map.addLayer(userLocationCircle);
                } else {
                    getUserLocation();
                }
            } else {
                if (userLocationMarker) {
                    map.removeLayer(userLocationMarker);
                    if (userLocationCircle) map.removeLayer(userLocationCircle);
                }
            }
        });
    }

    // ========================================================================
    // 7. EVENT LISTENERS
    // ========================================================================

    function setupEventListeners() {
        // Botones de ubicaci√≥n
        document.getElementById('find-me-btn').addEventListener('click', getUserLocation);
        document.getElementById('nearest-station-btn').addEventListener('click', findNearestStation);
        document.getElementById('nearby-stations-btn').addEventListener('click', findNearbyStations);
        
        // Bot√≥n flotante de ubicaci√≥n
        document.getElementById('location-btn').addEventListener('click', getUserLocation);

        // Controles de capas
        setupLayerControls();

        // Panel de control
        document.getElementById('hide-panel-btn').addEventListener('click', function() {
            document.getElementById('control-panel').classList.add('hidden');
            document.getElementById('show-panel-btn').classList.add('show');
        });

        document.getElementById('show-panel-btn').addEventListener('click', function() {
            document.getElementById('control-panel').classList.remove('hidden');
            this.classList.remove('show');
        });

        // Eventos del mapa
        map.on('moveend', updateMapInfo);
        map.on('zoomend', updateMapInfo);

        // Tecla Enter para calcular ruta
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement && (activeElement.id === 'origen' || activeElement.id === 'destino')) {
                    calcularRuta();
                }
            }
        });
    }

    // ========================================================================
    // 8. UTILIDADES Y FUNCIONES AUXILIARES
    // ========================================================================

    function showMessage(text, type) {
        const errorMsg = document.getElementById('error-message');
        const successMsg = document.getElementById('success-message');
        
        errorMsg.style.display = 'none';
        successMsg.style.display = 'none';

        if (type === 'error') {
            errorMsg.textContent = text;
            errorMsg.style.display = 'block';
        } else {
            successMsg.textContent = text;
            successMsg.style.display = 'block';
        }

        // Auto-ocultar mensajes despu√©s de 5 segundos
        setTimeout(() => {
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
        }, 5000);
    }

    function updateLastUpdateTime() {
        document.getElementById('last-update').textContent = 
            `Sistema v5.0 - Actualizada: ${new Date().toLocaleTimeString()}`;
    }

    function updateMapInfo() {
        const center = map.getCenter();
        document.getElementById('map-center').textContent = 
            `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
        document.getElementById('zoom-level').textContent = map.getZoom();
    }

    window.refreshMapData = function() {
        loadAllData();
    };

    // ========================================================================
    // 9. INICIALIZACI√ìN
    // ========================================================================

    // Inicializar todo
    loadAllData();
    setupAutocomplete();
    setupClusterConfiguration();
    updateMapInfo();
    setupEventListeners();

    console.log('üöá Sistema de Mapa de Rutas v5.0 inicializado correctamente');
});
</script>
{% endblock %} 