{% extends "base.html" %}
{% block title %}Metro Madrid - Mapa de Rutas v5.0{% endblock %}
{% block extra_css %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f7f7f7;
    height: 100vh;
    overflow: hidden;
  }

  #map {
    position: absolute;
    top: 44px;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
  }

  /* Panel de control m√°s compacto */
  #control-panel {
    position: fixed;
    top: 56px;
    left: 15px;
    z-index: 2000;
    background: rgba(255, 255, 255, 0.97);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    padding: 16px;
    color: #333;
    font-size: 14px;
    width: 500px;
    max-height: 85vh;
    overflow-y: auto;
    transition: transform 0.5s ease;
    backdrop-filter: blur(10px);
  }

  /* Tema oscuro para el panel de control */
  [data-theme="dark"] #control-panel,
  [data-theme="nocturno"] #control-panel {
    background: rgba(30, 30, 30, 0.95);
    color: #e0e0e0;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
  }

  /* Estado oculto del panel */
  #control-panel.hidden {
    transform: translateX(-100%);
  }

  /* La X se queda flotando cuando el panel se oculta */
  #control-panel.hidden .panel-header #hide-panel-btn {
    position: fixed;
    top: 66px;
    left: 16px;
    z-index: 2002;
    transform: translateX(0);
    transition: all 0.6s ease;
  }

  /* Efecto de entrada del panel */
  #control-panel.show {
    animation: slideInBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  @keyframes slideInBounce {
    0% {
      transform: translateY(-100%) scale(0.8);
      opacity: 0;
    }
    70% {
      transform: translateY(10px) scale(1.05);
      opacity: 0.9;
    }
    100% {
      transform: translateY(0) scale(1);
      opacity: 1;
    }
  }

  /* Responsive para m√≥vil */
  @media (max-width: 768px) {
    #control-panel {
      left: 2%;
      right: 2%;
      width: 96%;
      max-width: none;
      bottom: 15px;
      top: auto;
      max-height: 60vh;
      border-radius: 10px;
      padding: 12px;
    }

    #control-panel.hidden {
      transform: translateX(-100%);
    }
    #control-panel::-webkit-scrollbar {
        display: none; /* Hide scrollbar for Chrome, Safari, and Opera */
    }

    #control-panel.hidden .panel-header #hide-panel-btn {
      position: fixed;
      bottom: 25px;
      left: 4%;
      top: auto;
    }

    #location-btn {
      bottom: 20px;
      right: 20px;
      width: 45px;
      height: 45px;
      font-size: 18px;
    }

    .location-buttons,
    .layers-buttons {
      flex-direction: column;
    }

    /* Panel de ruta flotante en m√≥vil */
    .mobile-route-panel {
      position: fixed;
      top: 70px;
      left: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      z-index: 2000;
      display: none;
      backdrop-filter: blur(10px);
      border: 2px solid #e74c3c;
    }

    .mobile-route-panel.show {
      display: block;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .mobile-route-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e74c3c;
    }

    .mobile-route-title {
      font-weight: bold;
      color: #e74c3c;
      font-size: 16px;
    }

    .mobile-route-close {
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .mobile-route-stats {
      display: flex;
      justify-content: space-around;
      margin-bottom: 8px;
    }

    .mobile-route-stat {
      text-align: center;
    }

    .mobile-route-stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #e74c3c;
    }

    .mobile-route-stat-label {
      font-size: 11px;
      color: #666;
    }

    .mobile-route-algorithm {
      font-size: 11px;
      text-align: center;
      color: #666;
      opacity: 0.9;
    }
  }

  /* Header del panel */
  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 2px solid #e74c3c;
  }

  .panel-title {
    font-weight: bold;
    color: #e74c3c;
    font-size: 16px;
  }

  #hide-panel-btn {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  #hide-panel-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
  }

  /* Secciones del panel */
  .panel-section {
    margin-bottom: 16px;
    padding: 12px;
    background: rgba(248, 249, 250, 0.8);
    border-radius: 8px;
    border-left: 4px solid #0066cc;
  }

  /* Tema oscuro para secciones */
  [data-theme="dark"] .panel-section,
  [data-theme="nocturno"] .panel-section {
    background: rgba(45, 45, 45, 0.8);
    border-left-color: #4a9eff;
  }

  .section-title {
    font-weight: 600;
    color: #0066cc;
    margin-bottom: 10px;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Tema oscuro para t√≠tulos */
  [data-theme="dark"] .section-title,
  [data-theme="nocturno"] .section-title {
    color: #4a9eff;
  }

  /* B√∫squeda de rutas */
  .search-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .search-input-group {
    position: relative;
  }

  .search-input {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #e0e6ed;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s;
    background: white;
    color: #333;
  }

  /* Tema oscuro para inputs */
  [data-theme="dark"] .search-input,
  [data-theme="nocturno"] .search-input {
    background: #2a2a2a;
    border-color: #444;
    color: #e0e0e0;
  }

  .search-input:focus {
    outline: none;
    border-color: #0066cc;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
  }

  /* Tema oscuro para focus */
  [data-theme="dark"] .search-input:focus,
  [data-theme="nocturno"] .search-input:focus {
    border-color: #4a9eff;
    box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.2);
  }

  .suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    max-height: 150px;
    overflow-y: auto;
    z-index: 2001;
    display: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  /* Tema oscuro para sugerencias */
  [data-theme="dark"] .suggestions,
  [data-theme="nocturno"] .suggestions {
    background: #2a2a2a;
    border-color: #444;
    box-shadow: 0 2px 10px rgba(0,0,0,0.4);
  }

  .suggestion-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    font-size: 13px;
    color: #333;
  }

  /* Tema oscuro para items de sugerencia */
  [data-theme="dark"] .suggestion-item,
  [data-theme="nocturno"] .suggestion-item {
    border-bottom-color: #444;
    color: #e0e0e0;
  }

  .suggestion-item:hover {
    background: #f8f9fa;
  }

  /* Tema oscuro para hover de sugerencias */
  [data-theme="dark"] .suggestion-item:hover,
  [data-theme="nocturno"] .suggestion-item:hover {
    background: #3a3a3a;
  }

  .search-button {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.3s;
  }

  .search-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
  }

  .search-button:disabled {
    background: #95a5a6;
    cursor: not-allowed;
    transform: none;
  }

  /* Informaci√≥n de ruta */
  .route-info {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    padding: 12px;
    border-radius: 8px;
    margin-top: 10px;
    display: none;
  }

  .route-stats {
    display: flex;
    justify-content: space-around;
    margin-bottom: 8px;
  }

  .route-stat {
    text-align: center;
  }

  .route-stat-value {
    font-size: 18px;
    font-weight: bold;
  }

  .route-stat-label {
    font-size: 11px;
    opacity: 0.9;
  }

  /* Controles de capa */
  .layer-controls {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .control-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
  }

  .control-item input[type="checkbox"] {
    accent-color: #e74c3c;
  }

  /* Loading y mensajes */
  .loading-overlay {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    flex-direction: column;
  }

  .spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #e74c3c;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 10px;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .message {
    padding: 8px 12px;
    border-radius: 6px;
    margin: 8px 0;
    font-size: 13px;
    display: none;
  }

  .message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  .message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  /* Bot√≥n de mostrar panel (cuando est√° oculto) */
  #show-panel-btn {
    display: none;
    position: fixed;
    top: 66px;
    left: 15px;
    z-index: 2001;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    font-size: 18px;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
  }

  #show-panel-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
  }

  /* Efecto de entrada del bot√≥n hamburguesa */
  #show-panel-btn.show {
    display: flex;
    justify-content: center;
    align-items: center;
    animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
  }

  @keyframes bounceIn {
    0% {
      transform: scale(0) rotate(-180deg);
      opacity: 0;
    }
    50% {
      transform: scale(1.2) rotate(-90deg);
      opacity: 0.8;
    }
    100% {
      transform: scale(1) rotate(0deg);
      opacity: 1;
    }
  }

  /* Emojis m√°s grandes para estaciones */
  .station-marker {
    font-size: 24px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    border: 3px solid !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
    transition: all 0.3s ease !important;
    background: white !important;
    border-radius: 50% !important;
    width: 40px !important;
    height: 40px !important;
  }

  /* Tama√±os din√°micos seg√∫n zoom */
  .station-marker.zoom-close {
    width: 50px !important;
    height: 50px !important;
    font-size: 28px !important;
    border-width: 4px !important;
  }

  .station-marker.zoom-medium {
    width: 35px !important;
    height: 35px !important;
    font-size: 20px !important;
    border-width: 3px !important;
  }

  .station-marker.zoom-far {
    width: 25px !important;
    height: 25px !important;
    font-size: 14px !important;
    border-width: 2px !important;
  }

  /* Marcadores de origen y destino */
  .route-marker-origin {
    font-size: 36px !important;
    background: #27ae60 !important;
    border: 4px solid white !important;
    box-shadow: 0 0 20px rgba(39, 174, 96, 0.8) !important;
    animation: pulse-origin 2s infinite !important;
    border-radius: 50% !important;
    width: 60px !important;
    height: 60px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  .route-marker-destination {
    font-size: 36px !important;
    background: #e74c3c !important;
    border: 4px solid white !important;
    box-shadow: 0 0 20px rgba(231, 76, 60, 0.8) !important;
    animation: pulse-destination 2s infinite !important;
    border-radius: 50% !important;
    width: 60px !important;
    height: 60px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  @keyframes pulse-origin {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  @keyframes pulse-destination {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  /* Estilos personalizados para clusters de marcadores */
  .marker-cluster {
    background: rgba(52, 152, 219, 0.8) !important;
    border: 3px solid white !important;
    border-radius: 50% !important;
    color: white !important;
    font-weight: bold !important;
    font-size: 16px !important;
    text-align: center !important;
    line-height: 1 !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3) !important;
  }

  .marker-cluster-small {
    width: 40px !important;
    height: 40px !important;
    font-size: 14px !important;
  }

  .marker-cluster-medium {
    width: 50px !important;
    height: 50px !important;
    font-size: 18px !important;
  }

  .marker-cluster-large {
    width: 60px !important;
    height: 60px !important;
    font-size: 22px !important;
  }

  /* Estilos para tooltips de estaciones */
  .station-tooltip {
    background: rgba(0, 0, 0, 0.8) !important;
    color: white !important;
    border: none !important;
    border-radius: 8px !important;
    padding: 8px 12px !important;
    font-size: 13px !important;
    font-weight: bold !important;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
  }

  .station-tooltip::before {
    border-top-color: rgba(0, 0, 0, 0.8) !important;
  }

  /* Estilos para tooltips de clusters */
  .cluster-tooltip {
    background: rgba(255, 255, 255, 0.95) !important;
    color: #333 !important;
    border: 2px solid #0055a4 !important;
    border-radius: 8px !important;
    padding: 10px 15px !important;
    font-size: 12px !important;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
    max-width: 300px !important;
  }

  .cluster-tooltip::before {
    border-top-color: #0055a4 !important;
  }

  /* Bot√≥n de ubicaci√≥n flotante */
  #location-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #location-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
  }

  #location-btn:active {
    transform: scale(0.95);
  }

  /* Botones de ubicaci√≥n en el panel */
  .location-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-bottom: 8px;
  }

  .location-btn.primary {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
  }

  .location-btn.secondary {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
  }

  .location-btn.tertiary {
    background: linear-gradient(135deg, #f39c12, #e67e22);
    color: white;
  }

  .location-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
  }

  .location-btn:disabled {
    background: #95a5a6;
    cursor: not-allowed;
    transform: none;
  }

  /* Panel de capas */
  .layers-panel {
    background: rgba(255,255,255,0.97);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.10);
    padding: 16px;
    margin-bottom: 18px;
    transition: background 0.3s;
  }
  [data-theme="dark"] .layers-panel,
  [data-theme="nocturno"] .layers-panel {
    background: rgba(30,30,30,0.95);
    box-shadow: 0 4px 20px rgba(0,0,0,0.40);
  }
  .layers-buttons {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
  .layer-btn {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e6ed;
    border-radius: 8px;
    background: white;
    color: #333;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
  }
  [data-theme="dark"] .layer-btn,
  [data-theme="nocturno"] .layer-btn {
    background: #232323;
    border-color: #444;
    color: #e0e0e0;
  }
  .layer-btn.active {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    border-color: #27ae60;
  }
  .layer-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.10);
  }

  /* Quitar controles de zoom de Leaflet */
  .leaflet-control-zoom {
    display: none !important;
  }

  .leaflet-control-zoom-in,
  .leaflet-control-zoom-out {
    display: none !important;
  }

  /* Panel de informaci√≥n de estaci√≥n */
  .station-info-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.98);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    z-index: 3000;
    max-width: 400px;
    width: 90%;
    display: none;
    backdrop-filter: blur(10px);
    border: 2px solid #e74c3c;
  }

  .station-info-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 2px solid #e74c3c;
  }

  .station-info-title {
    font-size: 20px;
    font-weight: bold;
    color: #e74c3c;
  }

  .station-info-close {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .station-info-close:hover {
    transform: scale(1.1);
    background: #c0392b;
  }

  .station-info-content {
    margin-bottom: 20px;
  }

  .station-info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
  }

  .station-info-label {
    font-weight: 600;
    color: #333;
  }

  .station-info-value {
    color: #666;
    font-family: monospace;
  }

  .station-info-actions {
    display: flex;
    gap: 12px;
  }

  .station-info-btn {
    flex: 1;
    padding: 12px 16px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    text-align: center;
    display: inline-block;
  }

  .station-info-btn.primary {
    background: #e74c3c;
    color: white;
  }

  .station-info-btn.primary:hover {
    background: #c0392b;
    transform: translateY(-2px);
  }

  .station-info-btn.secondary {
    background: #3498db;
    color: white;
  }

  .station-info-btn.secondary:hover {
    background: #2980b9;
    transform: translateY(-2px);
  }
</style>
{% endblock %}

{% block content %}
<div id="map"></div>

<!-- Panel de control principal -->
<div id="control-panel">
  <div class="panel-header">
    <div class="panel-title">üó∫Ô∏è Calculadora de Rutas</div>
    <button id="hide-panel-btn">‚úï</button>
  </div>

  <!-- Secci√≥n de b√∫squeda de rutas -->
  <div class="panel-section">
    <div class="section-title">üîç Buscar Ruta</div>
    <div class="search-container">
      <div class="search-input-group">
        <input type="text" id="origen" class="search-input" placeholder="Estaci√≥n origen..." autocomplete="off">
        <div class="suggestions" id="origen-suggestions"></div>
      </div>
      <div class="search-input-group">
        <input type="text" id="destino" class="search-input" placeholder="Estaci√≥n destino..." autocomplete="off">
        <div class="suggestions" id="destino-suggestions"></div>
      </div>
      <button class="search-button" onclick="calcularRuta()" id="calc-btn">
        üöá Calcular Ruta √ìptima
      </button>
    </div>

    <div class="message error" id="error-message"></div>
    <div class="message success" id="success-message"></div>

    <!-- Informaci√≥n de la ruta calculada -->
    <div class="route-info" id="route-info">
      <div class="route-stats">
        <div class="route-stat">
          <div class="route-stat-value" id="route-time">--</div>
          <div class="route-stat-label">minutos</div>
        </div>
        <div class="route-stat">
          <div class="route-stat-value" id="route-transfers">--</div>
          <div class="route-stat-label">transbordos</div>
        </div>
        <div class="route-stat">
          <div class="route-stat-value" id="route-stations">--</div>
          <div class="route-stat-label">estaciones</div>
        </div>
      </div>
      <div style="font-size: 12px; text-align: center; opacity: 0.9;" id="route-algorithm">
        Algoritmo: <span id="algorithm-used">--</span>
      </div>
    </div>
  </div>

  <!-- Panel de ubicaci√≥n -->
  <div class="location-panel">
    <div class="section-title">üìç Tu ubicaci√≥n</div>
    <div class="location-buttons">
      <button class="location-btn primary" id="find-me-btn">
        üéØ Encontrar mi ubicaci√≥n
      </button>
      <button class="location-btn secondary" id="nearest-station-btn">
        üöá Estaci√≥n m√°s cercana
      </button>
      <button class="location-btn tertiary" id="nearby-stations-btn">
        üìç Estaciones cercanas
      </button>
    </div>
  </div>

  <!-- Panel de capas -->
  <div class="layers-panel">
    <div class="section-title">üéõÔ∏è Capas del mapa</div>
    <div class="layers-buttons">
      <button class="layer-btn active" id="toggle-stations-btn">
        üöâ Estaciones
      </button>
      <button class="layer-btn active" id="toggle-routes-btn">
        üöá L√≠neas
      </button>
      <button class="layer-btn" id="toggle-my-location-btn">
        üìç Mi ubicaci√≥n
      </button>
    </div>
  </div>

  <!-- Informaci√≥n del sistema -->
  <div class="panel-section">
    <div class="section-title">‚ÑπÔ∏è Estado del Sistema</div>
    <div style="font-size: 12px; line-height: 1.4;">
      <div><strong>Zoom:</strong> <span id="zoom-level">--</span></div>
      <div><strong>Centro:</strong> <span id="map-center">--</span></div>
      <div style="margin: 8px 0;">
        <button onclick="refreshMapData()" style="width: 100%; padding: 6px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
          üîÑ Actualizar Datos
        </button>
      </div>
      <div style="text-align: center; color: #666; font-size: 11px;" id="last-update">
        Sistema v5.0 - √öltima actualizaci√≥n: --
      </div>
    </div>
  </div>
</div>

<!-- Bot√≥n para mostrar panel cuando est√° oculto -->
<button id="show-panel-btn">‚ò∞</button>

<!-- Bot√≥n de ubicaci√≥n flotante -->
<button id="location-btn" title="Activar ubicaci√≥n">üìç</button>

<!-- Loading overlay -->
<div class="loading-overlay" id="loading-overlay">
  <div class="spinner"></div>
  <p>Calculando ruta √≥ptima...</p>
</div>

<!-- Panel de informaci√≥n de estaci√≥n -->
<div class="station-info-panel" id="station-info-panel">
  <div class="station-info-header">
    <div class="station-info-title">üöâ Informaci√≥n de Estaci√≥n</div>
    <button class="station-info-close" id="close-station-info">‚úï</button>
  </div>
  <div class="station-info-content">
    <div class="station-info-item">
      <span class="station-info-label">Nombre:</span>
      <span class="station-info-value" id="station-name">--</span>
    </div>
    <div class="station-info-item">
      <span class="station-info-label">ID:</span>
      <span class="station-info-value" id="station-id">--</span>
    </div>
    <div class="station-info-item">
      <span class="station-info-label">L√≠nea:</span>
      <span class="station-info-value" id="station-line">--</span>
    </div>
    <div class="station-info-item">
      <span class="station-info-label">Zona:</span>
      <span class="station-info-value" id="station-zone">--</span>
    </div>
  </div>
  <div class="station-info-actions">
    <a href="#" class="station-info-btn primary" id="go-to-station">üöá Ver Estaci√≥n</a>
    <button class="station-info-btn secondary" id="select-for-route">üéØ Seleccionar Ruta</button>
  </div>
</div>

<!-- Panel de ruta m√≥vil -->
<div class="mobile-route-panel" id="mobile-route-panel">
  <div class="mobile-route-header">
    <div class="mobile-route-title">üöá Ruta Calculada</div>
    <button class="mobile-route-close" id="close-mobile-route">‚úï</button>
  </div>
  <div class="mobile-route-stats">
    <div class="mobile-route-stat">
      <div class="mobile-route-stat-value" id="mobile-route-time">--</div>
      <div class="mobile-route-stat-label">minutos</div>
    </div>
    <div class="mobile-route-stat">
      <div class="mobile-route-stat-value" id="mobile-route-transfers">--</div>
      <div class="mobile-route-stat-label">transbordos</div>
    </div>
    <div class="mobile-route-stat">
      <div class="mobile-route-stat-value" id="mobile-route-stations">--</div>
      <div class="mobile-route-stat-label">estaciones</div>
    </div>
  </div>
  <div class="mobile-route-algorithm" id="mobile-route-algorithm">
    Algoritmo: <span id="mobile-algorithm-used">--</span>
  </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ========================================================================
    // 1. INICIALIZACI√ìN DEL MAPA Y VARIABLES GLOBALES
    // ========================================================================
    
    const map = L.map('map', {
        center: [40.4168, -3.7038],
        zoom: 12,
        minZoom: 10,
        maxZoom: 18
    });

    // Capas base del mapa
    const baseLayers = {
      dark: L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
        { attribution: "¬© CARTO" }
      ),
      classic: L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
        { attribution: "¬© CARTO" }
      ),
      clear: L.tileLayer(
        "https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png",
        { attribution: "¬© OpenStreetMap" }
      ),
    };

    // Funci√≥n para cambiar el estilo del mapa seg√∫n el tema
    function updateMapStyle(theme) {
        if (currentBaseLayer) map.removeLayer(currentBaseLayer);

        // Mapear temas a estilos de mapa
        const themeToStyle = {
            light: "classic",    // Tema claro -> Mapa cl√°sico
            dark: "dark",        // Tema oscuro -> Mapa oscuro
            nocturno: "dark"     // Tema nocturno -> Mapa oscuro
        };

        const mapStyle = themeToStyle[theme] || "classic";
        currentBaseLayer = baseLayers[mapStyle];
        currentBaseLayer.addTo(map);
    }

    // Detectar el tema actual al cargar la p√°gina
    const currentTheme = document.documentElement.getAttribute("data-theme") || "light";
    let currentBaseLayer = baseLayers[
        currentTheme === "dark" || currentTheme === "nocturno" ? "dark" : "classic"
    ];
    currentBaseLayer.addTo(map);

    // Escuchar cambios en el tema global
    document.addEventListener("themeChanged", function(e) {
        updateMapStyle(e.detail.theme);
    });

    // Variables globales
    const routeLayers = {};
    const lineColors = {
        "1":  { color: "#0065FE", name: "L√≠nea 1" },
        "2":  { color: "#FF0000", name: "L√≠nea 2" },
        "3":  { color: "#FFDF00", name: "L√≠nea 3" },
        "4":  { color: "#824100", name: "L√≠nea 4" },
        "5":  { color: "#339900", name: "L√≠nea 5" },
        "6":  { color: "#999999", name: "L√≠nea 6" },
        "7":  { color: "#FF6600", name: "L√≠nea 7" },
        "8":  { color: "#FF75FF", name: "L√≠nea 8" },
        "9":  { color: "#990066", name: "L√≠nea 9" },
        "10": { color: "#000099", name: "L√≠nea 10" },
        "11": { color: "#006600", name: "L√≠nea 11" },
        "12": { color: "#a49a00", name: "L√≠nea 12" },
        "R":  { color: "#0055a4", name: "Ramal" }
    };
    let stationClusterLayer = L.markerClusterGroup({
        chunkedLoading: true,
        maxClusterRadius: 60,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        disableClusteringAtZoom: 16,
        iconCreateFunction: function(cluster) {
            const markers = cluster.getAllChildMarkers();
            // Cuenta cu√°ntos hay de cada l√≠nea principal
            const lineCounts = {};
            markers.forEach(marker => {
                let lines = marker.stationData && marker.stationData.lines ? Array.from(marker.stationData.lines) : [];
                lines.forEach(line => {
                    // Normaliza el identificador de l√≠nea
                    let lineId = String(line).replace('L√≠nea ', '').replace(' ', '').toUpperCase();
                    lineCounts[lineId] = (lineCounts[lineId] || 0) + 1;
                });
            });
            // Elige la l√≠nea con m√°s estaciones en el cluster
            let mainLine = Object.keys(lineCounts).sort((a, b) => lineCounts[b] - lineCounts[a])[0] || "1";
            let color = lineColors[mainLine] ? lineColors[mainLine].color : "#666666";

            return L.divIcon({
                html: `<div style="
                    background-color: ${color};
                    color: white;
                    border: 3px solid white;
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: bold;
                    font-size: 14px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                ">${markers.length}</div>`,
                className: 'marker-cluster',
                iconSize: L.point(40, 40)
            });
        }
    });
    let currentRouteLayer = L.layerGroup();
    let estaciones = [];
    let routeMarkers = [];

    // ========================================================================
    // 2. FUNCIONES DE CARGA DE DATOS
    // ========================================================================

    async function loadAllData() {
        try {
            console.log('üîÑ Cargando datos del sistema...');
            
            const [routesResponse, stationsResponse] = await Promise.all([
                fetch('/static/data/metro_routes.json?v=' + new Date().getTime()),
                fetch('/api/stations/all?v=' + new Date().getTime())
            ]);

            if (!routesResponse.ok || !stationsResponse.ok) {
                throw new Error('Error al cargar datos del servidor');
            }

            const routesData = await routesResponse.json();
            const stationsData = await stationsResponse.json();

            // Procesar l√≠neas y rutas
            if (routesData.lines && Array.isArray(routesData.lines)) {
                routesData.lines.forEach(line => {
                    const lineId = line.line;
                    const lineColor = line.color || '#666666';
                    const lineName = line.name || `L√≠nea ${lineId}`;

                    lineColors[lineId] = { color: lineColor, name: lineName };

                    if (!routeLayers[lineId]) {
                        routeLayers[lineId] = L.layerGroup();
                    }

                    if (line.paths && Array.isArray(line.paths)) {
                        line.paths.forEach(path => {
                            const latLngs = path.map(coord => [coord[0], coord[1]]);
                            if (latLngs.length < 2) return;

                            const polyline = L.polyline(latLngs, {
                                color: lineColor,
                                weight: 4,
                                opacity: 0.7
                            });

                            polyline.bindTooltip(`${lineName}`, {
                                sticky: true,
                                className: 'route-tooltip'
                            });

                            routeLayers[lineId].addLayer(polyline);
                        });
                    }
                });

                Object.values(routeLayers).forEach(layer => layer.addTo(map));
            }

            // Procesar estaciones
            if (Array.isArray(stationsData)) {
                estaciones = stationsData;
                drawStations(stationsData);
            }

            updateLastUpdateTime();
            console.log('‚úÖ Datos cargados correctamente');

        } catch (error) {
            console.error('‚ùå Error cargando datos:', error);
            showMessage('Error al cargar los datos del mapa', 'error');
        }
    }

    function drawStations(stations) {
        stationClusterLayer.clearLayers();
        const stationsByName = {};
        stations.forEach(station => {
            if (!station.lat || !station.lon) return;
            const stationName = station.name;
            if (!stationsByName[stationName]) {
                stationsByName[stationName] = {
                    name: stationName,
                    lat: station.lat,
                    lon: station.lon,
                    lines: new Set(),
                    id_fijo: station.id,
                    zone: station.zone || 'A'
                };
            }
            stationsByName[stationName].lines.add(station.line);
        });
        Object.values(stationsByName).forEach(stationData => {
            // Normaliza y elige la l√≠nea principal (menor n√∫mero)
            const linesArray = Array.from(stationData.lines).map(l => String(l).replace('L√≠nea ', '').replace(' ', '').toUpperCase());
            const mainLine = linesArray.sort((a, b) => Number(a) - Number(b))[0];
            const lineConfig = lineColors[mainLine] || { color: '#666666' };
            // Tama√±os m√°s peque√±os
            const zoom = map.getZoom();
            let markerClass = 'station-marker';
            let iconSize = [4, 4];
            if (zoom >= 14) {
                markerClass += ' zoom-close';
                iconSize = [2, 2];
            } else if (zoom >= 12) {
                markerClass += ' zoom-medium';
                iconSize = [1, 1];
            } else {
                markerClass += ' zoom-far';
                iconSize = [0, 0];
            }
            // Crear marcador como c√≠rculo blanco con borde de color
            const marker = L.divIcon({
                className: markerClass,
                html: `<div style="
                    width: ${iconSize[0] - 6}px;
                    height: ${iconSize[1] - 6}px;
                    border-radius: 50%;
                    background: #fff;
                    border: 3px solid ${lineConfig.color};
                    box-shadow: 0 2px 6px rgba(0,0,0,0.10);
                    margin: auto;
                    display: block;
                "></div>`,
                iconSize: iconSize,
                iconAnchor: [iconSize[0]/2, iconSize[1]/2]
            });
            const stationMarker = L.marker([stationData.lat, stationData.lon], {
                icon: marker
            });
            stationMarker.stationData = stationData;
            stationMarker.clickCount = 0;
            stationMarker.clickTimer = null;
            // L√≥gica de click y doble click
            stationMarker.on('click', function(e) {
                this.clickCount++;
                if (this.clickCount === 1) {
                    this.clickTimer = setTimeout(() => {
                        showStationInfo(stationData);
                        this.clickCount = 0;
                    }, 200);
                } else if (this.clickCount === 2) {
                    clearTimeout(this.clickTimer);
                    selectStationForRoute(stationData);
                    this.clickCount = 0;
                }
            });
            stationMarker.bindTooltip(
                `${stationData.name}<br><strong>L√≠neas:</strong> ${linesArray.join(', ')}<br><small>Click: Info | Doble click: Ruta</small>`,
                {
                    permanent: false,
                    direction: 'top',
                    offset: [0, -10],
                    className: 'station-tooltip'
                }
            );
            stationClusterLayer.addLayer(stationMarker);
        });
        map.addLayer(stationClusterLayer);
    }

    // ========================================================================
    // 3. AUTOCOMPLETADO Y B√öSQUEDA
    // ========================================================================

    function setupAutocomplete() {
        const origenInput = document.getElementById('origen');
        const destinoInput = document.getElementById('destino');
        const origenSuggestions = document.getElementById('origen-suggestions');
        const destinoSuggestions = document.getElementById('destino-suggestions');

        function setupInputAutocomplete(input, suggestionsDiv) {
            input.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 2) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                const uniqueStations = [...new Set(estaciones.map(e => e.name))]
                    .filter(name => name.toLowerCase().includes(query))
                    .sort()
                    .slice(0, 8);

                if (uniqueStations.length === 0) {
                    suggestionsDiv.style.display = 'none';
                    return;
                }

                suggestionsDiv.innerHTML = uniqueStations
                    .map(name => `<div class="suggestion-item" onclick="selectStation('${input.id}', '${name}')">${name}</div>`)
                    .join('');
                
                suggestionsDiv.style.display = 'block';
            });

            input.addEventListener('blur', function() {
                setTimeout(() => {
                    suggestionsDiv.style.display = 'none';
                }, 150);
            });
        }

        setupInputAutocomplete(origenInput, origenSuggestions);
        setupInputAutocomplete(destinoInput, destinoSuggestions);
    }

    window.selectStation = function(inputId, stationName) {
        document.getElementById(inputId).value = stationName;
        document.getElementById(inputId + '-suggestions').style.display = 'none';
    };

    // ========================================================================
    // 4. C√ÅLCULO Y VISUALIZACI√ìN DE RUTAS
    // ========================================================================

    window.calcularRuta = async function() {
        const origen = document.getElementById('origen').value.trim();
        const destino = document.getElementById('destino').value.trim();

        if (!origen || !destino) {
            showMessage('Por favor, ingresa estaci√≥n de origen y destino', 'error');
            return;
        }

        if (origen === destino) {
            showMessage('La estaci√≥n de origen y destino no pueden ser iguales', 'error');
            return;
        }

        const loadingOverlay = document.getElementById('loading-overlay');
        const calcBtn = document.getElementById('calc-btn');
        
        loadingOverlay.style.display = 'flex';
        calcBtn.disabled = true;

        try {
            console.log(`üöá Calculando ruta: ${origen} ‚Üí ${destino}`);
            
            const response = await fetch(`/api/v5/route?origen=${encodeURIComponent(origen)}&destino=${encodeURIComponent(destino)}&algoritmo=dijkstra_bidirectional&optimizacion=min_time`);
            const data = await response.json();

            if (data.success) {
                const ruta = data.data.ruta;
                showMessage(`Ruta calculada: ${ruta.tiempo_total} min, ${ruta.transbordos} transbordos`, 'success');
                
                // Mostrar informaci√≥n de la ruta
                document.getElementById('route-time').textContent = Math.round(ruta.tiempo_total * 10) / 10;
                document.getElementById('route-transfers').textContent = ruta.transbordos;
                document.getElementById('route-stations').textContent = ruta.estaciones;
                document.getElementById('algorithm-used').textContent = ruta.algoritmo;
                document.getElementById('route-info').style.display = 'block';

                // Mostrar panel m√≥vil en dispositivos m√≥viles
                if (window.innerWidth <= 768) {
                    document.getElementById('mobile-route-time').textContent = Math.round(ruta.tiempo_total * 10) / 10;
                    document.getElementById('mobile-route-transfers').textContent = ruta.transbordos;
                    document.getElementById('mobile-route-stations').textContent = ruta.estaciones;
                    document.getElementById('mobile-algorithm-used').textContent = ruta.algoritmo;
                    document.getElementById('mobile-route-panel').classList.add('show');
                }

                // Visualizar ruta en el mapa
                visualizeRoute(data.data);
            } else {
                showMessage('Error: ' + data.error, 'error');
            }

        } catch (error) {
            console.error('‚ùå Error calculando ruta:', error);
            showMessage('Error conectando con el servidor', 'error');
        } finally {
            loadingOverlay.style.display = 'none';
            calcBtn.disabled = false;
        }
    };

    function visualizeRoute(routeData) {
        // Limpiar ruta anterior
        currentRouteLayer.clearLayers();
        
        if (!routeData.ruta.path || routeData.ruta.path.length === 0) {
            console.warn('No hay path en la ruta');
            return;
        }

        const path = routeData.ruta.path;
        let bounds = L.latLngBounds();

        // Crear marcadores para origen, destino y transbordos
        path.forEach((step, index) => {
            if (!step.coordenadas || step.coordenadas.length !== 2) return;

            const [lat, lon] = step.coordenadas;
            bounds.extend([lat, lon]);

            let markerClass = 'station-marker';
            let tooltipText = step.estacion;

            if (index === 0) {
                markerClass = 'route-marker-origin';
                tooltipText = `üöÄ ${step.estacion} (Origen)`;
            } else if (index === path.length - 1) {
                markerClass = 'route-marker-destination';
                tooltipText = `üéØ ${step.estacion} (Destino)`;
            } else if (step.es_transbordo) {
                markerClass = 'route-marker-transfer';
                tooltipText = `üîÑ ${step.estacion} (Transbordo)`;
            }

            const marker = L.circleMarker([lat, lon], {
                radius: index === 0 || index === path.length - 1 ? 10 : 7,
                className: markerClass,
                fillOpacity: 1
            });

            marker.bindTooltip(tooltipText, {
                permanent: false,
                direction: 'top',
                className: 'route-tooltip'
            });

            currentRouteLayer.addLayer(marker);
        });

        // Crear l√≠neas de la ruta
        for (let i = 0; i < path.length - 1; i++) {
            const current = path[i];
            const next = path[i + 1];

            if (!current.coordenadas || !next.coordenadas) continue;

            const currentLineColor = lineColors[current.linea]?.color || '#e74c3c';
            
            const routeLine = L.polyline([current.coordenadas, next.coordenadas], {
                color: currentLineColor,
                weight: 6,
                opacity: 0.8,
                dashArray: current.es_transbordo ? '10, 5' : null
            });

            currentRouteLayer.addLayer(routeLine);
        }

        // A√±adir al mapa y ajustar vista
        if (document.getElementById('toggleRoute').checked) {
            currentRouteLayer.addTo(map);
        }

        if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [20, 20] });
        }

        console.log('‚úÖ Ruta visualizada en el mapa');
    }

    // ========================================================================
    // 5. FUNCIONALIDAD DE UBICACI√ìN
    // ========================================================================

    let userLocationMarker = null;
    let userLocationCircle = null;

    // Obtener ubicaci√≥n del usuario
    function getUserLocation() {
        if (!navigator.geolocation) {
            showMessage('La geolocalizaci√≥n no est√° disponible en tu navegador', 'error');
            return;
        }

        const locationBtn = document.getElementById('location-btn');
        locationBtn.innerHTML = '‚è≥';
        locationBtn.disabled = true;

        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;

                // Centrar mapa en la ubicaci√≥n del usuario
                map.setView([lat, lng], 15);

                // Crear marcador de ubicaci√≥n
                if (userLocationMarker) {
                    map.removeLayer(userLocationMarker);
                }
                if (userLocationCircle) {
                    map.removeLayer(userLocationCircle);
                }

                userLocationMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-location-marker',
                        html: 'üìç',
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);

                userLocationCircle = L.circle([lat, lng], {
                    color: '#e74c3c',
                    fillColor: '#e74c3c',
                    fillOpacity: 0.2,
                    radius: accuracy
                }).addTo(map);

                showMessage(`Ubicaci√≥n encontrada (precisi√≥n: ${Math.round(accuracy)}m)`, 'success');
                
                // Activar bot√≥n de ubicaci√≥n
                document.getElementById('toggle-my-location-btn').classList.add('active');
                
                locationBtn.innerHTML = 'üìç';
                locationBtn.disabled = false;
            },
            function(error) {
                let errorMessage = 'Error al obtener tu ubicaci√≥n';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Permiso denegado para acceder a la ubicaci√≥n';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Informaci√≥n de ubicaci√≥n no disponible';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Tiempo de espera agotado para obtener ubicaci√≥n';
                        break;
                }
                showMessage(errorMessage, 'error');
                
                locationBtn.innerHTML = 'üìç';
                locationBtn.disabled = false;
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 60000
            }
        );
    }

    // Encontrar estaci√≥n m√°s cercana
    function findNearestStation() {
        if (!userLocationMarker) {
            showMessage('Primero activa tu ubicaci√≥n', 'error');
            return;
        }

        const userLatLng = userLocationMarker.getLatLng();
        let nearestStation = null;
        let minDistance = Infinity;

        estaciones.forEach(station => {
            if (station.lat && station.lon) {
                const distance = userLatLng.distanceTo([station.lat, station.lon]);
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestStation = station;
                }
            }
        });

        if (nearestStation) {
            // Centrar en la estaci√≥n m√°s cercana
            map.setView([nearestStation.lat, nearestStation.lon], 16);
            
            // Resaltar la estaci√≥n
            const marker = L.circleMarker([nearestStation.lat, nearestStation.lon], {
                radius: 12,
                fillColor: '#27ae60',
                color: '#fff',
                weight: 3,
                fillOpacity: 0.8
            }).addTo(map);

            marker.bindTooltip(
                `üöá Estaci√≥n m√°s cercana: ${nearestStation.name}<br>Distancia: ${Math.round(minDistance)}m`,
                { permanent: true, className: 'station-tooltip' }
            );

            setTimeout(() => {
                map.removeLayer(marker);
            }, 5000);

            showMessage(`Estaci√≥n m√°s cercana: ${nearestStation.name} (${Math.round(minDistance)}m)`, 'success');
        }
    }

    // Encontrar estaciones cercanas
    function findNearbyStations() {
        if (!userLocationMarker) {
            showMessage('Primero activa tu ubicaci√≥n', 'error');
            return;
        }

        const userLatLng = userLocationMarker.getLatLng();
        const nearbyStations = [];
        const maxDistance = 1000; // 1km

        estaciones.forEach(station => {
            if (station.lat && station.lon) {
                const distance = userLatLng.distanceTo([station.lat, station.lon]);
                if (distance <= maxDistance) {
                    nearbyStations.push({ ...station, distance });
                }
            }
        });

        nearbyStations.sort((a, b) => a.distance - b.distance);

        if (nearbyStations.length > 0) {
            // Mostrar las 5 estaciones m√°s cercanas
            const topStations = nearbyStations.slice(0, 5);
            
            topStations.forEach(station => {
                const marker = L.circleMarker([station.lat, station.lon], {
                    radius: 8,
                    fillColor: '#3498db',
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 0.8
                }).addTo(map);

                marker.bindTooltip(
                    `${station.name}<br>${Math.round(station.distance)}m`,
                    { permanent: false, className: 'station-tooltip' }
                );
            });

            showMessage(`Encontradas ${nearbyStations.length} estaciones en 1km`, 'success');
        } else {
            showMessage('No hay estaciones cercanas en 1km', 'error');
        }
    }

    // ========================================================================
    // 6. CONTROLES DE CAPAS
    // ========================================================================

    function setupLayerControls() {
        // Bot√≥n de estaciones
        document.getElementById('toggle-stations-btn').addEventListener('click', function() {
            this.classList.toggle('active');
            if (this.classList.contains('active')) {
                map.addLayer(stationClusterLayer);
            } else {
                map.removeLayer(stationClusterLayer);
            }
        });

        // Bot√≥n de l√≠neas
        document.getElementById('toggle-routes-btn').addEventListener('click', function() {
            this.classList.toggle('active');
            Object.values(routeLayers).forEach(layer => {
                if (this.classList.contains('active')) {
                    map.addLayer(layer);
                } else {
                    map.removeLayer(layer);
                }
            });
        });

        // Bot√≥n de mi ubicaci√≥n
        document.getElementById('toggle-my-location-btn').addEventListener('click', function() {
            this.classList.toggle('active');
            if (this.classList.contains('active')) {
                if (userLocationMarker) {
                    map.addLayer(userLocationMarker);
                    if (userLocationCircle) map.addLayer(userLocationCircle);
                } else {
                    getUserLocation();
                }
            } else {
                if (userLocationMarker) {
                    map.removeLayer(userLocationMarker);
                    if (userLocationCircle) map.removeLayer(userLocationCircle);
                }
            }
        });
    }

    // ========================================================================
    // 7. EVENT LISTENERS
    // ========================================================================

    function setupEventListeners() {
        // Botones de ubicaci√≥n
        document.getElementById('find-me-btn').addEventListener('click', getUserLocation);
        document.getElementById('nearest-station-btn').addEventListener('click', findNearestStation);
        document.getElementById('nearby-stations-btn').addEventListener('click', findNearbyStations);
        
        // Bot√≥n flotante de ubicaci√≥n
        document.getElementById('location-btn').addEventListener('click', getUserLocation);

        // Controles de capas
        setupLayerControls();

        // Panel de control
        document.getElementById('hide-panel-btn').addEventListener('click', function() {
            document.getElementById('control-panel').classList.add('hidden');
            document.getElementById('show-panel-btn').classList.add('show');
        });

        document.getElementById('show-panel-btn').addEventListener('click', function() {
            document.getElementById('control-panel').classList.remove('hidden');
            this.classList.remove('show');
        });

        // Panel de informaci√≥n de estaci√≥n
        document.getElementById('close-station-info').addEventListener('click', function() {
            document.getElementById('station-info-panel').style.display = 'none';
        });

        document.getElementById('select-for-route').addEventListener('click', function() {
            const stationName = document.getElementById('station-name').textContent;
            const stationData = estaciones.find(s => s.name === stationName);
            if (stationData) {
                selectStationForRoute(stationData);
                document.getElementById('station-info-panel').style.display = 'none';
            }
        });

        // Panel de ruta m√≥vil
        document.getElementById('close-mobile-route').addEventListener('click', function() {
            document.getElementById('mobile-route-panel').classList.remove('show');
        });

        // Cerrar panel al hacer click fuera
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('station-info-panel');
            if (e.target === panel) {
                panel.style.display = 'none';
            }
            
            const mobilePanel = document.getElementById('mobile-route-panel');
            if (e.target === mobilePanel) {
                mobilePanel.classList.remove('show');
            }
        });

        // Eventos del mapa
        map.on('moveend', updateMapInfo);
        map.on('zoomend', updateMapInfo);
        map.on('zoomend', updateMarkerSizes);

        // Tecla Enter para calcular ruta
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const activeElement = document.activeElement;
                if (activeElement && (activeElement.id === 'origen' || activeElement.id === 'destino')) {
                    calcularRuta();
                }
            }
        });
    }

    // ========================================================================
    // 8. UTILIDADES Y FUNCIONES AUXILIARES
    // ========================================================================

    function showMessage(text, type) {
        const errorMsg = document.getElementById('error-message');
        const successMsg = document.getElementById('success-message');
        
        errorMsg.style.display = 'none';
        successMsg.style.display = 'none';

        if (type === 'error') {
            errorMsg.textContent = text;
            errorMsg.style.display = 'block';
        } else {
            successMsg.textContent = text;
            successMsg.style.display = 'block';
        }

        // Auto-ocultar mensajes despu√©s de 5 segundos
        setTimeout(() => {
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
        }, 5000);
    }

    function updateLastUpdateTime() {
        document.getElementById('last-update').textContent = 
            `Sistema v5.0 - Actualizada: ${new Date().toLocaleTimeString()}`;
    }

    function updateMapInfo() {
        const center = map.getCenter();
        document.getElementById('map-center').textContent = 
            `${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}`;
        document.getElementById('zoom-level').textContent = map.getZoom();
    }

    window.refreshMapData = function() {
        loadAllData();
    };

    // ========================================================================
    // 8. PANEL DE INFORMACI√ìN DE ESTACI√ìN
    // ========================================================================

    let selectedOrigin = null;
    let selectedDestination = null;
    let originMarker = null;
    let destinationMarker = null;

    function showStationInfo(stationData) {
        // Llenar informaci√≥n en el panel
        document.getElementById('station-name').textContent = stationData.name;
        document.getElementById('station-id').textContent = stationData.id_fijo;
        document.getElementById('station-line').textContent = Array.from(stationData.lines).join(', ');
        document.getElementById('station-zone').textContent = stationData.zone;

        // Configurar enlaces
        const mainLine = Array.from(stationData.lines)[0];
        document.getElementById('go-to-station').href = `/station/${mainLine}/${stationData.id_fijo}`;
        
        // Mostrar panel
        document.getElementById('station-info-panel').style.display = 'block';
    }

    function selectStationForRoute(stationData) {
        if (!selectedOrigin) {
            // Primera selecci√≥n - Origen
            selectedOrigin = stationData;
            createRouteMarker(stationData, 'origin');
            showMessage(`üöÄ Origen seleccionado: ${stationData.name}`, 'success');
        } else if (!selectedDestination) {
            // Segunda selecci√≥n - Destino
            selectedDestination = stationData;
            createRouteMarker(stationData, 'destination');
            showMessage(`üéØ Destino seleccionado: ${stationData.name}`, 'success');
            
            // Calcular ruta autom√°ticamente
            setTimeout(() => {
                calcularRutaConSeleccion();
            }, 500);
        } else {
            // Tercera selecci√≥n - Resetear y seleccionar nuevo origen
            clearRouteSelection();
            selectedOrigin = stationData;
            createRouteMarker(stationData, 'origin');
            showMessage(`üöÄ Nuevo origen seleccionado: ${stationData.name}`, 'success');
        }

        // Actualizar inputs del formulario
        updateRouteInputs();
    }

    function createRouteMarker(stationData, type) {
        const icon = L.divIcon({
            className: `route-marker-${type}`,
            html: type === 'origin' ? 'üöÄ' : 'üéØ',
            iconSize: [50, 50],
            iconAnchor: [25, 25]
        });

        const marker = L.marker([stationData.lat, stationData.lon], {
            icon: icon,
            zIndexOffset: 1000
        }).addTo(map);

        if (type === 'origin') {
            originMarker = marker;
        } else {
            destinationMarker = marker;
        }

        marker.bindTooltip(
            `${type === 'origin' ? 'üöÄ Origen' : 'üéØ Destino'}: ${stationData.name}`,
            { permanent: true, className: 'station-tooltip' }
        );
    }

    function clearRouteSelection() {
        selectedOrigin = null;
        selectedDestination = null;
        
        if (originMarker) {
            map.removeLayer(originMarker);
            originMarker = null;
        }
        
        if (destinationMarker) {
            map.removeLayer(destinationMarker);
            destinationMarker = null;
        }
    }

    function updateRouteInputs() {
        if (selectedOrigin) {
            document.getElementById('origen').value = selectedOrigin.name;
        }
        if (selectedDestination) {
            document.getElementById('destino').value = selectedDestination.name;
        }
    }

    function calcularRutaConSeleccion() {
        if (selectedOrigin && selectedDestination) {
            document.getElementById('origen').value = selectedOrigin.name;
            document.getElementById('destino').value = selectedDestination.name;
            calcularRuta();
        }
    }

    // Funci√≥n para actualizar tama√±os de marcadores seg√∫n zoom
    function updateMarkerSizes() {
        const zoom = map.getZoom();
        const markers = stationClusterLayer.getLayers();
        
        markers.forEach(marker => {
            if (marker.getElement) {
                const element = marker.getElement();
                if (element) {
                    // Remover clases anteriores
                    element.className = element.className.replace(/zoom-\w+/g, '');
                    
                    // A√±adir nueva clase seg√∫n zoom
                    if (zoom >= 14) {
                        element.classList.add('zoom-close');
                    } else if (zoom >= 12) {
                        element.classList.add('zoom-medium');
                    } else {
                        element.classList.add('zoom-far');
                    }
                }
            }
        });
    }

    // ========================================================================
    // 9. INICIALIZACI√ìN
    // ========================================================================

    // Inicializar todo
    loadAllData();
    setupAutocomplete();
    updateMapInfo();
    setupEventListeners();

    console.log('üöá Sistema de Mapa de Rutas v5.0 inicializado correctamente');
});
</script>
{% endblock %}