<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro Madrid - Informaci√≥n de Estaci√≥n</title>
    
    <!-- Favicon con logo del Metro de Madrid -->
    <link rel="icon" type="image/png" href="/static/logos/Logomarca_azul.png">
    <link rel="shortcut icon" type="image/png" href="/static/logos/Logomarca_azul.png">
    <link rel="apple-touch-icon" href="/static/logos/Logomarca_azul.png">
    
    <!-- Archivos CSS -->
    <link rel="stylesheet" href="/static/css/modern-trains.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/train_times.css') }}">
    
    <style>
        /* Variables CSS para temas */
        :root {
            --bg-primary: #f7f7f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f9fa;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #e9ecef;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --metro-main: #0065FE;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .main-content {
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 2.5em;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .page-header p {
            font-size: 1.2em;
            color: var(--text-secondary);
        }

        /* Secci√≥n de b√∫squeda */
        .search-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .search-container-centered {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        .search-title {
            color: var(--metro-main);
            margin-bottom: 25px;
            font-size: 2em;
            font-weight: 700;
        }

        .search-form-centered {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .search-input-container {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-input-container input {
            width: 100%;
            padding: 18px 20px;
            border: 3px solid var(--border-color);
            border-radius: 25px;
            font-size: 18px;
            transition: all 0.3s ease;
            background: var(--bg-tertiary);
            box-shadow: var(--shadow);
            color: var(--text-primary);
        }

        .search-input-container input:focus {
            outline: none;
            border-color: var(--metro-main);
            background: var(--bg-secondary);
            box-shadow: 0 4px 20px rgba(0,174,239,0.2);
            transform: translateY(-2px);
        }

        .search-btn-rocket {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--metro-main) 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .search-btn-rocket:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .search-tips {
            color: var(--text-secondary);
            font-size: 0.95em;
            line-height: 1.5;
            margin: 0;
            opacity: 0.8;
        }

        /* Autocompletado */
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 3px solid var(--metro-main);
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: none;
        }

        .autocomplete-item {
            padding: 18px 20px;
            cursor: pointer;
            border-bottom: 2px solid var(--border-color);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            color: var(--text-primary);
        }

        .autocomplete-item:hover {
            background: var(--bg-tertiary);
        }

        .autocomplete-item.selected {
            background: var(--metro-main);
            color: white;
        }

        .autocomplete-item .station-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .autocomplete-item .station-lines {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* Informaci√≥n de estaci√≥n */
        .station-info {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: none;
            border: 1px solid var(--border-color);
        }

        .station-info.show {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .station-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .station-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-right: 20px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .station-details {
            flex: 1;
        }

        .station-actions {
            margin-left: auto;
        }

        .refresh-btn {
            background: #333333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: #555555;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .station-details h3 {
            font-size: 1.8em;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-weight: 700;
        }

        .station-details p {
            color: var(--text-secondary);
            font-size: 1.1em;
            margin: 0;
        }

        .station-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .status-operativa {
            background: #4CAF50;
        }

        .status-cerrada {
            background: #f44336;
        }

        /* Resultados de b√∫squeda */
        .search-results-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid var(--metro-main);
        }

        .search-results-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .search-results-header h3 {
            color: var(--metro-main);
            font-size: 1.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .search-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .search-result-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 80px;
        }

        .search-result-item:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: var(--metro-main);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .result-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .result-icon img {
            width: 35px;
            height: 35px;
            filter: drop-shadow(0 1px 3px rgba(0,0,0,0.2));
        }

        .line-number {
            background: var(--metro-main);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .result-info {
            flex: 1;
            min-width: 0;
        }

        .result-info h4 {
            color: var(--text-primary);
            font-size: 1.2em;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .result-info p {
            color: var(--text-secondary);
            font-size: 0.95em;
            margin: 0;
        }

        .result-arrow {
            font-size: 24px;
            color: var(--metro-main);
            font-weight: bold;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .search-result-item:hover .result-arrow {
            opacity: 1;
            transform: translateX(5px);
        }

        /* Informaci√≥n detallada */
        .detailed-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .info-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--metro-main);
        }

        .info-card h5 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
        }

        .line-data-header {
            background: var(--metro-main);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        /* L√≠neas */
        .lines-section {
            margin-bottom: 25px;
        }

        .lines-section h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .lines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .line-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .line-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .line-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .line-header .line-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .line-header .line-info img {
            width: 24px;
            height: 24px;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        .line-header .line-info strong {
            font-size: 1.2em;
            font-weight: 700;
        }

        .directions-count {
            background: var(--metro-main);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .directions-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .line-direction {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid;
            transition: all 0.3s ease;
        }

        .line-direction:hover {
            background: var(--bg-secondary);
            transform: translateX(5px);
        }

        .direction-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .direction-icon {
            font-size: 1.1em;
        }

        .direction-name {
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .line-name {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .line-name img {
            width: 18px;
            height: 18px;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        .line-destination {
            font-size: 0.95em;
            color: var(--text-secondary);
        }

        .line-destination strong {
            color: var(--text-primary);
        }

        /* Estados y utilidades */
        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--metro-main);
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--metro-main);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #ffe6e6;
            border: 1px solid #ffcccc;
            color: #cc0000;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .last-updated {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            color: #0066cc;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .footer {
            text-align: center;
            margin-top: 60px;
            padding: 20px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .search-form-centered {
                flex-direction: column;
            }
            
            .station-header {
                flex-direction: column;
                text-align: center;
            }
            
            .station-icon {
                margin-right: 0;
                margin-bottom: 15px;
            }

            .detailed-info {
                grid-template-columns: 1fr;
            }

            .search-results-grid {
                grid-template-columns: 1fr;
            }
            
            .search-result-item {
                padding: 15px;
                min-height: 70px;
            }
            
            .result-icon {
                width: 40px;
                height: 40px;
            }
            
            .result-icon img {
                width: 28px;
                height: 28px;
            }

            .lines-grid {
                grid-template-columns: 1fr;
            }
            
            .line-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .directions-container {
                gap: 10px;
            }
            
            .line-direction {
                padding: 12px;
            }
        }

        /* Secci√≥n de Modelo 3D */
        .model-3d-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .model-3d-section h4 {
            color: var(--text-primary);
            font-size: 1.5em;
            margin-bottom: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .model-3d-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .model-3d-image-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            background: #f0f2f5;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .model-3d-image {
            max-width: 750px;
            max-height: 100%;
            object-fit: cover;
            border-radius: 0;
            box-shadow: none;
        }

     

        .model-3d-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .model-3d-station-name {
            font-size: 1.1em;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7);
        }

        .model-3d-line-info {
            font-size: 0.85em;
            opacity: 0.95;
            text-shadow: 0 1px 2px rgba(0,0,0,0.7);
        }

        .model-3d-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .model-3d-btn {
            background: var(--metro-main);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .model-3d-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .model-3d-btn:active {
            transform: translateY(0);
        }

        .model-3d-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Responsive para modelos 3D */
        @media (max-width: 768px) {
            .model-3d-image-container {
                aspect-ratio: 1 / 1; /* Mantiene el cuadrado en m√≥vil */
            }
            
            .model-3d-image {
                height: 300px;
            }
            
            .model-3d-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .model-3d-btn {
                width: 100%;
                max-width: 200px;
            }
        }

        /* Animaci√≥n de carga para modelo 3D */
        .model-3d-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .model-3d-loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--metro-main);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos adicionales para modelos 3D */
        .model-3d-not-available {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 2px dashed var(--border-color);
        }

        .model-3d-placeholder {
            text-align: center;
            padding: 40px;
            max-width: 400px;
        }

        .model-3d-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .model-3d-placeholder h4 {
            color: var(--text-primary);
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .model-3d-placeholder p {
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .model-3d-download-btn {
            background: var(--metro-main);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .model-3d-download-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .model-3d-source {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 15px;
        }

        .model-3d-source a {
            color: var(--metro-main);
            text-decoration: none;
            font-weight: 600;
        }

        .model-3d-source a:hover {
            text-decoration: underline;
        }

        .model-3d-error {
            text-align: center;
            padding: 40px;
            max-width: 400px;
        }

        .model-3d-error .model-3d-icon {
            font-size: 3em;
            margin-bottom: 20px;
            color: #f44336;
        }

        .model-3d-error h4 {
            color: #f44336;
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .model-3d-error p {
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    {% include 'header.html' %}

    <div class="main-content">
        <div class="page-header">
            <h1>
                <img src="/static/logos/MetroMadridLogo_10.svg" alt="Metro de Madrid" class="header-icon">
                Informaci√≥n de Estaci√≥n
            </h1>
            <p>Consulta datos en tiempo real de cualquier estaci√≥n del Metro de Madrid</p>
        </div>

        <!-- Secci√≥n de b√∫squeda -->
        <div class="search-section">
            <div class="search-container-centered">
                <h2 class="search-title">Buscar Estaci√≥n</h2>
                <form id="searchForm" class="search-form-centered">
                    <div class="search-input-container">
                        <input type="text" id="stationSearch" placeholder="Escribe el nombre de una estaci√≥n..." autocomplete="off">
                        <div class="autocomplete-results" id="autocompleteResults"></div>
                    </div>
                    <button type="submit" class="search-btn-rocket">üöÄ</button>
                </form>
                <p class="search-tips">
                    üí° Ejemplos: "Sol", "Callao", "Gran V√≠a", "Alonso Mart√≠nez"<br>
                    ‚ö° Al hacer clic en "Cargar" se ejecutar√° el scraper para obtener datos actualizados
                </p>
            </div>
        </div>

        <!-- Resultados de b√∫squeda -->
        {% if search_results %}
        <div class="search-results-section">
            <div class="search-results-header">
                <h3>üîç Resultados de b√∫squeda para "{{ search_query }}"</h3>
                <p>Se encontraron {{ search_results|length }} estaciones. Selecciona una para ver sus datos:</p>
            </div>
            <div class="search-results-grid">
                {% for estacion in search_results %}
                <div class="search-result-item" onclick="selectStationById({{ estacion|tojson }})">
                    <div class="result-icon">
                        <img src="{{ LINE_LOGOS.get(estacion.linea, '/static/logos/lineas/_ml.svg') }}" alt="L√≠nea {{ estacion.linea }}">
                    </div>
                    <div class="result-info">
                        <h4>{{ estacion.nombre }}</h4>
                        <p>L√≠nea {{ estacion.linea }} ‚Ä¢ ID: {{ estacion.id_fijo }}</p>
                    </div>
                    <div class="result-arrow">‚Üí</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Informaci√≥n de la estaci√≥n -->
        <div class="station-info" id="stationInfo" style="display:none;">
            <div class="station-header">
                <div class="station-icon" id="stationIcon">üöâ</div>
                <div class="station-details">
                    <h3 id="stationName">Nombre de la Estaci√≥n</h3>
                    <p id="stationId">ID: --</p>
                    <span class="station-status" id="stationStatus"></span>
                </div>
                <div class="station-actions">
                    <button id="refreshButton" class="refresh-btn" style="display: none;" onclick="refreshStationData()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                        Actualizar
                    </button>
                </div>
            </div>

            <div class="last-updated" id="lastUpdated" style="display: none;">
                √öltima actualizaci√≥n: <span id="updateTime"></span>
            </div>

            <!-- Pr√≥ximos trenes -->
            <div class="schedules-section">
                <h4>Pr√≥ximos Trenes</h4>
                <div id="modernTrainsContainer"></div> 
                </div>
            
            <!-- Vista 3D de la estaci√≥n -->
            <div class="model-3d-section" id="model3dSection" style="display: none;">
                <h4>üèóÔ∏è Vista 3D de la Estaci√≥n</h4>
                <div class="model-3d-container">
                    <div id="model3dContent" class="model-3d-image-container">
                        <img id="model3dImage" src="" alt="Vista 3D de la estaci√≥n" class="model-3d-image" style="display: none;">
                        <!-- El estado de carga o error se manejar√° aqu√≠ por JS -->
                </div> 
                    <div class="model-3d-actions">
                        <button id="downloadModel3dBtn" class="model-3d-btn" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                            Descargar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Informaci√≥n detallada -->
            <div class="detailed-info" id="detailedInfo" style="display: none;">
                <div class="info-card services-card">
                    <h5>üõ†Ô∏è Servicios Disponibles</h5>
                    <div id="servicesContent"></div>
                </div>

                <div class="info-card accesses-card">
                    <h5>üö™ Accesos</h5>
                    <div id="accessesContent"></div>
                </div>

                <div class="info-card connections-card">
                    <h5>üîó Conexiones</h5>
                    <div id="connectionsContent"></div>
                    </div>
                </div>

            <!-- L√≠neas -->
            <div class="lines-section">
                <h4>L√≠neas que pasan por esta estaci√≥n</h4>
                <div class="lines-grid" id="linesGrid"></div>
                </div>
        </div>

        <div class="footer">
            <p>¬© 2025 Metro de Madrid - Sistema de Informaci√≥n de Estaciones</p>
            <p>Datos actualizados en tiempo real</p>
        </div>
    </div>

    <!-- Script del sistema moderno de trenes -->
    <script src="/static/js/modern-trains.js"></script>

    <script>
        // Variables globales
        let currentStationName = '';
        let currentIdModal = null;
        let autocompleteTimeout;
        let selectedIndex = -1;
        let autocompleteData = [];

        // Configuraci√≥n de l√≠neas
        const LINE_COLORS = {
            '1': '#00AEEF', '2': '#FF0000', '3': '#FFDF00', '4': '#824100',
            '5': '#339900', '6': '#999999', '7': '#FF6600', '8': '#FF69B4',
            '9': '#990066', '10': '#000099', '11': '#006600', '12': '#999933',
            'Ramal': '#FF0000'
        };

        const LINE_LOGOS = {
            '1': '/static/logos/lineas/linea-1.svg',
            '2': '/static/logos/lineas/linea-2.svg',
            '3': '/static/logos/lineas/linea-3.svg',
            '4': '/static/logos/lineas/linea-4.svg',
            '5': '/static/logos/lineas/linea-5.svg',
            '6': '/static/logos/lineas/linea-6-circular.svg',
            '7': '/static/logos/lineas/linea-7.svg',
            '8': '/static/logos/lineas/linea-8.svg',
            '9': '/static/logos/lineas/linea-9.svg',
            '10': '/static/logos/lineas/linea-10.svg',
            '11': '/static/logos/lineas/linea-11.svg',
            '12': '/static/logos/lineas/linea-12-metrosur.svg',
            'Ramal': '/static/logos/lineas/ramal.svg'
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Script de station.html cargado');
            initializeEventListeners();
            handleAutoLoad();
        });

        // Inicializar event listeners
        function initializeEventListeners() {
            const searchInput = document.getElementById('stationSearch');
            const searchForm = document.getElementById('searchForm');

            if (searchInput) {
                searchInput.addEventListener('input', handleSearchInput);
                searchInput.addEventListener('keydown', handleSearchKeydown);
            }

            if (searchForm) {
                searchForm.addEventListener('submit', handleSearchSubmit);
            }

            // Cerrar autocompletado al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    hideAutocomplete();
                }
            });
        }

        // Manejar auto-load de estaci√≥n
        function handleAutoLoad() {
            {% if auto_load and station_id %}
            window.currentStationId = {{ station_id }};
            const stationName = "{{ station_data['nombre'] if station_data else '' }}";
            document.getElementById('stationSearch').value = stationName;
            
            if (stationName) {
                currentStationName = stationName;
                // Cargar datos de la estaci√≥n por ID
                loadStationDataById(window.currentStationId, stationName);
            }
            
            if (typeof updateModernTrainsById === 'function') {
                updateModernTrainsById(window.currentStationId, 'modernTrainsContainer');
            }
        {% elif auto_load and station_name and station_data %}
            currentStationName = "{{ station_name }}";
            document.getElementById('stationSearch').value = "{{ station_name }}";
            
            // Mostrar la informaci√≥n de la estaci√≥n inmediatamente
            const stationInfo = document.getElementById('stationInfo');
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            // Cargar datos inmediatamente
            searchStationWithNinjaScrap(currentStationName);
            
            // Cargar trenes modernos si est√° disponible
            if (typeof updateModernTrains === 'function') {
                updateModernTrains(currentStationName, 'modernTrainsContainer');
            }
            
            // Actualizar datos en tiempo real despu√©s de 1 segundo
            setTimeout(() => {
                console.log('üîÑ Ejecutando actualizaci√≥n autom√°tica de datos...');
                if (typeof refreshStationData === 'function') {
                    refreshStationData();
                } else {
                    // Fallback: ejecutar scraping directamente
                    executeNinjaScrap(currentStationName);
                }
            }, 1000);
        {% elif station_name and not station_data %}
            document.getElementById('stationSearch').value = "{{ station_name }}";
            console.log('üîç Mostrando opciones de b√∫squeda para: {{ station_name }}');
        {% endif %}
        }
        
        // Funci√≥n para cargar datos de estaci√≥n por ID
        async function loadStationDataById(stationId, stationName) {
            try {
                console.log(`üîç Cargando datos para estaci√≥n ID ${stationId}: ${stationName}`);
                
                // Buscar la estaci√≥n en la base de datos
                const response = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error || !Array.isArray(data) || data.length === 0) {
                    console.error('No se encontraron datos para la estaci√≥n');
                    return;
                }
                
                const groupedStations = groupStationsByName(data);
                const firstStation = groupedStations[0];
                
                const station = {
                    name: firstStation.nombre,
                    id: firstStation.nombre,
                    lines: firstStation.lines.map(result => ({
                        short_name: result.linea,
                        long_name: `L√≠nea ${result.linea}`,
                        color: getLineColor(result.linea),
                        url: result.url || null
                    }))
                };
                
                // Actualizar informaci√≥n de la estaci√≥n
                updateStationInfo(station);
                
                // Cargar datos en tiempo real
                await executeNinjaScrap(stationName);
                
                console.log(`‚úÖ Datos cargados para ${stationName}`);
                
            } catch (error) {
                console.error('Error cargando datos de estaci√≥n por ID:', error);
            }
        }

        // Manejar input de b√∫squeda
        function handleSearchInput(e) {
            const query = e.target.value.trim();
            
            if (autocompleteTimeout) {
                clearTimeout(autocompleteTimeout);
            }
            
            if (query.length < 2) {
                hideAutocomplete();
                return;
            }
            
            autocompleteTimeout = setTimeout(() => {
                searchAutocomplete(query);
            }, 300);
        }

        // Manejar teclas en b√∫squeda
        function handleSearchKeydown(e) {
            const results = document.getElementById('autocompleteResults');
            const items = results.querySelectorAll('.autocomplete-item');
            
            if (items.length === 0) return;
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection(items);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(items);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedIndex >= 0 && autocompleteData[selectedIndex]) {
                        selectStationById(autocompleteData[selectedIndex]);
                    } else if (autocompleteData.length > 0) {
                        selectStationById(autocompleteData[0]);
                    } else {
                        document.getElementById('searchForm').submit();
                    }
                    break;
                case 'Escape':
                    hideAutocomplete();
                    break;
            }
        }

        // Manejar env√≠o de formulario
        async function handleSearchSubmit(e) {
            e.preventDefault();
            const searchTerm = document.getElementById('stationSearch').value.trim();
            if (!searchTerm) return;
            await searchStationWithNinjaScrap(searchTerm);
        }

        // B√∫squeda de autocompletado
        async function searchAutocomplete(query) {
            const resultsDiv = document.getElementById('autocompleteResults');
            
            resultsDiv.innerHTML = '<div class="loading-indicator">üîç Buscando estaciones...</div>';
            resultsDiv.style.display = 'block';
            
            try {
                const response = await fetch(`/api/station/search?q=${encodeURIComponent(query)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                autocompleteData = Array.isArray(data) ? data : [];
                
                if (autocompleteData.length === 0) {
                    resultsDiv.innerHTML = '<div class="loading-indicator">No se encontraron estaciones</div>';
                    return;
                }
                
                const groupedStations = groupStationsByName(autocompleteData);
                const resultsHTML = groupedStations.map(station => {
                    const lines = station.lines.map(line => `L${line.linea}`).join(', ');
                    const lineImages = station.lines.map(line => {
                        const lineInfo = getLineInfo(line.linea);
                        return `<img src="${lineInfo.logo}" alt="L√≠nea ${line.linea}" style="width: 16px; height: 16px; margin-right: 2px;">`;
                    }).join('');
                    
                    const lineObj = station.lines[0];
                    const lineObjEscaped = encodeURIComponent(JSON.stringify(lineObj));
                    
                    return `
                        <div class="autocomplete-item" onclick="selectStationById(JSON.parse(decodeURIComponent('${lineObjEscaped}')))">
                            <div class="station-icon-small" style="background: #333; display: flex; gap: 2px; padding: 4px;">
                                ${lineImages}
                            </div>
                            <div class="station-info-autocomplete">
                                <div class="station-name">${station.nombre}</div>
                                <div class="station-lines">L√≠neas: ${lines}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                resultsDiv.innerHTML = resultsHTML;
                selectedIndex = -1;
                
            } catch (error) {
                console.error('‚ùå Error en autocompletado:', error);
                resultsDiv.innerHTML = '<div class="loading-indicator">Error al buscar estaciones</div>';
            }
        }

        // Agrupar estaciones por nombre
        function groupStationsByName(stations) {
            const grouped = {};
            
            stations.forEach(station => {
                const nombre = station.value || station.nombre;
                const linea = station.linea;
                
                if (!grouped[nombre]) {
                    grouped[nombre] = {
                        nombre: nombre,
                        lines: []
                    };
                }
                
                const lineExists = grouped[nombre].lines.some(line => line.linea === linea);
                if (!lineExists) {
                    grouped[nombre].lines.push({
                        linea: linea,
                        id_fijo: station.id_fijo,
                        id_modal: station.id_modal
                    });
                }
            });
            
            return Object.values(grouped);
        }

        // Actualizar selecci√≥n en autocompletado
        function updateSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Ocultar autocompletado
        function hideAutocomplete() {
            const resultsDiv = document.getElementById('autocompleteResults');
            resultsDiv.style.display = 'none';
            selectedIndex = -1;
        }

        // Seleccionar estaci√≥n por ID
        async function selectStationById(station) {
            console.log('üéØ selectStationById llamada con:', station);
            
            if (typeof station === 'object' && station.id_fijo) {
                console.log('üöÄ Redirigiendo a /station/id/' + station.id_fijo);
                window.location.href = '/station/id/' + station.id_fijo;
                return;
            }
            
            if (!isNaN(station)) {
                console.log('üöÄ Redirigiendo a /station/id/' + station);
                window.location.href = '/station/id/' + station;
                return;
            }
            
            if (typeof station === 'string') {
                console.log('üéØ Seleccionando estaci√≥n por nombre:', station);
                
                if (!station || station === 'undefined' || station.trim() === '') {
                    console.error('‚ùå Nombre de estaci√≥n inv√°lido en selectStation:', station);
                    return;
                }
                
                hideAutocomplete();
                document.getElementById('stationSearch').value = station;
                await searchStationWithNinjaScrap(station);
                return;
            }
            
            console.error('‚ùå No se pudo identificar la estaci√≥n:', station);
            alert('No se pudo identificar la estaci√≥n.');
        }

        // B√∫squeda principal con NinjaScrap
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName || stationName === 'undefined' || stationName.trim() === '') {
                console.error('‚ùå Nombre de estaci√≥n inv√°lido:', stationName);
                return;
            }
            
            currentStationName = stationName;
            
            const stationInfo = document.getElementById('stationInfo');
            const linesGrid = document.getElementById('linesGrid');
            const detailedInfo = document.getElementById('detailedInfo');
            const lastUpdated = document.getElementById('lastUpdated');
            const refreshButton = document.getElementById('refreshButton');
            
            // Mostrar la informaci√≥n de la estaci√≥n inmediatamente
            stationInfo.style.display = 'block';
            stationInfo.classList.add('show');
            linesGrid.innerHTML = '<div class="loading">üöÄ Ejecutando NinjaScrap para obtener datos en tiempo real...</div>';
            detailedInfo.style.display = 'none';
            lastUpdated.style.display = 'none';
            refreshButton.style.display = 'inline-block';
            
            try {
                console.log(`üîç Buscando estaci√≥n: ${stationName}`);
                const response = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const results = Array.isArray(data) ? data : [];
                
                if (results.length === 0) {
                    linesGrid.innerHTML = '<div class="no-data">No se encontr√≥ la estaci√≥n especificada</div>';
                    refreshButton.style.display = 'none';
                    return;
                }
                
                const groupedStations = groupStationsByName(results);
                const firstStation = groupedStations[0];
                
                const station = {
                    name: firstStation.nombre,
                    id: firstStation.nombre,
                    lines: firstStation.lines.map(result => ({
                        short_name: result.linea,
                        long_name: `L√≠nea ${result.linea}`,
                        color: getLineColor(result.linea),
                        url: result.url || null
                    }))
                };
                
                console.log(`‚úÖ Estaci√≥n encontrada: ${station.name} con ${station.lines.length} l√≠neas`);
                
                // Actualizar informaci√≥n de la estaci√≥n
                updateStationInfo(station);
                
                // Ejecutar scraping inmediatamente
                await executeNinjaScrap(stationName);
                
                console.log(`‚úÖ Datos cargados para ${stationName}`);
                
            } catch (error) {
                console.error('‚ùå Error en NinjaScrap:', error);
                linesGrid.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                refreshButton.style.display = 'none';
            }
        }

        // Ejecutar NinjaScrap
        async function executeNinjaScrap(stationName) {
            try {
                const response = await fetch(`/api/station/realtime/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    console.warn('Error en tiempo real:', data.error);
                    await loadIntelligentData(stationName);
                    return;
                }
                
                displayRealtimeData(data);
                
            } catch (error) {
                console.warn('Error ejecutando scraping en tiempo real:', error);
                await loadIntelligentData(stationName);
            }
        }

        // Mostrar datos en tiempo real
        function displayRealtimeData(data) {
            console.log('Datos en tiempo real recibidos:', data);
            const detailedInfo = document.getElementById('detailedInfo');
            const lastUpdated = document.getElementById('lastUpdated');
            const updateTime = document.getElementById('updateTime');
            const modernTrainsContainer = document.getElementById('modernTrainsContainer');
            const servicesContent = document.getElementById('servicesContent');
            const accessesContent = document.getElementById('accessesContent');
            const connectionsContent = document.getElementById('connectionsContent');
            
            servicesContent.innerHTML = '';
            accessesContent.innerHTML = '';
            connectionsContent.innerHTML = '';

            if (data.timestamp) {
                const updateDate = new Date(data.timestamp);
                updateTime.textContent = updateDate.toLocaleString('es-ES');
                lastUpdated.style.display = 'block';
            }
            
            const stationStatus = determineStationStatus(data);
            updateStationStatus(stationStatus);
            
            if (data.next_trains_html) {
                // Si hay datos de trenes, mostrarlos
                if (typeof modernTrainsRenderer !== 'undefined' && modernTrainsRenderer.renderTrains) {
                    modernTrainsRenderer.renderTrains('modernTrainsContainer', data.next_trains_html);
                } else {
                    // Fallback: mostrar HTML directamente
                    modernTrainsContainer.innerHTML = data.next_trains_html;
                }
            } else {
                // Si no hay datos de trenes
                if (typeof modernTrainsRenderer !== 'undefined' && modernTrainsRenderer.renderNoTrains) {
                    modernTrainsRenderer.renderNoTrains('modernTrainsContainer');
                } else {
                    modernTrainsContainer.innerHTML = '<div class="no-data">No hay informaci√≥n de pr√≥ximos trenes disponible</div>';
                }
            }
            
            if (data.stored_data && data.stored_data.length > 0) {
                const stationData = data.stored_data[0];
                currentIdModal = stationData.id_modal || null;
                
                if (stationData.modulos) {
                    if (stationData.modulos.servicios && stationData.modulos.servicios.disponible) {
                        const serviciosHTML = loadServicesFromRelational(stationData.modulos.servicios.datos, stationData.nombre);
                        servicesContent.innerHTML = serviciosHTML;
                    } else {
                        servicesContent.innerHTML = '<div class="no-data">No hay informaci√≥n de servicios disponible.</div>';
                    }
                    
                    // Cargar accesos desde GTFS (nueva base de datos)
                    loadAccessesFromGTFS(stationData.nombre);
                    
                    if (stationData.modulos.conexiones && stationData.modulos.conexiones.disponible) {
                        const conexionesHTML = loadConnectionsFromRelational(stationData.modulos.conexiones.datos, stationData.nombre);
                        if (conexionesHTML && !conexionesHTML.includes('No hay conexiones disponibles')) {
                            connectionsContent.innerHTML = conexionesHTML;
                            document.querySelector('.connections-card').style.display = 'block';
                        } else {
                            document.querySelector('.connections-card').style.display = 'none';
                        }
                    } else {
                        document.querySelector('.connections-card').style.display = 'none';
                    }
                }
            } else {
                servicesContent.innerHTML = '<div class="no-data">No hay informaci√≥n de servicios disponible.</div>';
                accessesContent.innerHTML = '<div class="no-data">No hay informaci√≥n de accesos disponible.</div>';
                document.querySelector('.connections-card').style.display = 'none';
            }
            
            detailedInfo.style.display = 'grid';

            const stationName = data.station_name || currentStationName;
            fetch(`/api/station/closed-status/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(statusData => {
                    if (statusData.cerrada) {
                        updateStationStatus('Cerrada');
                    } else {
                        const stationStatus = determineStationStatus(data);
                        updateStationStatus(stationStatus);
                    }
                })
                .catch(() => {
                    const stationStatus = determineStationStatus(data);
                    updateStationStatus(stationStatus);
                });
        }

        // Funci√≥n para cargar accesos desde datos reales del scraping
        function loadAccessesFromRealData(accesos, stationName) {
            if (!accesos || accesos.length === 0) return '<div class="no-data">No hay accesos disponibles.</div>';
            
            let html = `<div class="line-data-header">${stationName}</div>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">TIPO DE ACCESO</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
            html += '</tr></thead><tbody>';
            
            accesos.forEach(acceso => {
                const icon = getAccessIcon(acceso.tipo);
                    html += '<tr style="border-bottom: 1px solid #eee;">';
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${acceso.tipo}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.vestibulo || 'No especificado'}</td>`;
                    html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }

        // Funci√≥n para obtener icono de acceso
        function getAccessIcon(tipoAcceso) {
            const iconMap = {
                'Ascensor': 'üõó',
                'Escalera': 'üõó',
                'Acceso': 'üö™',
                'Entrada': 'üö™',
                'Salida': 'üö™',
                'Escaleras mec√°nicas': 'üõó',
                'Rampa': '‚ôø'
            };
            
            return iconMap[tipoAcceso] || 'üö™';
        }

        // Funciones de utilidad
        function getLineColor(lineNumber) {
            return LINE_COLORS[lineNumber] || '#666';
        }

        function getLineLogo(lineNumber) {
            return LINE_LOGOS[lineNumber] || '/static/logos/lineas/_ml.svg';
        }

        function getLineInfo(lineNumber) {
            return {
                color: getLineColor(lineNumber),
                logo: getLineLogo(lineNumber)
            };
        }

        function determineStationStatus(stationData) {
            if (!stationData || !stationData.realtime) {
                return 'Operativa';
            }
            
            const realtimeData = stationData.realtime;
            
            const hasTrainData = realtimeData.proximos_trenes_html && 
                                realtimeData.proximos_trenes_html.length > 0 &&
                                !realtimeData.proximos_trenes_html.includes('No se pudieron obtener');
            
            const ascensoresStatus = realtimeData.estado_ascensores || '';
            const escalerasStatus = realtimeData.estado_escaleras || '';
            
            if (!hasTrainData) {
                return 'Cerrada';
            }
            
            const serviciosCriticos = ascensoresStatus.toLowerCase().includes('fuera de servicio') &&
                                     escalerasStatus.toLowerCase().includes('fuera de servicio');
            
            if (serviciosCriticos) {
                return 'Cerrada';
            }
            
            return 'Operativa';
        }

        function updateStationStatus(status) {
            const statusElement = document.getElementById('stationStatus');
            if (status) {
                const statusClass = status.toLowerCase().includes('operativa') ? 'status-operativa' : 'status-cerrada';
                statusElement.textContent = '';
                statusElement.className = `station-status ${statusClass}`;
            }
        }

        // Actualizar informaci√≥n de estaci√≥n
        function updateStationInfo(station) {
            document.getElementById('stationName').textContent = station.name;
            document.getElementById('stationId').textContent = `Estaci√≥n: ${station.name}`;
            
            if (station.lines && station.lines.length > 0) {
                if (station.lines.length === 1) {
                    const lineInfo = getLineInfo(station.lines[0].short_name);
                    document.body.style.background = `linear-gradient(135deg, ${lineInfo.color}40 0%, ${lineInfo.color}20 50%, #f7f7f7 100%)`;
                } else if (station.lines.length >= 2) {
                    const line1Info = getLineInfo(station.lines[0].short_name);
                    const line2Info = getLineInfo(station.lines[1].short_name);
                    document.body.style.background = `linear-gradient(135deg, ${line1Info.color}40 0%, ${line2Info.color}40 50%, #f7f7f7 100%)`;
                }
            } else {
                document.body.style.background = '#f7f7f7';
            }
            
            const stationIcon = document.getElementById('stationIcon');
            if (station.lines && station.lines.length > 0) {
                if (station.lines.length === 1) {
                    const lineInfo = getLineInfo(station.lines[0].short_name);
                    stationIcon.style.background = lineInfo.color;
                    stationIcon.innerHTML = `<img src="${lineInfo.logo}" alt="L√≠nea ${station.lines[0].short_name}" style="width: 30px; height: 30px;">`;
                } else if (station.lines.length === 2) {
                    const line1Info = getLineInfo(station.lines[0].short_name);
                    const line2Info = getLineInfo(station.lines[1].short_name);
                    stationIcon.style.background = `linear-gradient(45deg, ${line1Info.color} 50%, ${line2Info.color} 50%)`;
                    stationIcon.innerHTML = `
                        <div style="display: flex; gap: 2px;">
                            <img src="${line1Info.logo}" alt="L√≠nea ${station.lines[0].short_name}" style="width: 15px; height: 15px;">
                            <img src="${line2Info.logo}" alt="L√≠nea ${station.lines[1].short_name}" style="width: 15px; height: 15px;">
                        </div>
                    `;
                } else {
                    stationIcon.style.background = '#808080';
                    stationIcon.textContent = station.lines.length;
                }
            } else {
                stationIcon.style.background = '#666';
                stationIcon.textContent = '?';
            }
            
            updateLinesGrid(station);
            
            // Cargar vista 3D de la estaci√≥n
            if (station.lines && station.lines.length > 0) {
                const lineNumber = station.lines[0].short_name;
                console.log(`üèóÔ∏è Cargando vista 3D para ${station.name} (L√≠nea ${lineNumber})`);
                updateModel3D(station.name, lineNumber);
            }
        }

        // Actualizar grid de l√≠neas
        function updateLinesGrid(station) {
            const linesGrid = document.getElementById('linesGrid');
            const lineDestinations = {
                '1': { ida: 'Valdecarros', vuelta: 'Pinar de Chamart√≠n' },
                '2': { ida: 'Las Rosas', vuelta: 'Cuatro Caminos' },
                '3': { ida: 'Villaverde Alto', vuelta: 'Moncloa' },
                '4': { ida: 'Pinar de Chamart√≠n', vuelta: 'Arg√ºelles' },
                '5': { ida: 'Casa de Campo', vuelta: 'Alameda de Osuna' },
                '6': { ida: 'Laguna', vuelta: 'Lucero' },
                '7': { ida: 'Pitis', vuelta: 'Hospital del Henares' },
                '8': { ida: 'Aeropuerto T4', vuelta: 'Nuevos Ministerios' },
                '9': { ida: 'Paco de Luc√≠a', vuelta: 'Mirasierra' },
                '10': { ida: 'Hospital Infanta Sof√≠a', vuelta: 'Puerta del Sur' },
                '11': { ida: 'La Fortuna', vuelta: 'Plaza El√≠ptica' },
                '12': { ida: 'Puerta del Sur', vuelta: 'Hospital Infanta Sof√≠a' },
                'Ramal': { ida: '√ìpera', vuelta: 'Pr√≠ncipe P√≠o' }
            };
            
            if (station.lines && station.lines.length > 0) {
                const linesHTML = station.lines.map(line => {
                    const destinations = lineDestinations[line.short_name] || { ida: 'Destino', vuelta: 'Origen' };
                    const lineInfo = getLineInfo(line.short_name);
                    
                    return `
                        <div class="line-card" style="border-left-color: ${lineInfo.color}">
                            <div class="line-header">
                                <div class="line-info">
                                    <img src="${lineInfo.logo}" alt="L√≠nea ${line.short_name}">
                                    <strong>L√≠nea ${line.short_name}</strong>
                                </div>
                                <span class="directions-count">2 sentidos</span>
                            </div>
                            <div class="directions-container">
                                <div class="line-direction" style="border-left-color: ${lineInfo.color}">
                                    <div class="direction-header">
                                        <span class="direction-icon">‚û°Ô∏è</span>
                                        <span class="direction-name">IDA</span>
                                    </div>
                                    <div class="line-name">
                                        <img src="${lineInfo.logo}" alt="L√≠nea ${line.short_name}">
                                        L√≠nea ${line.short_name}
                                    </div>
                                    <div class="line-destination">
                                        <strong>Destino:</strong> ${destinations.ida}
                                    </div>
                                </div>
                                <div class="line-direction" style="border-left-color: ${lineInfo.color}">
                                    <div class="direction-header">
                                        <span class="direction-icon">‚¨ÖÔ∏è</span>
                                        <span class="direction-name">VUELTA</span>
                                    </div>
                                    <div class="line-name">
                                        <img src="${lineInfo.logo}" alt="L√≠nea ${line.short_name}">
                                        L√≠nea ${line.short_name}
                                    </div>
                                    <div class="line-destination">
                                        <strong>Destino:</strong> ${destinations.vuelta}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                linesGrid.innerHTML = linesHTML;
            } else {
                linesGrid.innerHTML = '<div class="no-data">No hay informaci√≥n de l√≠neas disponible</div>';
            }
        }

        // Actualizar datos de estaci√≥n
        async function refreshStationData() {
            if (!currentStationName) {
                console.warn('No hay estaci√≥n seleccionada para actualizar');
                return;
            }
            
            console.log('üöÄ Actualizando datos en tiempo real de:', currentStationName);
            
            const refreshBtn = document.getElementById('refreshButton');
            const originalText = refreshBtn.textContent;
            refreshBtn.textContent = '‚è≥ Actualizando...';
            refreshBtn.disabled = true;
            
            try {
                const response = await fetch(`/api/station/realtime/${encodeURIComponent(currentStationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                
                const updateTime = document.getElementById('updateTime');
                updateTime.textContent = new Date().toLocaleString('es-ES');
                
                console.log('‚úÖ Datos en tiempo real actualizados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error actualizando datos en tiempo real:', error);
                alert('Error al actualizar los datos en tiempo real. Int√©ntalo de nuevo.');
            } finally {
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
            }
        }

        // Cargar datos inteligentes
        async function loadIntelligentData(stationName) {
            const detailedInfo = document.getElementById('detailedInfo');
            const lastUpdated = document.getElementById('lastUpdated');
            const updateTime = document.getElementById('updateTime');
            
            try {
                const response = await fetch(`/api/station/intelligent/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    console.warn('No se encontraron datos inteligentes:', data.error);
                    return;
                }
                
                if (!data.stations || data.stations.length === 0) {
                    console.warn('No se encontraron estaciones en datos inteligentes');
                    return;
                }
                
                const stationData = data.stations[0];
                
                if (stationData.ultima_actualizacion) {
                    const updateDate = new Date(stationData.ultima_actualizacion);
                    updateTime.textContent = updateDate.toLocaleString('es-ES');
                    lastUpdated.style.display = 'block';
                }
                
                updateStationStatus('Operativa');
                loadServices(stationData.services);
                loadAccesses(stationData.access);
                loadConnections([], stationData.intercambiadores ? [stationData.intercambiadores] : []);
                
                detailedInfo.style.display = 'grid';
                
            } catch (error) {
                console.warn('Error cargando datos inteligentes:', error);
            }
        }

        // Funciones para cargar datos relacionales
        function loadServicesFromRelational(servicios, stationName) {
            if (!servicios || servicios.length === 0) return '<div class="no-data">No hay servicios disponibles.</div>';
            let html = `<div class="line-data-header">${stationName}</div>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">SERVICIO</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ESTADO</th>';
            html += '</tr></thead><tbody>';
            servicios.forEach(servicio => {
                const icon = getServiceIcon(servicio.tipo_servicio || servicio.nombre);
                const statusClass = servicio.disponible ? 'service-available' : 'service-unavailable';
                const statusText = servicio.disponible ? 'Disponible' : 'No disponible';
                html += '<tr style="border-bottom: 1px solid #eee;">';
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${servicio.tipo_servicio || servicio.nombre}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span class="service-icon ${statusClass}" style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; font-size: 10px; line-height: 16px; text-align: center; color: white;">${servicio.disponible ? '‚úì' : '‚úó'}</span> ${statusText}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        }

        function loadAccessesFromRelational(accesos, stationName) {
            if (!accesos || accesos.length === 0) return '<div class="no-data">No hay accesos disponibles.</div>';
            let html = `<div class="line-data-header">${stationName}</div>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
            html += '</tr></thead><tbody>';
            accesos.forEach(acceso => {
                html += '<tr style="border-bottom: 1px solid #eee;">';
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.vestibulo || 'No especificado'}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre_acceso || acceso.nombre || 'No especificado'}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        }

        function loadConnectionsFromRelational(conexiones, stationName) {
            if (!conexiones || conexiones.length === 0) return '<div class="no-data">No hay conexiones disponibles.</div>';
            let html = `<div class="line-data-header">${stationName}</div>`;
            conexiones.forEach(conexion => {
                html += `<div class="connection-item">${conexion.detalle || conexion}</div>`;
            });
            return html;
        }

        // Funci√≥n para cargar accesos desde MetroMadrid
        async function loadAccessesFromMetroMadrid(stationId, stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            try {
                console.log(`üîó Cargando accesos desde MetroMadrid para estaci√≥n ${stationName} (ID: ${stationId})`);
                
                // Mostrar indicador de carga
                accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde MetroMadrid...</div>';
                
                const response = await fetch(`/api/station/accesses/metromadrid/${stationId}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error cargando accesos desde MetroMadrid:', data.error);
                    accessesContent.innerHTML = '<div class="no-data">No hay informaci√≥n de accesos disponible.</div>';
                    return;
                }
                
                if (!data.accesos || data.accesos.length === 0) {
                    accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles en MetroMadrid.</div>';
                    return;
                }
                
                // Generar HTML con los accesos de MetroMadrid
                let html = `<div class="line-data-header">${stationName} - Accesos Oficiales</div>`;
                html += '<div class="metro-madrid-badge" style="background: #0065FE; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìã Datos oficiales de MetroMadrid</div>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
                html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
                html += '</tr></thead><tbody>';
                
                data.accesos.forEach(acceso => {
                    html += '<tr style="border-bottom: 1px solid #eee;">';
                    html += `<td style="padding: 8px; border: 1px solid #ddd;"><strong>${acceso.vestibulo || 'No especificado'}</strong></td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.acceso || 'No especificado'}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-top: 10px; font-size: 12px; color: #666;">√öltima actualizaci√≥n: ${new Date().toLocaleString('es-ES')}</div>`;
                
                accessesContent.innerHTML = html;
                console.log(`‚úÖ Accesos cargados desde MetroMadrid: ${data.total} accesos`);
                
            } catch (error) {
                console.error('Error cargando accesos desde MetroMadrid:', error);
                accessesContent.innerHTML = '<div class="no-data">Error cargando accesos desde MetroMadrid.</div>';
            }
        }

        function getServiceIcon(tipoServicio) {
            const iconMap = {
                'Ascensores': 'üõó',
                'Escaleras mec√°nicas': 'üõó',
                'Desfibrilador': 'üíì',
                'Cobertura m√≥vil': 'üì±',
                'Bibliometro': 'üìö',
                'Tiendas': 'üõçÔ∏è',
                'Estaci√≥n accesible': '‚ôø',
                'Oficina Objetos Perdidos': 'üìã',
                'Oficina de gesti√≥n TTP': 'üí≥',
                'Parking disuasorio de pago': 'üöó',
                'Quioscos ONCE': 'üì∞',
                'adaptada para discapacitados': '‚ôø',
                'escaleras': 'üõó'
            };
            
            return iconMap[tipoServicio] || 'üîß';
        }

        // Funciones legacy para compatibilidad
        function loadServices(services, linea) {
            const servicesContent = document.getElementById('servicesContent');
            if (!servicesContent) return;
            
            if (!services || Object.keys(services).length === 0) {
                servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles.</div>';
                return;
            }
            
            let html = '<div class="services-grid">';
            Object.entries(services).forEach(([service, available]) => {
                const icon = getServiceIcon(service);
                const statusClass = available ? 'service-available' : 'service-unavailable';
                const statusText = available ? 'Disponible' : 'No disponible';
                
                html += `
                    <div class="service-item">
                        <div class="service-icon ${statusClass}">${icon}</div>
                        <div class="service-info">
                            <div class="service-name">${service}</div>
                            <div class="service-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            servicesContent.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES PARA MODELOS 3D
        // ============================================================================

        // Funci√≥n para cargar y mostrar la vista 3D de una estaci√≥n
        async function loadModel3D(stationName, lineNumber) {
            const model3dSection = document.getElementById('model3dSection');
            const model3dImage = document.getElementById('model3dImage');
            
            if (!model3dSection || !model3dImage) {
                console.warn('Elementos de vista 3D no encontrados');
                return;
            }
            
            // Mostrar secci√≥n
            model3dSection.style.display = 'block';
            
            // Normalizar nombre de estaci√≥n para la URL
            function normalizarNombre(nombre) {
                if (!nombre) return "";
                nombre = nombre.toLowerCase();
                nombre = nombre.replace('√°', 'a').replace('√©', 'e').replace('√≠', 'i').replace('√≥', 'o').replace('√∫', 'u').replace('√±', 'n');
                nombre = nombre.replace('√º', 'u').replace('√ß', 'c');
                nombre = nombre.replace(/[^a-z0-9\s]/g, '');
                nombre = nombre.replace(/\s+/g, '_');
                return nombre;
            }
            
            const normalizedName = normalizarNombre(stationName);
            const originalUrl = `http://estacions.albertguillaumes.cat/img/madrid/${normalizedName}.png`;
            
            // Cargar directamente desde la URL original
            model3dImage.src = originalUrl;
            model3dImage.alt = `Vista 3D de ${stationName}`;
            model3dImage.style.display = 'block';
            
            // Actualizar informaci√≥n
            const stationNameSpan = document.querySelector('.model-3d-station-name');
            const lineInfoSpan = document.querySelector('.model-3d-line-info');
            if (stationNameSpan) stationNameSpan.textContent = stationName;
            if (lineInfoSpan) lineInfoSpan.textContent = `L√≠nea ${lineNumber}`;
            
            console.log(`‚úÖ Vista 3D cargada desde: ${originalUrl}`);
            
            // Manejar errores de carga
            model3dImage.onerror = function() {
                console.log(`‚ùå Error cargando vista 3D para ${stationName}`);
                showModel3DPlaceholder(stationName, originalUrl);
            };
        }
        
        // Funci√≥n para mostrar placeholder cuando no hay vista 3D
        function showModel3DPlaceholder(stationName, downloadUrl = null) {
            const model3dSection = document.getElementById('model3dSection');
            if (!model3dSection) return;
            
            const placeholderHTML = `
                <div class="model-3d-not-available">
                    <div class="model-3d-placeholder">
                        <div class="model-3d-icon">üèóÔ∏è</div>
                        <h4>Vista 3D no disponible</h4>
                        <p>No hay una vista 3D disponible para la estaci√≥n <strong>${stationName}</strong>.</p>
                        ${downloadUrl ? `
                            <button class="btn btn-primary" onclick="downloadModel3D('${stationName}')">
                                üì• Descargar Vista 3D
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            model3dSection.innerHTML = placeholderHTML;
            console.log(`‚ö†Ô∏è Vista 3D no disponible para ${stationName}`);
        }
        
        // Funci√≥n para descargar vista 3D
        async function downloadModel3D(stationName) {
            try {
                console.log(`üì• Descargando vista 3D para ${stationName}...`);
                
                const response = await fetch(`/api/station/model3d/download/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Vista 3D descargada: ${data.local_path}`);
                    // Recargar la vista 3D despu√©s de descargar
                    const stationData = await getStationData(stationName);
                    if (stationData && stationData.lines && stationData.lines.length > 0) {
                        loadModel3D(stationName, stationData.lines[0].short_name);
                    }
                } else {
                    console.error('Error descargando vista 3D:', data.error);
                    alert('Error al descargar la vista 3D. Int√©ntalo de nuevo.');
                }
                
            } catch (error) {
                console.error('Error en descarga:', error);
                alert('Error al descargar la vista 3D.');
            }
        }

        // Funci√≥n para rotar la vista del modelo 3D
        function rotateModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            // A√±adir clase de rotaci√≥n
            model3dImage.style.transition = 'transform 0.5s ease';
            model3dImage.style.transform = 'rotateY(180deg)';
            
            // Restaurar despu√©s de la animaci√≥n
            setTimeout(() => {
                model3dImage.style.transform = 'rotateY(0deg)';
            }, 500);
            
            console.log('üîÑ Rotando vista del modelo 3D');
        }

        // Funci√≥n para hacer zoom en el modelo 3D
        function zoomModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            const currentScale = model3dImage.style.transform.includes('scale') 
                ? parseFloat(model3dImage.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1)
                : 1;
            
            const newScale = currentScale === 1 ? 1.5 : 1;
            
            model3dImage.style.transition = 'transform 0.3s ease';
            model3dImage.style.transform = `scale(${newScale})`;
            
            console.log(`üîç Zoom del modelo 3D: ${newScale}x`);
        }

        // Funci√≥n para actualizar el modelo 3D cuando se selecciona una estaci√≥n
        function updateModel3D(stationName, lineNumber) {
            if (!stationName || !lineNumber) {
                const model3dSection = document.getElementById('model3dSection');
                if (model3dSection) {
                    model3dSection.style.display = 'none';
                }
                return;
            }
            
            loadModel3D(stationName, lineNumber);
        }

        // Modificar la funci√≥n existente para incluir el modelo 3D
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName) return;
            
            currentStationName = stationName;
            const stationInfo = document.getElementById('stationInfo');
            const refreshBtn = document.getElementById('refreshButton');
            
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            if (refreshBtn) {
                refreshBtn.style.display = 'inline-flex';
            }
            
            // Actualizar nombre de estaci√≥n
            const stationNameElement = document.getElementById('stationName');
            if (stationNameElement) {
                stationNameElement.textContent = stationName;
            }
            
            // Buscar datos de la estaci√≥n para obtener la l√≠nea
            try {
                const searchResponse = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const searchData = await searchResponse.json();
                
                if (searchData && searchData.length > 0) {
                    const stationData = searchData[0];
                    const lineNumber = stationData.linea;
                    
                    // Actualizar ID de estaci√≥n
                    const stationIdElement = document.getElementById('stationId');
                    if (stationIdElement) {
                        stationIdElement.textContent = `ID: ${stationData.id_fijo}`;
                    }
                    
                    // Cargar modelo 3D
                    updateModel3D(stationName, lineNumber);
                    
                    console.log(`üèóÔ∏è Cargando modelo 3D para ${stationName} (L√≠nea ${lineNumber})`);
                }
            } catch (error) {
                console.error('Error obteniendo datos de estaci√≥n para modelo 3D:', error);
            }
            
            // Continuar con el resto de la funcionalidad existente...
            try {
                const response = await fetch(`/api/station/ninjascrap/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                loadIntelligentData(stationName);
                
            } catch (error) {
                console.error('Error en searchStationWithNinjaScrap:', error);
                alert('Error al obtener datos de la estaci√≥n. Int√©ntalo de nuevo.');
            }
        }

        // A√±adir despu√©s de la funci√≥n loadAccessesFromMetroMadrid (l√≠nea 2030):

        function loadAccessesFromGTFS(stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            // Mostrar indicador de carga
            accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde GTFS...</div>';
            
            fetch(`/api/station/accesses/gtfs/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error cargando accesos GTFS:', data.error);
                        accessesContent.innerHTML = '<div class="no-data">No se pudieron cargar los accesos.</div>';
                        return;
                    }
                    
                    if (!data.accesos || data.accesos.length === 0) {
                        accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles para esta estaci√≥n.</div>';
                        return;
                    }
                    
                    // Crear tabla de accesos
                    let html = `<div class="line-data-header">üö™ Accesos - ${data.estacion.nombre}</div>`;
                    html += '<div class="gtfs-badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìä Datos GTFS oficiales</div>';
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ACCESIBLE</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.accesos.forEach(acceso => {
                        const icon = getAccessIcon(acceso.tipo_acceso);
                        const accesibleIcon = acceso.accesible_silla_ruedas ? '‚ôø' : '‚ùå';
                        const accesibleText = acceso.accesible_silla_ruedas ? 'S√≠' : 'No';
                        
                        html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${acceso.vestibulo}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre_acceso}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${accesibleIcon} ${accesibleText}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // A√±adir informaci√≥n de la estaci√≥n
                    html += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">`;
                    html += `<strong>Informaci√≥n de la estaci√≥n:</strong><br>`;
                    html += `üìç Coordenadas: ${data.estacion.latitud}, ${data.estacion.longitud}<br>`;
                    html += `‚ôø Accesibilidad general: ${data.estacion.accesible_silla_ruedas ? 'S√≠' : 'No'}<br>`;
                    html += `üö™ Total de accesos: ${data.estacion.total_accesos}<br>`;
                    html += `üìä Fuente: ${data.fuente}`;
                    html += '</div>';
                    
                    accessesContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error cargando accesos GTFS:', error);
                    accessesContent.innerHTML = '<div class="no-data">Error al cargar los accesos.</div>';
                });
        }

        function getServiceIcon(tipoServicio) {
            const iconMap = {
                'Ascensores': 'üõó',
                'Escaleras mec√°nicas': 'üõó',
                'Desfibrilador': 'üíì',
                'Cobertura m√≥vil': 'üì±',
                'Bibliometro': 'üìö',
                'Tiendas': 'üõçÔ∏è',
                'Estaci√≥n accesible': '‚ôø',
                'Oficina Objetos Perdidos': 'üìã',
                'Oficina de gesti√≥n TTP': 'üí≥',
                'Parking disuasorio de pago': 'üöó',
                'Quioscos ONCE': 'üì∞',
                'adaptada para discapacitados': '‚ôø',
                'escaleras': 'üõó'
            };
            
            return iconMap[tipoServicio] || 'üîß';
        }

        // Funciones legacy para compatibilidad
        function loadServices(services, linea) {
            const servicesContent = document.getElementById('servicesContent');
            if (!servicesContent) return;
            
            if (!services || Object.keys(services).length === 0) {
                servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles.</div>';
                return;
            }
            
            let html = '<div class="services-grid">';
            Object.entries(services).forEach(([service, available]) => {
                const icon = getServiceIcon(service);
                const statusClass = available ? 'service-available' : 'service-unavailable';
                const statusText = available ? 'Disponible' : 'No disponible';
                
                html += `
                    <div class="service-item">
                        <div class="service-icon ${statusClass}">${icon}</div>
                        <div class="service-info">
                            <div class="service-name">${service}</div>
                            <div class="service-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            servicesContent.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES PARA MODELOS 3D
        // ============================================================================

        // Funci√≥n para cargar y mostrar la vista 3D de una estaci√≥n
        async function loadModel3D(stationName, lineNumber) {
            const model3dSection = document.getElementById('model3dSection');
            const model3dImage = document.getElementById('model3dImage');
            
            if (!model3dSection || !model3dImage) {
                console.warn('Elementos de vista 3D no encontrados');
                return;
            }
            
            // Mostrar secci√≥n
            model3dSection.style.display = 'block';
            
            // Normalizar nombre de estaci√≥n para la URL
            function normalizarNombre(nombre) {
                if (!nombre) return "";
                nombre = nombre.toLowerCase();
                nombre = nombre.replace('√°', 'a').replace('√©', 'e').replace('√≠', 'i').replace('√≥', 'o').replace('√∫', 'u').replace('√±', 'n');
                nombre = nombre.replace('√º', 'u').replace('√ß', 'c');
                nombre = nombre.replace(/[^a-z0-9\s]/g, '');
                nombre = nombre.replace(/\s+/g, '_');
                return nombre;
            }
            
            const normalizedName = normalizarNombre(stationName);
            const originalUrl = `http://estacions.albertguillaumes.cat/img/madrid/${normalizedName}.png`;
            
            // Cargar directamente desde la URL original
            model3dImage.src = originalUrl;
            model3dImage.alt = `Vista 3D de ${stationName}`;
            model3dImage.style.display = 'block';
            
            // Actualizar informaci√≥n
            const stationNameSpan = document.querySelector('.model-3d-station-name');
            const lineInfoSpan = document.querySelector('.model-3d-line-info');
            if (stationNameSpan) stationNameSpan.textContent = stationName;
            if (lineInfoSpan) lineInfoSpan.textContent = `L√≠nea ${lineNumber}`;
            
            console.log(`‚úÖ Vista 3D cargada desde: ${originalUrl}`);
            
            // Manejar errores de carga
            model3dImage.onerror = function() {
                console.log(`‚ùå Error cargando vista 3D para ${stationName}`);
                showModel3DPlaceholder(stationName, originalUrl);
            };
        }
        
        // Funci√≥n para mostrar placeholder cuando no hay vista 3D
        function showModel3DPlaceholder(stationName, downloadUrl = null) {
            const model3dSection = document.getElementById('model3dSection');
            if (!model3dSection) return;
            
            const placeholderHTML = `
                <div class="model-3d-not-available">
                    <div class="model-3d-placeholder">
                        <div class="model-3d-icon">üèóÔ∏è</div>
                        <h4>Vista 3D no disponible</h4>
                        <p>No hay una vista 3D disponible para la estaci√≥n <strong>${stationName}</strong>.</p>
                        ${downloadUrl ? `
                            <button class="btn btn-primary" onclick="downloadModel3D('${stationName}')">
                                üì• Descargar Vista 3D
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            model3dSection.innerHTML = placeholderHTML;
            console.log(`‚ö†Ô∏è Vista 3D no disponible para ${stationName}`);
        }
        
        // Funci√≥n para descargar vista 3D
        async function downloadModel3D(stationName) {
            try {
                console.log(`üì• Descargando vista 3D para ${stationName}...`);
                
                const response = await fetch(`/api/station/model3d/download/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Vista 3D descargada: ${data.local_path}`);
                    // Recargar la vista 3D despu√©s de descargar
                    const stationData = await getStationData(stationName);
                    if (stationData && stationData.lines && stationData.lines.length > 0) {
                        loadModel3D(stationName, stationData.lines[0].short_name);
                    }
                } else {
                    console.error('Error descargando vista 3D:', data.error);
                    alert('Error al descargar la vista 3D. Int√©ntalo de nuevo.');
                }
                
            } catch (error) {
                console.error('Error en descarga:', error);
                alert('Error al descargar la vista 3D.');
            }
        }

        // Funci√≥n para rotar la vista del modelo 3D
        function rotateModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            // A√±adir clase de rotaci√≥n
            model3dImage.style.transition = 'transform 0.5s ease';
            model3dImage.style.transform = 'rotateY(180deg)';
            
            // Restaurar despu√©s de la animaci√≥n
            setTimeout(() => {
                model3dImage.style.transform = 'rotateY(0deg)';
            }, 500);
            
            console.log('üîÑ Rotando vista del modelo 3D');
        }

        // Funci√≥n para hacer zoom en el modelo 3D
        function zoomModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            const currentScale = model3dImage.style.transform.includes('scale') 
                ? parseFloat(model3dImage.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1)
                : 1;
            
            const newScale = currentScale === 1 ? 1.5 : 1;
            
            model3dImage.style.transition = 'transform 0.3s ease';
            model3dImage.style.transform = `scale(${newScale})`;
            
            console.log(`üîç Zoom del modelo 3D: ${newScale}x`);
        }

        // Funci√≥n para actualizar el modelo 3D cuando se selecciona una estaci√≥n
        function updateModel3D(stationName, lineNumber) {
            if (!stationName || !lineNumber) {
                const model3dSection = document.getElementById('model3dSection');
                if (model3dSection) {
                    model3dSection.style.display = 'none';
                }
                return;
            }
            
            loadModel3D(stationName, lineNumber);
        }

        // Modificar la funci√≥n existente para incluir el modelo 3D
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName) return;
            
            currentStationName = stationName;
            const stationInfo = document.getElementById('stationInfo');
            const refreshBtn = document.getElementById('refreshButton');
            
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            if (refreshBtn) {
                refreshBtn.style.display = 'inline-flex';
            }
            
            // Actualizar nombre de estaci√≥n
            const stationNameElement = document.getElementById('stationName');
            if (stationNameElement) {
                stationNameElement.textContent = stationName;
            }
            
            // Buscar datos de la estaci√≥n para obtener la l√≠nea
            try {
                const searchResponse = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const searchData = await searchResponse.json();
                
                if (searchData && searchData.length > 0) {
                    const stationData = searchData[0];
                    const lineNumber = stationData.linea;
                    
                    // Actualizar ID de estaci√≥n
                    const stationIdElement = document.getElementById('stationId');
                    if (stationIdElement) {
                        stationIdElement.textContent = `ID: ${stationData.id_fijo}`;
                    }
                    
                    // Cargar modelo 3D
                    updateModel3D(stationName, lineNumber);
                    
                    console.log(`üèóÔ∏è Cargando modelo 3D para ${stationName} (L√≠nea ${lineNumber})`);
                }
            } catch (error) {
                console.error('Error obteniendo datos de estaci√≥n para modelo 3D:', error);
            }
            
            // Continuar con el resto de la funcionalidad existente...
            try {
                const response = await fetch(`/api/station/ninjascrap/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                loadIntelligentData(stationName);
                
            } catch (error) {
                console.error('Error en searchStationWithNinjaScrap:', error);
                alert('Error al obtener datos de la estaci√≥n. Int√©ntalo de nuevo.');
            }
        }

        // A√±adir despu√©s de la funci√≥n loadAccessesFromMetroMadrid (l√≠nea 2030):

        function loadAccessesFromGTFS(stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            // Mostrar indicador de carga
            accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde GTFS...</div>';
            
            fetch(`/api/station/accesses/gtfs/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error cargando accesos GTFS:', data.error);
                        accessesContent.innerHTML = '<div class="no-data">No se pudieron cargar los accesos.</div>';
                        return;
                    }
                    
                    if (!data.accesos || data.accesos.length === 0) {
                        accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles para esta estaci√≥n.</div>';
                        return;
                    }
                    
                    // Crear tabla de accesos
                    let html = `<div class="line-data-header">üö™ Accesos - ${data.estacion.nombre}</div>`;
                    html += '<div class="gtfs-badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìä Datos GTFS oficiales</div>';
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ACCESIBLE</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.accesos.forEach(acceso => {
                        const icon = getAccessIcon(acceso.tipo_acceso);
                        const accesibleIcon = acceso.accesible_silla_ruedas ? '‚ôø' : '‚ùå';
                        const accesibleText = acceso.accesible_silla_ruedas ? 'S√≠' : 'No';
                        
                        html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${acceso.vestibulo}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre_acceso}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${accesibleIcon} ${accesibleText}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // A√±adir informaci√≥n de la estaci√≥n
                    html += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">`;
                    html += `<strong>Informaci√≥n de la estaci√≥n:</strong><br>`;
                    html += `üìç Coordenadas: ${data.estacion.latitud}, ${data.estacion.longitud}<br>`;
                    html += `‚ôø Accesibilidad general: ${data.estacion.accesible_silla_ruedas ? 'S√≠' : 'No'}<br>`;
                    html += `üö™ Total de accesos: ${data.estacion.total_accesos}<br>`;
                    html += `üìä Fuente: ${data.fuente}`;
                    html += '</div>';
                    
                    accessesContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error cargando accesos GTFS:', error);
                    accessesContent.innerHTML = '<div class="no-data">Error al cargar los accesos.</div>';
                });
        }

        function getServiceIcon(tipoServicio) {
            const iconMap = {
                'Ascensores': 'üõó',
                'Escaleras mec√°nicas': 'üõó',
                'Desfibrilador': 'üíì',
                'Cobertura m√≥vil': 'üì±',
                'Bibliometro': 'üìö',
                'Tiendas': 'üõçÔ∏è',
                'Estaci√≥n accesible': '‚ôø',
                'Oficina Objetos Perdidos': 'üìã',
                'Oficina de gesti√≥n TTP': 'üí≥',
                'Parking disuasorio de pago': 'üöó',
                'Quioscos ONCE': 'üì∞',
                'adaptada para discapacitados': '‚ôø',
                'escaleras': 'üõó'
            };
            
            return iconMap[tipoServicio] || 'üîß';
        }

        // Funciones legacy para compatibilidad
        function loadServices(services, linea) {
            const servicesContent = document.getElementById('servicesContent');
            if (!servicesContent) return;
            
            if (!services || Object.keys(services).length === 0) {
                servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles.</div>';
                return;
            }
            
            let html = '<div class="services-grid">';
            Object.entries(services).forEach(([service, available]) => {
                const icon = getServiceIcon(service);
                const statusClass = available ? 'service-available' : 'service-unavailable';
                const statusText = available ? 'Disponible' : 'No disponible';
                
                html += `
                    <div class="service-item">
                        <div class="service-icon ${statusClass}">${icon}</div>
                        <div class="service-info">
                            <div class="service-name">${service}</div>
                            <div class="service-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            servicesContent.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES PARA MODELOS 3D
        // ============================================================================

        // Funci√≥n para cargar y mostrar la vista 3D de una estaci√≥n
        async function loadModel3D(stationName, lineNumber) {
            const model3dSection = document.getElementById('model3dSection');
            const model3dImage = document.getElementById('model3dImage');
            
            if (!model3dSection || !model3dImage) {
                console.warn('Elementos de vista 3D no encontrados');
                return;
            }
            
            // Mostrar secci√≥n
            model3dSection.style.display = 'block';
            
            // Normalizar nombre de estaci√≥n para la URL
            function normalizarNombre(nombre) {
                if (!nombre) return "";
                nombre = nombre.toLowerCase();
                nombre = nombre.replace('√°', 'a').replace('√©', 'e').replace('√≠', 'i').replace('√≥', 'o').replace('√∫', 'u').replace('√±', 'n');
                nombre = nombre.replace('√º', 'u').replace('√ß', 'c');
                nombre = nombre.replace(/[^a-z0-9\s]/g, '');
                nombre = nombre.replace(/\s+/g, '_');
                return nombre;
            }
            
            const normalizedName = normalizarNombre(stationName);
            const originalUrl = `http://estacions.albertguillaumes.cat/img/madrid/${normalizedName}.png`;
            
            // Cargar directamente desde la URL original
            model3dImage.src = originalUrl;
            model3dImage.alt = `Vista 3D de ${stationName}`;
            model3dImage.style.display = 'block';
            
            // Actualizar informaci√≥n
            const stationNameSpan = document.querySelector('.model-3d-station-name');
            const lineInfoSpan = document.querySelector('.model-3d-line-info');
            if (stationNameSpan) stationNameSpan.textContent = stationName;
            if (lineInfoSpan) lineInfoSpan.textContent = `L√≠nea ${lineNumber}`;
            
            console.log(`‚úÖ Vista 3D cargada desde: ${originalUrl}`);
            
            // Manejar errores de carga
            model3dImage.onerror = function() {
                console.log(`‚ùå Error cargando vista 3D para ${stationName}`);
                showModel3DPlaceholder(stationName, originalUrl);
            };
        }
        
        // Funci√≥n para mostrar placeholder cuando no hay vista 3D
        function showModel3DPlaceholder(stationName, downloadUrl = null) {
            const model3dSection = document.getElementById('model3dSection');
            if (!model3dSection) return;
            
            const placeholderHTML = `
                <div class="model-3d-not-available">
                    <div class="model-3d-placeholder">
                        <div class="model-3d-icon">üèóÔ∏è</div>
                        <h4>Vista 3D no disponible</h4>
                        <p>No hay una vista 3D disponible para la estaci√≥n <strong>${stationName}</strong>.</p>
                        ${downloadUrl ? `
                            <button class="btn btn-primary" onclick="downloadModel3D('${stationName}')">
                                üì• Descargar Vista 3D
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            model3dSection.innerHTML = placeholderHTML;
            console.log(`‚ö†Ô∏è Vista 3D no disponible para ${stationName}`);
        }
        
        // Funci√≥n para descargar vista 3D
        async function downloadModel3D(stationName) {
            try {
                console.log(`üì• Descargando vista 3D para ${stationName}...`);
                
                const response = await fetch(`/api/station/model3d/download/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Vista 3D descargada: ${data.local_path}`);
                    // Recargar la vista 3D despu√©s de descargar
                    const stationData = await getStationData(stationName);
                    if (stationData && stationData.lines && stationData.lines.length > 0) {
                        loadModel3D(stationName, stationData.lines[0].short_name);
                    }
                } else {
                    console.error('Error descargando vista 3D:', data.error);
                    alert('Error al descargar la vista 3D. Int√©ntalo de nuevo.');
                }
                
            } catch (error) {
                console.error('Error en descarga:', error);
                alert('Error al descargar la vista 3D.');
            }
        }

        // Funci√≥n para rotar la vista del modelo 3D
        function rotateModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            // A√±adir clase de rotaci√≥n
            model3dImage.style.transition = 'transform 0.5s ease';
            model3dImage.style.transform = 'rotateY(180deg)';
            
            // Restaurar despu√©s de la animaci√≥n
            setTimeout(() => {
                model3dImage.style.transform = 'rotateY(0deg)';
            }, 500);
            
            console.log('üîÑ Rotando vista del modelo 3D');
        }

        // Funci√≥n para hacer zoom en el modelo 3D
        function zoomModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            const currentScale = model3dImage.style.transform.includes('scale') 
                ? parseFloat(model3dImage.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1)
                : 1;
            
            const newScale = currentScale === 1 ? 1.5 : 1;
            
            model3dImage.style.transition = 'transform 0.3s ease';
            model3dImage.style.transform = `scale(${newScale})`;
            
            console.log(`üîç Zoom del modelo 3D: ${newScale}x`);
        }

        // Funci√≥n para actualizar el modelo 3D cuando se selecciona una estaci√≥n
        function updateModel3D(stationName, lineNumber) {
            if (!stationName || !lineNumber) {
                const model3dSection = document.getElementById('model3dSection');
                if (model3dSection) {
                    model3dSection.style.display = 'none';
                }
                return;
            }
            
            loadModel3D(stationName, lineNumber);
        }

        // Modificar la funci√≥n existente para incluir el modelo 3D
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName) return;
            
            currentStationName = stationName;
            const stationInfo = document.getElementById('stationInfo');
            const refreshBtn = document.getElementById('refreshButton');
            
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            if (refreshBtn) {
                refreshBtn.style.display = 'inline-flex';
            }
            
            // Actualizar nombre de estaci√≥n
            const stationNameElement = document.getElementById('stationName');
            if (stationNameElement) {
                stationNameElement.textContent = stationName;
            }
            
            // Buscar datos de la estaci√≥n para obtener la l√≠nea
            try {
                const searchResponse = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const searchData = await searchResponse.json();
                
                if (searchData && searchData.length > 0) {
                    const stationData = searchData[0];
                    const lineNumber = stationData.linea;
                    
                    // Actualizar ID de estaci√≥n
                    const stationIdElement = document.getElementById('stationId');
                    if (stationIdElement) {
                        stationIdElement.textContent = `ID: ${stationData.id_fijo}`;
                    }
                    
                    // Cargar modelo 3D
                    updateModel3D(stationName, lineNumber);
                    
                    console.log(`üèóÔ∏è Cargando modelo 3D para ${stationName} (L√≠nea ${lineNumber})`);
                }
            } catch (error) {
                console.error('Error obteniendo datos de estaci√≥n para modelo 3D:', error);
            }
            
            // Continuar con el resto de la funcionalidad existente...
            try {
                const response = await fetch(`/api/station/ninjascrap/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                loadIntelligentData(stationName);
                
            } catch (error) {
                console.error('Error en searchStationWithNinjaScrap:', error);
                alert('Error al obtener datos de la estaci√≥n. Int√©ntalo de nuevo.');
            }
        }

        // A√±adir despu√©s de la funci√≥n loadAccessesFromMetroMadrid (l√≠nea 2030):

        function loadAccessesFromGTFS(stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            // Mostrar indicador de carga
            accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde GTFS...</div>';
            
            fetch(`/api/station/accesses/gtfs/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error cargando accesos GTFS:', data.error);
                        accessesContent.innerHTML = '<div class="no-data">No se pudieron cargar los accesos.</div>';
                        return;
                    }
                    
                    if (!data.accesos || data.accesos.length === 0) {
                        accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles para esta estaci√≥n.</div>';
                        return;
                    }
                    
                    // Crear tabla de accesos
                    let html = `<div class="line-data-header">üö™ Accesos - ${data.estacion.nombre}</div>`;
                    html += '<div class="gtfs-badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìä Datos GTFS oficiales</div>';
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ACCESIBLE</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.accesos.forEach(acceso => {
                        const icon = getAccessIcon(acceso.tipo_acceso);
                        const accesibleIcon = acceso.accesible_silla_ruedas ? '‚ôø' : '‚ùå';
                        const accesibleText = acceso.accesible_silla_ruedas ? 'S√≠' : 'No';
                        
                        html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${acceso.vestibulo}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre_acceso}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${accesibleIcon} ${accesibleText}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // A√±adir informaci√≥n de la estaci√≥n
                    html += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">`;
                    html += `<strong>Informaci√≥n de la estaci√≥n:</strong><br>`;
                    html += `üìç Coordenadas: ${data.estacion.latitud}, ${data.estacion.longitud}<br>`;
                    html += `‚ôø Accesibilidad general: ${data.estacion.accesible_silla_ruedas ? 'S√≠' : 'No'}<br>`;
                    html += `üö™ Total de accesos: ${data.estacion.total_accesos}<br>`;
                    html += `üìä Fuente: ${data.fuente}`;
                    html += '</div>';
                    
                    accessesContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error cargando accesos GTFS:', error);
                    accessesContent.innerHTML = '<div class="no-data">Error al cargar los accesos.</div>';
                });
        }

        function getServiceIcon(tipoServicio) {
            const iconMap = {
                'Ascensores': 'üõó',
                'Escaleras mec√°nicas': 'üõó',
                'Desfibrilador': 'üíì',
                'Cobertura m√≥vil': 'üì±',
                'Bibliometro': 'üìö',
                'Tiendas': 'üõçÔ∏è',
                'Estaci√≥n accesible': '‚ôø',
                'Oficina Objetos Perdidos': 'üìã',
                'Oficina de gesti√≥n TTP': 'üí≥',
                'Parking disuasorio de pago': 'üöó',
                'Quioscos ONCE': 'üì∞',
                'adaptada para discapacitados': '‚ôø',
                'escaleras': 'üõó'
            };
            
            return iconMap[tipoServicio] || 'üîß';
        }

        // Funciones legacy para compatibilidad
        function loadServices(services, linea) {
            const servicesContent = document.getElementById('servicesContent');
            if (!servicesContent) return;
            
            if (!services || Object.keys(services).length === 0) {
                servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles.</div>';
                return;
            }
            
            let html = '<div class="services-grid">';
            Object.entries(services).forEach(([service, available]) => {
                const icon = getServiceIcon(service);
                const statusClass = available ? 'service-available' : 'service-unavailable';
                const statusText = available ? 'Disponible' : 'No disponible';
                
                html += `
                    <div class="service-item">
                        <div class="service-icon ${statusClass}">${icon}</div>
                        <div class="service-info">
                            <div class="service-name">${service}</div>
                            <div class="service-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            servicesContent.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES PARA MODELOS 3D
        // ============================================================================

        // Funci√≥n para cargar y mostrar la vista 3D de una estaci√≥n
        async function loadModel3D(stationName, lineNumber) {
            const model3dSection = document.getElementById('model3dSection');
            const model3dImage = document.getElementById('model3dImage');
            
            if (!model3dSection || !model3dImage) {
                console.warn('Elementos de vista 3D no encontrados');
                return;
            }
            
            // Mostrar secci√≥n
            model3dSection.style.display = 'block';
            
            // Normalizar nombre de estaci√≥n para la URL
            function normalizarNombre(nombre) {
                if (!nombre) return "";
                nombre = nombre.toLowerCase();
                nombre = nombre.replace('√°', 'a').replace('√©', 'e').replace('√≠', 'i').replace('√≥', 'o').replace('√∫', 'u').replace('√±', 'n');
                nombre = nombre.replace('√º', 'u').replace('√ß', 'c');
                nombre = nombre.replace(/[^a-z0-9\s]/g, '');
                nombre = nombre.replace(/\s+/g, '_');
                return nombre;
            }
            
            const normalizedName = normalizarNombre(stationName);
            const originalUrl = `http://estacions.albertguillaumes.cat/img/madrid/${normalizedName}.png`;
            
            // Cargar directamente desde la URL original
            model3dImage.src = originalUrl;
            model3dImage.alt = `Vista 3D de ${stationName}`;
            model3dImage.style.display = 'block';
            
            // Actualizar informaci√≥n
            const stationNameSpan = document.querySelector('.model-3d-station-name');
            const lineInfoSpan = document.querySelector('.model-3d-line-info');
            if (stationNameSpan) stationNameSpan.textContent = stationName;
            if (lineInfoSpan) lineInfoSpan.textContent = `L√≠nea ${lineNumber}`;
            
            console.log(`‚úÖ Vista 3D cargada desde: ${originalUrl}`);
            
            // Manejar errores de carga
            model3dImage.onerror = function() {
                console.log(`‚ùå Error cargando vista 3D para ${stationName}`);
                showModel3DPlaceholder(stationName, originalUrl);
            };
        }
        
        // Funci√≥n para mostrar placeholder cuando no hay vista 3D
        function showModel3DPlaceholder(stationName, downloadUrl = null) {
            const model3dSection = document.getElementById('model3dSection');
            if (!model3dSection) return;
            
            const placeholderHTML = `
                <div class="model-3d-not-available">
                    <div class="model-3d-placeholder">
                        <div class="model-3d-icon">üèóÔ∏è</div>
                        <h4>Vista 3D no disponible</h4>
                        <p>No hay una vista 3D disponible para la estaci√≥n <strong>${stationName}</strong>.</p>
                        ${downloadUrl ? `
                            <button class="btn btn-primary" onclick="downloadModel3D('${stationName}')">
                                üì• Descargar Vista 3D
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            model3dSection.innerHTML = placeholderHTML;
            console.log(`‚ö†Ô∏è Vista 3D no disponible para ${stationName}`);
        }
        
        // Funci√≥n para descargar vista 3D
        async function downloadModel3D(stationName) {
            try {
                console.log(`üì• Descargando vista 3D para ${stationName}...`);
                
                const response = await fetch(`/api/station/model3d/download/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Vista 3D descargada: ${data.local_path}`);
                    // Recargar la vista 3D despu√©s de descargar
                    const stationData = await getStationData(stationName);
                    if (stationData && stationData.lines && stationData.lines.length > 0) {
                        loadModel3D(stationName, stationData.lines[0].short_name);
                    }
                } else {
                    console.error('Error descargando vista 3D:', data.error);
                    alert('Error al descargar la vista 3D. Int√©ntalo de nuevo.');
                }
                
            } catch (error) {
                console.error('Error en descarga:', error);
                alert('Error al descargar la vista 3D.');
            }
        }

        // Funci√≥n para rotar la vista del modelo 3D
        function rotateModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            // A√±adir clase de rotaci√≥n
            model3dImage.style.transition = 'transform 0.5s ease';
            model3dImage.style.transform = 'rotateY(180deg)';
            
            // Restaurar despu√©s de la animaci√≥n
            setTimeout(() => {
                model3dImage.style.transform = 'rotateY(0deg)';
            }, 500);
            
            console.log('üîÑ Rotando vista del modelo 3D');
        }

        // Funci√≥n para hacer zoom en el modelo 3D
        function zoomModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            const currentScale = model3dImage.style.transform.includes('scale') 
                ? parseFloat(model3dImage.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1)
                : 1;
            
            const newScale = currentScale === 1 ? 1.5 : 1;
            
            model3dImage.style.transition = 'transform 0.3s ease';
            model3dImage.style.transform = `scale(${newScale})`;
            
            console.log(`üîç Zoom del modelo 3D: ${newScale}x`);
        }

        // Funci√≥n para actualizar el modelo 3D cuando se selecciona una estaci√≥n
        function updateModel3D(stationName, lineNumber) {
            if (!stationName || !lineNumber) {
                const model3dSection = document.getElementById('model3dSection');
                if (model3dSection) {
                    model3dSection.style.display = 'none';
                }
                return;
            }
            
            loadModel3D(stationName, lineNumber);
        }

        // Modificar la funci√≥n existente para incluir el modelo 3D
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName) return;
            
            currentStationName = stationName;
            const stationInfo = document.getElementById('stationInfo');
            const refreshBtn = document.getElementById('refreshButton');
            
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            if (refreshBtn) {
                refreshBtn.style.display = 'inline-flex';
            }
            
            // Actualizar nombre de estaci√≥n
            const stationNameElement = document.getElementById('stationName');
            if (stationNameElement) {
                stationNameElement.textContent = stationName;
            }
            
            // Buscar datos de la estaci√≥n para obtener la l√≠nea
            try {
                const searchResponse = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const searchData = await searchResponse.json();
                
                if (searchData && searchData.length > 0) {
                    const stationData = searchData[0];
                    const lineNumber = stationData.linea;
                    
                    // Actualizar ID de estaci√≥n
                    const stationIdElement = document.getElementById('stationId');
                    if (stationIdElement) {
                        stationIdElement.textContent = `ID: ${stationData.id_fijo}`;
                    }
                    
                    // Cargar modelo 3D
                    updateModel3D(stationName, lineNumber);
                    
                    console.log(`üèóÔ∏è Cargando modelo 3D para ${stationName} (L√≠nea ${lineNumber})`);
                }
            } catch (error) {
                console.error('Error obteniendo datos de estaci√≥n para modelo 3D:', error);
            }
            
            // Continuar con el resto de la funcionalidad existente...
            try {
                const response = await fetch(`/api/station/ninjascrap/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                loadIntelligentData(stationName);
                
            } catch (error) {
                console.error('Error en searchStationWithNinjaScrap:', error);
                alert('Error al obtener datos de la estaci√≥n. Int√©ntalo de nuevo.');
            }
        }

        // A√±adir despu√©s de la funci√≥n loadAccessesFromMetroMadrid (l√≠nea 2030):

        function loadAccessesFromGTFS(stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            // Mostrar indicador de carga
            accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde GTFS...</div>';
            
            fetch(`/api/station/accesses/gtfs/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error cargando accesos GTFS:', data.error);
                        accessesContent.innerHTML = '<div class="no-data">No se pudieron cargar los accesos.</div>';
                        return;
                    }
                    
                    if (!data.accesos || data.accesos.length === 0) {
                        accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles para esta estaci√≥n.</div>';
                        return;
                    }
                    
                    // Crear tabla de accesos
                    let html = `<div class="line-data-header">üö™ Accesos - ${data.estacion.nombre}</div>`;
                    html += '<div class="gtfs-badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìä Datos GTFS oficiales</div>';
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ACCESIBLE</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.accesos.forEach(acceso => {
                        const icon = getAccessIcon(acceso.tipo_acceso);
                        const accesibleIcon = acceso.accesible_silla_ruedas ? '‚ôø' : '‚ùå';
                        const accesibleText = acceso.accesible_silla_ruedas ? 'S√≠' : 'No';
                        
                        html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${acceso.vestibulo}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre_acceso}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${accesibleIcon} ${accesibleText}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // A√±adir informaci√≥n de la estaci√≥n
                    html += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">`;
                    html += `<strong>Informaci√≥n de la estaci√≥n:</strong><br>`;
                    html += `üìç Coordenadas: ${data.estacion.latitud}, ${data.estacion.longitud}<br>`;
                    html += `‚ôø Accesibilidad general: ${data.estacion.accesible_silla_ruedas ? 'S√≠' : 'No'}<br>`;
                    html += `üö™ Total de accesos: ${data.estacion.total_accesos}<br>`;
                    html += `üìä Fuente: ${data.fuente}`;
                    html += '</div>';
                    
                    accessesContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error cargando accesos GTFS:', error);
                    accessesContent.innerHTML = '<div class="no-data">Error al cargar los accesos.</div>';
                });
        }

        function getServiceIcon(tipoServicio) {
            const iconMap = {
                'Ascensores': 'üõó',
                'Escaleras mec√°nicas': 'üõó',
                'Desfibrilador': 'üíì',
                'Cobertura m√≥vil': 'üì±',
                'Bibliometro': 'üìö',
                'Tiendas': 'üõçÔ∏è',
                'Estaci√≥n accesible': '‚ôø',
                'Oficina Objetos Perdidos': 'üìã',
                'Oficina de gesti√≥n TTP': 'üí≥',
                'Parking disuasorio de pago': 'üöó',
                'Quioscos ONCE': 'üì∞',
                'adaptada para discapacitados': '‚ôø',
                'escaleras': 'üõó'
            };
            
            return iconMap[tipoServicio] || 'üîß';
        }

        // Funciones legacy para compatibilidad
        function loadServices(services, linea) {
            const servicesContent = document.getElementById('servicesContent');
            if (!servicesContent) return;
            
            if (!services || Object.keys(services).length === 0) {
                servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles.</div>';
                return;
            }
            
            let html = '<div class="services-grid">';
            Object.entries(services).forEach(([service, available]) => {
                const icon = getServiceIcon(service);
                const statusClass = available ? 'service-available' : 'service-unavailable';
                const statusText = available ? 'Disponible' : 'No disponible';
                
                html += `
                    <div class="service-item">
                        <div class="service-icon ${statusClass}">${icon}</div>
                        <div class="service-info">
                            <div class="service-name">${service}</div>
                            <div class="service-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            servicesContent.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES PARA MODELOS 3D
        // ============================================================================

        // Funci√≥n para cargar y mostrar la vista 3D de una estaci√≥n
        async function loadModel3D(stationName, lineNumber) {
            const model3dSection = document.getElementById('model3dSection');
            const model3dImage = document.getElementById('model3dImage');
            
            if (!model3dSection || !model3dImage) {
                console.warn('Elementos de vista 3D no encontrados');
                return;
            }
            
            // Mostrar secci√≥n
            model3dSection.style.display = 'block';
            
            // Normalizar nombre de estaci√≥n para la URL
            function normalizarNombre(nombre) {
                if (!nombre) return "";
                nombre = nombre.toLowerCase();
                nombre = nombre.replace('√°', 'a').replace('√©', 'e').replace('√≠', 'i').replace('√≥', 'o').replace('√∫', 'u').replace('√±', 'n');
                nombre = nombre.replace('√º', 'u').replace('√ß', 'c');
                nombre = nombre.replace(/[^a-z0-9\s]/g, '');
                nombre = nombre.replace(/\s+/g, '_');
                return nombre;
            }
            
            const normalizedName = normalizarNombre(stationName);
            const originalUrl = `http://estacions.albertguillaumes.cat/img/madrid/${normalizedName}.png`;
            
            // Cargar directamente desde la URL original
            model3dImage.src = originalUrl;
            model3dImage.alt = `Vista 3D de ${stationName}`;
            model3dImage.style.display = 'block';
            
            // Actualizar informaci√≥n
            const stationNameSpan = document.querySelector('.model-3d-station-name');
            const lineInfoSpan = document.querySelector('.model-3d-line-info');
            if (stationNameSpan) stationNameSpan.textContent = stationName;
            if (lineInfoSpan) lineInfoSpan.textContent = `L√≠nea ${lineNumber}`;
            
            console.log(`‚úÖ Vista 3D cargada desde: ${originalUrl}`);
            
            // Manejar errores de carga
            model3dImage.onerror = function() {
                console.log(`‚ùå Error cargando vista 3D para ${stationName}`);
                showModel3DPlaceholder(stationName, originalUrl);
            };
        }
        
        // Funci√≥n para mostrar placeholder cuando no hay vista 3D
        function showModel3DPlaceholder(stationName, downloadUrl = null) {
            const model3dSection = document.getElementById('model3dSection');
            if (!model3dSection) return;
            
            const placeholderHTML = `
                <div class="model-3d-not-available">
                    <div class="model-3d-placeholder">
                        <div class="model-3d-icon">üèóÔ∏è</div>
                        <h4>Vista 3D no disponible</h4>
                        <p>No hay una vista 3D disponible para la estaci√≥n <strong>${stationName}</strong>.</p>
                        ${downloadUrl ? `
                            <button class="btn btn-primary" onclick="downloadModel3D('${stationName}')">
                                üì• Descargar Vista 3D
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            model3dSection.innerHTML = placeholderHTML;
            console.log(`‚ö†Ô∏è Vista 3D no disponible para ${stationName}`);
        }
        
        // Funci√≥n para descargar vista 3D
        async function downloadModel3D(stationName) {
            try {
                console.log(`üì• Descargando vista 3D para ${stationName}...`);
                
                const response = await fetch(`/api/station/model3d/download/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Vista 3D descargada: ${data.local_path}`);
                    // Recargar la vista 3D despu√©s de descargar
                    const stationData = await getStationData(stationName);
                    if (stationData && stationData.lines && stationData.lines.length > 0) {
                        loadModel3D(stationName, stationData.lines[0].short_name);
                    }
                } else {
                    console.error('Error descargando vista 3D:', data.error);
                    alert('Error al descargar la vista 3D. Int√©ntalo de nuevo.');
                }
                
            } catch (error) {
                console.error('Error en descarga:', error);
                alert('Error al descargar la vista 3D.');
            }
        }

        // Funci√≥n para rotar la vista del modelo 3D
        function rotateModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            // A√±adir clase de rotaci√≥n
            model3dImage.style.transition = 'transform 0.5s ease';
            model3dImage.style.transform = 'rotateY(180deg)';
            
            // Restaurar despu√©s de la animaci√≥n
            setTimeout(() => {
                model3dImage.style.transform = 'rotateY(0deg)';
            }, 500);
            
            console.log('üîÑ Rotando vista del modelo 3D');
        }

        // Funci√≥n para hacer zoom en el modelo 3D
        function zoomModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            const currentScale = model3dImage.style.transform.includes('scale') 
                ? parseFloat(model3dImage.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1)
                : 1;
            
            const newScale = currentScale === 1 ? 1.5 : 1;
            
            model3dImage.style.transition = 'transform 0.3s ease';
            model3dImage.style.transform = `scale(${newScale})`;
            
            console.log(`üîç Zoom del modelo 3D: ${newScale}x`);
        }

        // Funci√≥n para actualizar el modelo 3D cuando se selecciona una estaci√≥n
        function updateModel3D(stationName, lineNumber) {
            if (!stationName || !lineNumber) {
                const model3dSection = document.getElementById('model3dSection');
                if (model3dSection) {
                    model3dSection.style.display = 'none';
                }
                return;
            }
            
            loadModel3D(stationName, lineNumber);
        }

        // Modificar la funci√≥n existente para incluir el modelo 3D
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName) return;
            
            currentStationName = stationName;
            const stationInfo = document.getElementById('stationInfo');
            const refreshBtn = document.getElementById('refreshButton');
            
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            if (refreshBtn) {
                refreshBtn.style.display = 'inline-flex';
            }
            
            // Actualizar nombre de estaci√≥n
            const stationNameElement = document.getElementById('stationName');
            if (stationNameElement) {
                stationNameElement.textContent = stationName;
            }
            
            // Buscar datos de la estaci√≥n para obtener la l√≠nea
            try {
                const searchResponse = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const searchData = await searchResponse.json();
                
                if (searchData && searchData.length > 0) {
                    const stationData = searchData[0];
                    const lineNumber = stationData.linea;
                    
                    // Actualizar ID de estaci√≥n
                    const stationIdElement = document.getElementById('stationId');
                    if (stationIdElement) {
                        stationIdElement.textContent = `ID: ${stationData.id_fijo}`;
                    }
                    
                    // Cargar modelo 3D
                    updateModel3D(stationName, lineNumber);
                    
                    console.log(`üèóÔ∏è Cargando modelo 3D para ${stationName} (L√≠nea ${lineNumber})`);
                }
            } catch (error) {
                console.error('Error obteniendo datos de estaci√≥n para modelo 3D:', error);
            }
            
            // Continuar con el resto de la funcionalidad existente...
            try {
                const response = await fetch(`/api/station/ninjascrap/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                loadIntelligentData(stationName);
                
            } catch (error) {
                console.error('Error en searchStationWithNinjaScrap:', error);
                alert('Error al obtener datos de la estaci√≥n. Int√©ntalo de nuevo.');
            }
        }

        // A√±adir despu√©s de la funci√≥n loadAccessesFromMetroMadrid (l√≠nea 2030):

        function loadAccessesFromGTFS(stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            // Mostrar indicador de carga
            accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde GTFS...</div>';
            
            fetch(`/api/station/accesses/gtfs/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error cargando accesos GTFS:', data.error);
                        accessesContent.innerHTML = '<div class="no-data">No se pudieron cargar los accesos.</div>';
                        return;
                    }
                    
                    if (!data.accesos || data.accesos.length === 0) {
                        accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles para esta estaci√≥n.</div>';
                        return;
                    }
                    
                    // Crear tabla de accesos
                    let html = `<div class="line-data-header">üö™ Accesos - ${data.estacion.nombre}</div>`;
                    html += '<div class="gtfs-badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìä Datos GTFS oficiales</div>';
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ACCESIBLE</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.accesos.forEach(acceso => {
                        const icon = getAccessIcon(acceso.tipo_acceso);
                        const accesibleIcon = acceso.accesible_silla_ruedas ? '‚ôø' : '‚ùå';
                        const accesibleText = acceso.accesible_silla_ruedas ? 'S√≠' : 'No';
                        
                        html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${acceso.vestibulo}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre_acceso}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${accesibleIcon} ${accesibleText}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // A√±adir informaci√≥n de la estaci√≥n
                    html += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">`;
                    html += `<strong>Informaci√≥n de la estaci√≥n:</strong><br>`;
                    html += `üìç Coordenadas: ${data.estacion.latitud}, ${data.estacion.longitud}<br>`;
                    html += `‚ôø Accesibilidad general: ${data.estacion.accesible_silla_ruedas ? 'S√≠' : 'No'}<br>`;
                    html += `üö™ Total de accesos: ${data.estacion.total_accesos}<br>`;
                    html += `üìä Fuente: ${data.fuente}`;
                    html += '</div>';
                    
                    accessesContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error cargando accesos GTFS:', error);
                    accessesContent.innerHTML = '<div class="no-data">Error al cargar los accesos.</div>';
                });
        }

        function getServiceIcon(tipoServicio) {
            const iconMap = {
                'Ascensores': 'üõó',
                'Escaleras mec√°nicas': 'üõó',
                'Desfibrilador': 'üíì',
                'Cobertura m√≥vil': 'üì±',
                'Bibliometro': 'üìö',
                'Tiendas': 'üõçÔ∏è',
                'Estaci√≥n accesible': '‚ôø',
                'Oficina Objetos Perdidos': 'üìã',
                'Oficina de gesti√≥n TTP': 'üí≥',
                'Parking disuasorio de pago': 'üöó',
                'Quioscos ONCE': 'üì∞',
                'adaptada para discapacitados': '‚ôø',
                'escaleras': 'üõó'
            };
            
            return iconMap[tipoServicio] || 'üîß';
        }

        // Funciones legacy para compatibilidad
        function loadServices(services, linea) {
            const servicesContent = document.getElementById('servicesContent');
            if (!servicesContent) return;
            
            if (!services || Object.keys(services).length === 0) {
                servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles.</div>';
                return;
            }
            
            let html = '<div class="services-grid">';
            Object.entries(services).forEach(([service, available]) => {
                const icon = getServiceIcon(service);
                const statusClass = available ? 'service-available' : 'service-unavailable';
                const statusText = available ? 'Disponible' : 'No disponible';
                
                html += `
                    <div class="service-item">
                        <div class="service-icon ${statusClass}">${icon}</div>
                        <div class="service-info">
                            <div class="service-name">${service}</div>
                            <div class="service-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            servicesContent.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES PARA MODELOS 3D
        // ============================================================================

        // Funci√≥n para cargar y mostrar la vista 3D de una estaci√≥n
        async function loadModel3D(stationName, lineNumber) {
            const model3dSection = document.getElementById('model3dSection');
            const model3dImage = document.getElementById('model3dImage');
            
            if (!model3dSection || !model3dImage) {
                console.warn('Elementos de vista 3D no encontrados');
                return;
            }
            
            // Mostrar secci√≥n
            model3dSection.style.display = 'block';
            
            // Normalizar nombre de estaci√≥n para la URL
            function normalizarNombre(nombre) {
                if (!nombre) return "";
                nombre = nombre.toLowerCase();
                nombre = nombre.replace('√°', 'a').replace('√©', 'e').replace('√≠', 'i').replace('√≥', 'o').replace('√∫', 'u').replace('√±', 'n');
                nombre = nombre.replace('√º', 'u').replace('√ß', 'c');
                nombre = nombre.replace(/[^a-z0-9\s]/g, '');
                nombre = nombre.replace(/\s+/g, '_');
                return nombre;
            }
            
            const normalizedName = normalizarNombre(stationName);
            const originalUrl = `http://estacions.albertguillaumes.cat/img/madrid/${normalizedName}.png`;
            
            // Cargar directamente desde la URL original
            model3dImage.src = originalUrl;
            model3dImage.alt = `Vista 3D de ${stationName}`;
            model3dImage.style.display = 'block';
            
            // Actualizar informaci√≥n
            const stationNameSpan = document.querySelector('.model-3d-station-name');
            const lineInfoSpan = document.querySelector('.model-3d-line-info');
            if (stationNameSpan) stationNameSpan.textContent = stationName;
            if (lineInfoSpan) lineInfoSpan.textContent = `L√≠nea ${lineNumber}`;
            
            console.log(`‚úÖ Vista 3D cargada desde: ${originalUrl}`);
            
            // Manejar errores de carga
            model3dImage.onerror = function() {
                console.log(`‚ùå Error cargando vista 3D para ${stationName}`);
                showModel3DPlaceholder(stationName, originalUrl);
            };
        }
        
        // Funci√≥n para mostrar placeholder cuando no hay vista 3D
        function showModel3DPlaceholder(stationName, downloadUrl = null) {
            const model3dSection = document.getElementById('model3dSection');
            if (!model3dSection) return;
            
            const placeholderHTML = `
                <div class="model-3d-not-available">
                    <div class="model-3d-placeholder">
                        <div class="model-3d-icon">üèóÔ∏è</div>
                        <h4>Vista 3D no disponible</h4>
                        <p>No hay una vista 3D disponible para la estaci√≥n <strong>${stationName}</strong>.</p>
                        ${downloadUrl ? `
                            <button class="btn btn-primary" onclick="downloadModel3D('${stationName}')">
                                üì• Descargar Vista 3D
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            model3dSection.innerHTML = placeholderHTML;
            console.log(`‚ö†Ô∏è Vista 3D no disponible para ${stationName}`);
        }
        
        // Funci√≥n para descargar vista 3D
        async function downloadModel3D(stationName) {
            try {
                console.log(`üì• Descargando vista 3D para ${stationName}...`);
                
                const response = await fetch(`/api/station/model3d/download/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Vista 3D descargada: ${data.local_path}`);
                    // Recargar la vista 3D despu√©s de descargar
                    const stationData = await getStationData(stationName);
                    if (stationData && stationData.lines && stationData.lines.length > 0) {
                        loadModel3D(stationName, stationData.lines[0].short_name);
                    }
                } else {
                    console.error('Error descargando vista 3D:', data.error);
                    alert('Error al descargar la vista 3D. Int√©ntalo de nuevo.');
                }
                
            } catch (error) {
                console.error('Error en descarga:', error);
                alert('Error al descargar la vista 3D.');
            }
        }

        // Funci√≥n para rotar la vista del modelo 3D
        function rotateModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            // A√±adir clase de rotaci√≥n
            model3dImage.style.transition = 'transform 0.5s ease';
            model3dImage.style.transform = 'rotateY(180deg)';
            
            // Restaurar despu√©s de la animaci√≥n
            setTimeout(() => {
                model3dImage.style.transform = 'rotateY(0deg)';
            }, 500);
            
            console.log('üîÑ Rotando vista del modelo 3D');
        }

        // Funci√≥n para hacer zoom en el modelo 3D
        function zoomModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            const currentScale = model3dImage.style.transform.includes('scale') 
                ? parseFloat(model3dImage.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1)
                : 1;
            
            const newScale = currentScale === 1 ? 1.5 : 1;
            
            model3dImage.style.transition = 'transform 0.3s ease';
            model3dImage.style.transform = `scale(${newScale})`;
            
            console.log(`üîç Zoom del modelo 3D: ${newScale}x`);
        }

        // Funci√≥n para actualizar el modelo 3D cuando se selecciona una estaci√≥n
        function updateModel3D(stationName, lineNumber) {
            if (!stationName || !lineNumber) {
                const model3dSection = document.getElementById('model3dSection');
                if (model3dSection) {
                    model3dSection.style.display = 'none';
                }
                return;
            }
            
            loadModel3D(stationName, lineNumber);
        }

        // Modificar la funci√≥n existente para incluir el modelo 3D
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName) return;
            
            currentStationName = stationName;
            const stationInfo = document.getElementById('stationInfo');
            const refreshBtn = document.getElementById('refreshButton');
            
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            if (refreshBtn) {
                refreshBtn.style.display = 'inline-flex';
            }
            
            // Actualizar nombre de estaci√≥n
            const stationNameElement = document.getElementById('stationName');
            if (stationNameElement) {
                stationNameElement.textContent = stationName;
            }
            
            // Buscar datos de la estaci√≥n para obtener la l√≠nea
            try {
                const searchResponse = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const searchData = await searchResponse.json();
                
                if (searchData && searchData.length > 0) {
                    const stationData = searchData[0];
                    const lineNumber = stationData.linea;
                    
                    // Actualizar ID de estaci√≥n
                    const stationIdElement = document.getElementById('stationId');
                    if (stationIdElement) {
                        stationIdElement.textContent = `ID: ${stationData.id_fijo}`;
                    }
                    
                    // Cargar modelo 3D
                    updateModel3D(stationName, lineNumber);
                    
                    console.log(`üèóÔ∏è Cargando modelo 3D para ${stationName} (L√≠nea ${lineNumber})`);
                }
            } catch (error) {
                console.error('Error obteniendo datos de estaci√≥n para modelo 3D:', error);
            }
            
            // Continuar con el resto de la funcionalidad existente...
            try {
                const response = await fetch(`/api/station/ninjascrap/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                loadIntelligentData(stationName);
                
            } catch (error) {
                console.error('Error en searchStationWithNinjaScrap:', error);
                alert('Error al obtener datos de la estaci√≥n. Int√©ntalo de nuevo.');
            }
        }

        // A√±adir despu√©s de la funci√≥n loadAccessesFromMetroMadrid (l√≠nea 2030):

        function loadAccessesFromGTFS(stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            // Mostrar indicador de carga
            accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde GTFS...</div>';
            
            fetch(`/api/station/accesses/gtfs/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error cargando accesos GTFS:', data.error);
                        accessesContent.innerHTML = '<div class="no-data">No se pudieron cargar los accesos.</div>';
                        return;
                    }
                    
                    if (!data.accesos || data.accesos.length === 0) {
                        accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles para esta estaci√≥n.</div>';
                        return;
                    }
                    
                    // Crear tabla de accesos
                    let html = `<div class="line-data-header">üö™ Accesos - ${data.estacion.nombre}</div>`;
                    html += '<div class="gtfs-badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìä Datos GTFS oficiales</div>';
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ACCESIBLE</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.accesos.forEach(acceso => {
                        const icon = getAccessIcon(acceso.tipo_acceso);
                        const accesibleIcon = acceso.accesible_silla_ruedas ? '‚ôø' : '‚ùå';
                        const accesibleText = acceso.accesible_silla_ruedas ? 'S√≠' : 'No';
                        
                        html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${acceso.vestibulo}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre_acceso}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${accesibleIcon} ${accesibleText}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // A√±adir informaci√≥n de la estaci√≥n
                    html += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">`;
                    html += `<strong>Informaci√≥n de la estaci√≥n:</strong><br>`;
                    html += `üìç Coordenadas: ${data.estacion.latitud}, ${data.estacion.longitud}<br>`;
                    html += `‚ôø Accesibilidad general: ${data.estacion.accesible_silla_ruedas ? 'S√≠' : 'No'}<br>`;
                    html += `üö™ Total de accesos: ${data.estacion.total_accesos}<br>`;
                    html += `üìä Fuente: ${data.fuente}`;
                    html += '</div>';
                    
                    accessesContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error cargando accesos GTFS:', error);
                    accessesContent.innerHTML = '<div class="no-data">Error al cargar los accesos.</div>';
                });
        }

        function getServiceIcon(tipoServicio) {
            const iconMap = {
                'Ascensores': 'üõó',
                'Escaleras mec√°nicas': 'üõó',
                'Desfibrilador': 'üíì',
                'Cobertura m√≥vil': 'üì±',
                'Bibliometro': 'üìö',
                'Tiendas': 'üõçÔ∏è',
                'Estaci√≥n accesible': '‚ôø',
                'Oficina Objetos Perdidos': 'üìã',
                'Oficina de gesti√≥n TTP': 'üí≥',
                'Parking disuasorio de pago': 'üöó',
                'Quioscos ONCE': 'üì∞',
                'adaptada para discapacitados': '‚ôø',
                'escaleras': 'üõó'
            };
            
            return iconMap[tipoServicio] || 'üîß';
        }

        // Funciones legacy para compatibilidad
        function loadServices(services, linea) {
            const servicesContent = document.getElementById('servicesContent');
            if (!servicesContent) return;
            
            if (!services || Object.keys(services).length === 0) {
                servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles.</div>';
                return;
            }
            
            let html = '<div class="services-grid">';
            Object.entries(services).forEach(([service, available]) => {
                const icon = getServiceIcon(service);
                const statusClass = available ? 'service-available' : 'service-unavailable';
                const statusText = available ? 'Disponible' : 'No disponible';
                
                html += `
                    <div class="service-item">
                        <div class="service-icon ${statusClass}">${icon}</div>
                        <div class="service-info">
                            <div class="service-name">${service}</div>
                            <div class="service-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            servicesContent.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES PARA MODELOS 3D
        // ============================================================================

        // Funci√≥n para cargar y mostrar la vista 3D de una estaci√≥n
        async function loadModel3D(stationName, lineNumber) {
            const model3dSection = document.getElementById('model3dSection');
            const model3dImage = document.getElementById('model3dImage');
            
            if (!model3dSection || !model3dImage) {
                console.warn('Elementos de vista 3D no encontrados');
                return;
            }
            
            // Mostrar secci√≥n
            model3dSection.style.display = 'block';
            
            // Normalizar nombre de estaci√≥n para la URL
            function normalizarNombre(nombre) {
                if (!nombre) return "";
                nombre = nombre.toLowerCase();
                nombre = nombre.replace('√°', 'a').replace('√©', 'e').replace('√≠', 'i').replace('√≥', 'o').replace('√∫', 'u').replace('√±', 'n');
                nombre = nombre.replace('√º', 'u').replace('√ß', 'c');
                nombre = nombre.replace(/[^a-z0-9\s]/g, '');
                nombre = nombre.replace(/\s+/g, '_');
                return nombre;
            }
            
            const normalizedName = normalizarNombre(stationName);
            const originalUrl = `http://estacions.albertguillaumes.cat/img/madrid/${normalizedName}.png`;
            
            // Cargar directamente desde la URL original
            model3dImage.src = originalUrl;
            model3dImage.alt = `Vista 3D de ${stationName}`;
            model3dImage.style.display = 'block';
            
            // Actualizar informaci√≥n
            const stationNameSpan = document.querySelector('.model-3d-station-name');
            const lineInfoSpan = document.querySelector('.model-3d-line-info');
            if (stationNameSpan) stationNameSpan.textContent = stationName;
            if (lineInfoSpan) lineInfoSpan.textContent = `L√≠nea ${lineNumber}`;
            
            console.log(`‚úÖ Vista 3D cargada desde: ${originalUrl}`);
            
            // Manejar errores de carga
            model3dImage.onerror = function() {
                console.log(`‚ùå Error cargando vista 3D para ${stationName}`);
                showModel3DPlaceholder(stationName, originalUrl);
            };
        }
        
        // Funci√≥n para mostrar placeholder cuando no hay vista 3D
        function showModel3DPlaceholder(stationName, downloadUrl = null) {
            const model3dSection = document.getElementById('model3dSection');
            if (!model3dSection) return;
            
            const placeholderHTML = `
                <div class="model-3d-not-available">
                    <div class="model-3d-placeholder">
                        <div class="model-3d-icon">üèóÔ∏è</div>
                        <h4>Vista 3D no disponible</h4>
                        <p>No hay una vista 3D disponible para la estaci√≥n <strong>${stationName}</strong>.</p>
                        ${downloadUrl ? `
                            <button class="btn btn-primary" onclick="downloadModel3D('${stationName}')">
                                üì• Descargar Vista 3D
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            model3dSection.innerHTML = placeholderHTML;
            console.log(`‚ö†Ô∏è Vista 3D no disponible para ${stationName}`);
        }
        
        // Funci√≥n para descargar vista 3D
        async function downloadModel3D(stationName) {
            try {
                console.log(`üì• Descargando vista 3D para ${stationName}...`);
                
                const response = await fetch(`/api/station/model3d/download/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Vista 3D descargada: ${data.local_path}`);
                    // Recargar la vista 3D despu√©s de descargar
                    const stationData = await getStationData(stationName);
                    if (stationData && stationData.lines && stationData.lines.length > 0) {
                        loadModel3D(stationName, stationData.lines[0].short_name);
                    }
                } else {
                    console.error('Error descargando vista 3D:', data.error);
                    alert('Error al descargar la vista 3D. Int√©ntalo de nuevo.');
                }
                
            } catch (error) {
                console.error('Error en descarga:', error);
                alert('Error al descargar la vista 3D.');
            }
        }

        // Funci√≥n para rotar la vista del modelo 3D
        function rotateModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            // A√±adir clase de rotaci√≥n
            model3dImage.style.transition = 'transform 0.5s ease';
            model3dImage.style.transform = 'rotateY(180deg)';
            
            // Restaurar despu√©s de la animaci√≥n
            setTimeout(() => {
                model3dImage.style.transform = 'rotateY(0deg)';
            }, 500);
            
            console.log('üîÑ Rotando vista del modelo 3D');
        }

        // Funci√≥n para hacer zoom en el modelo 3D
        function zoomModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            const currentScale = model3dImage.style.transform.includes('scale') 
                ? parseFloat(model3dImage.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1)
                : 1;
            
            const newScale = currentScale === 1 ? 1.5 : 1;
            
            model3dImage.style.transition = 'transform 0.3s ease';
            model3dImage.style.transform = `scale(${newScale})`;
            
            console.log(`üîç Zoom del modelo 3D: ${newScale}x`);
        }

        // Funci√≥n para actualizar el modelo 3D cuando se selecciona una estaci√≥n
        function updateModel3D(stationName, lineNumber) {
            if (!stationName || !lineNumber) {
                const model3dSection = document.getElementById('model3dSection');
                if (model3dSection) {
                    model3dSection.style.display = 'none';
                }
                return;
            }
            
            loadModel3D(stationName, lineNumber);
        }

        // Modificar la funci√≥n existente para incluir el modelo 3D
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName) return;
            
            currentStationName = stationName;
            const stationInfo = document.getElementById('stationInfo');
            const refreshBtn = document.getElementById('refreshButton');
            
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            if (refreshBtn) {
                refreshBtn.style.display = 'inline-flex';
            }
            
            // Actualizar nombre de estaci√≥n
            const stationNameElement = document.getElementById('stationName');
            if (stationNameElement) {
                stationNameElement.textContent = stationName;
            }
            
            // Buscar datos de la estaci√≥n para obtener la l√≠nea
            try {
                const searchResponse = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const searchData = await searchResponse.json();
                
                if (searchData && searchData.length > 0) {
                    const stationData = searchData[0];
                    const lineNumber = stationData.linea;
                    
                    // Actualizar ID de estaci√≥n
                    const stationIdElement = document.getElementById('stationId');
                    if (stationIdElement) {
                        stationIdElement.textContent = `ID: ${stationData.id_fijo}`;
                    }
                    
                    // Cargar modelo 3D
                    updateModel3D(stationName, lineNumber);
                    
                    console.log(`üèóÔ∏è Cargando modelo 3D para ${stationName} (L√≠nea ${lineNumber})`);
                }
            } catch (error) {
                console.error('Error obteniendo datos de estaci√≥n para modelo 3D:', error);
            }
            
            // Continuar con el resto de la funcionalidad existente...
            try {
                const response = await fetch(`/api/station/ninjascrap/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                loadIntelligentData(stationName);
                
            } catch (error) {
                console.error('Error en searchStationWithNinjaScrap:', error);
                alert('Error al obtener datos de la estaci√≥n. Int√©ntalo de nuevo.');
            }
        }

        // A√±adir despu√©s de la funci√≥n loadAccessesFromMetroMadrid (l√≠nea 2030):

        function loadAccessesFromGTFS(stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            // Mostrar indicador de carga
            accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde GTFS...</div>';
            
            fetch(`/api/station/accesses/gtfs/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error cargando accesos GTFS:', data.error);
                        accessesContent.innerHTML = '<div class="no-data">No se pudieron cargar los accesos.</div>';
                        return;
                    }
                    
                    if (!data.accesos || data.accesos.length === 0) {
                        accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles para esta estaci√≥n.</div>';
                        return;
                    }
                    
                    // Crear tabla de accesos
                    let html = `<div class="line-data-header">üö™ Accesos - ${data.estacion.nombre}</div>`;
                    html += '<div class="gtfs-badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìä Datos GTFS oficiales</div>';
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ACCESIBLE</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.accesos.forEach(acceso => {
                        const icon = getAccessIcon(acceso.tipo_acceso);
                        const accesibleIcon = acceso.accesible_silla_ruedas ? '‚ôø' : '‚ùå';
                        const accesibleText = acceso.accesible_silla_ruedas ? 'S√≠' : 'No';
                        
                        html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${acceso.vestibulo}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre_acceso}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${accesibleIcon} ${accesibleText}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // A√±adir informaci√≥n de la estaci√≥n
                    html += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">`;
                    html += `<strong>Informaci√≥n de la estaci√≥n:</strong><br>`;
                    html += `üìç Coordenadas: ${data.estacion.latitud}, ${data.estacion.longitud}<br>`;
                    html += `‚ôø Accesibilidad general: ${data.estacion.accesible_silla_ruedas ? 'S√≠' : 'No'}<br>`;
                    html += `üö™ Total de accesos: ${data.estacion.total_accesos}<br>`;
                    html += `üìä Fuente: ${data.fuente}`;
                    html += '</div>';
                    
                    accessesContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error cargando accesos GTFS:', error);
                    accessesContent.innerHTML = '<div class="no-data">Error al cargar los accesos.</div>';
                });
        }

        function getServiceIcon(tipoServicio) {
            const iconMap = {
                'Ascensores': 'üõó',
                'Escaleras mec√°nicas': 'üõó',
                'Desfibrilador': 'üíì',
                'Cobertura m√≥vil': 'üì±',
                'Bibliometro': 'üìö',
                'Tiendas': 'üõçÔ∏è',
                'Estaci√≥n accesible': '‚ôø',
                'Oficina Objetos Perdidos': 'üìã',
                'Oficina de gesti√≥n TTP': 'üí≥',
                'Parking disuasorio de pago': 'üöó',
                'Quioscos ONCE': 'üì∞',
                'adaptada para discapacitados': '‚ôø',
                'escaleras': 'üõó'
            };
            
            return iconMap[tipoServicio] || 'üîß';
        }

        // Funciones legacy para compatibilidad
        function loadServices(services, linea) {
            const servicesContent = document.getElementById('servicesContent');
            if (!servicesContent) return;
            
            if (!services || Object.keys(services).length === 0) {
                servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles.</div>';
                return;
            }
            
            let html = '<div class="services-grid">';
            Object.entries(services).forEach(([service, available]) => {
                const icon = getServiceIcon(service);
                const statusClass = available ? 'service-available' : 'service-unavailable';
                const statusText = available ? 'Disponible' : 'No disponible';
                
                html += `
                    <div class="service-item">
                        <div class="service-icon ${statusClass}">${icon}</div>
                        <div class="service-info">
                            <div class="service-name">${service}</div>
                            <div class="service-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            servicesContent.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES PARA MODELOS 3D
        // ============================================================================

        // Funci√≥n para cargar y mostrar la vista 3D de una estaci√≥n
        async function loadModel3D(stationName, lineNumber) {
            const model3dSection = document.getElementById('model3dSection');
            const model3dImage = document.getElementById('model3dImage');
            
            if (!model3dSection || !model3dImage) {
                console.warn('Elementos de vista 3D no encontrados');
                return;
            }
            
            // Mostrar secci√≥n
            model3dSection.style.display = 'block';
            
            // Normalizar nombre de estaci√≥n para la URL
            function normalizarNombre(nombre) {
                if (!nombre) return "";
                nombre = nombre.toLowerCase();
                nombre = nombre.replace('√°', 'a').replace('√©', 'e').replace('√≠', 'i').replace('√≥', 'o').replace('√∫', 'u').replace('√±', 'n');
                nombre = nombre.replace('√º', 'u').replace('√ß', 'c');
                nombre = nombre.replace(/[^a-z0-9\s]/g, '');
                nombre = nombre.replace(/\s+/g, '_');
                return nombre;
            }
            
            const normalizedName = normalizarNombre(stationName);
            const originalUrl = `http://estacions.albertguillaumes.cat/img/madrid/${normalizedName}.png`;
            
            // Cargar directamente desde la URL original
            model3dImage.src = originalUrl;
            model3dImage.alt = `Vista 3D de ${stationName}`;
            model3dImage.style.display = 'block';
            
            // Actualizar informaci√≥n
            const stationNameSpan = document.querySelector('.model-3d-station-name');
            const lineInfoSpan = document.querySelector('.model-3d-line-info');
            if (stationNameSpan) stationNameSpan.textContent = stationName;
            if (lineInfoSpan) lineInfoSpan.textContent = `L√≠nea ${lineNumber}`;
            
            console.log(`‚úÖ Vista 3D cargada desde: ${originalUrl}`);
            
            // Manejar errores de carga
            model3dImage.onerror = function() {
                console.log(`‚ùå Error cargando vista 3D para ${stationName}`);
                showModel3DPlaceholder(stationName, originalUrl);
            };
        }
        
        // Funci√≥n para mostrar placeholder cuando no hay vista 3D
        function showModel3DPlaceholder(stationName, downloadUrl = null) {
            const model3dSection = document.getElementById('model3dSection');
            if (!model3dSection) return;
            
            const placeholderHTML = `
                <div class="model-3d-not-available">
                    <div class="model-3d-placeholder">
                        <div class="model-3d-icon">üèóÔ∏è</div>
                        <h4>Vista 3D no disponible</h4>
                        <p>No hay una vista 3D disponible para la estaci√≥n <strong>${stationName}</strong>.</p>
                        ${downloadUrl ? `
                            <button class="btn btn-primary" onclick="downloadModel3D('${stationName}')">
                                üì• Descargar Vista 3D
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            model3dSection.innerHTML = placeholderHTML;
            console.log(`‚ö†Ô∏è Vista 3D no disponible para ${stationName}`);
        }
        
        // Funci√≥n para descargar vista 3D
        async function downloadModel3D(stationName) {
            try {
                console.log(`üì• Descargando vista 3D para ${stationName}...`);
                
                const response = await fetch(`/api/station/model3d/download/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Vista 3D descargada: ${data.local_path}`);
                    // Recargar la vista 3D despu√©s de descargar
                    const stationData = await getStationData(stationName);
                    if (stationData && stationData.lines && stationData.lines.length > 0) {
                        loadModel3D(stationName, stationData.lines[0].short_name);
                    }
                } else {
                    console.error('Error descargando vista 3D:', data.error);
                    alert('Error al descargar la vista 3D. Int√©ntalo de nuevo.');
                }
                
            } catch (error) {
                console.error('Error en descarga:', error);
                alert('Error al descargar la vista 3D.');
            }
        }

        // Funci√≥n para rotar la vista del modelo 3D
        function rotateModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            // A√±adir clase de rotaci√≥n
            model3dImage.style.transition = 'transform 0.5s ease';
            model3dImage.style.transform = 'rotateY(180deg)';
            
            // Restaurar despu√©s de la animaci√≥n
            setTimeout(() => {
                model3dImage.style.transform = 'rotateY(0deg)';
            }, 500);
            
            console.log('üîÑ Rotando vista del modelo 3D');
        }

        // Funci√≥n para hacer zoom en el modelo 3D
        function zoomModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            const currentScale = model3dImage.style.transform.includes('scale') 
                ? parseFloat(model3dImage.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1)
                : 1;
            
            const newScale = currentScale === 1 ? 1.5 : 1;
            
            model3dImage.style.transition = 'transform 0.3s ease';
            model3dImage.style.transform = `scale(${newScale})`;
            
            console.log(`üîç Zoom del modelo 3D: ${newScale}x`);
        }

        // Funci√≥n para actualizar el modelo 3D cuando se selecciona una estaci√≥n
        function updateModel3D(stationName, lineNumber) {
            if (!stationName || !lineNumber) {
                const model3dSection = document.getElementById('model3dSection');
                if (model3dSection) {
                    model3dSection.style.display = 'none';
                }
                return;
            }
            
            loadModel3D(stationName, lineNumber);
        }

        // Modificar la funci√≥n existente para incluir el modelo 3D
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName) return;
            
            currentStationName = stationName;
            const stationInfo = document.getElementById('stationInfo');
            const refreshBtn = document.getElementById('refreshButton');
            
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            if (refreshBtn) {
                refreshBtn.style.display = 'inline-flex';
            }
            
            // Actualizar nombre de estaci√≥n
            const stationNameElement = document.getElementById('stationName');
            if (stationNameElement) {
                stationNameElement.textContent = stationName;
            }
            
            // Buscar datos de la estaci√≥n para obtener la l√≠nea
            try {
                const searchResponse = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const searchData = await searchResponse.json();
                
                if (searchData && searchData.length > 0) {
                    const stationData = searchData[0];
                    const lineNumber = stationData.linea;
                    
                    // Actualizar ID de estaci√≥n
                    const stationIdElement = document.getElementById('stationId');
                    if (stationIdElement) {
                        stationIdElement.textContent = `ID: ${stationData.id_fijo}`;
                    }
                    
                    // Cargar modelo 3D
                    updateModel3D(stationName, lineNumber);
                    
                    console.log(`üèóÔ∏è Cargando modelo 3D para ${stationName} (L√≠nea ${lineNumber})`);
                }
            } catch (error) {
                console.error('Error obteniendo datos de estaci√≥n para modelo 3D:', error);
            }
            
            // Continuar con el resto de la funcionalidad existente...
            try {
                const response = await fetch(`/api/station/ninjascrap/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                loadIntelligentData(stationName);
                
            } catch (error) {
                console.error('Error en searchStationWithNinjaScrap:', error);
                alert('Error al obtener datos de la estaci√≥n. Int√©ntalo de nuevo.');
            }
        }

        // A√±adir despu√©s de la funci√≥n loadAccessesFromMetroMadrid (l√≠nea 2030):

        function loadAccessesFromGTFS(stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            // Mostrar indicador de carga
            accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde GTFS...</div>';
            
            fetch(`/api/station/accesses/gtfs/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error cargando accesos GTFS:', data.error);
                        accessesContent.innerHTML = '<div class="no-data">No se pudieron cargar los accesos.</div>';
                        return;
                    }
                    
                    if (!data.accesos || data.accesos.length === 0) {
                        accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles para esta estaci√≥n.</div>';
                        return;
                    }
                    
                    // Crear tabla de accesos
                    let html = `<div class="line-data-header">üö™ Accesos - ${data.estacion.nombre}</div>`;
                    html += '<div class="gtfs-badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìä Datos GTFS oficiales</div>';
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ACCESIBLE</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.accesos.forEach(acceso => {
                        const icon = getAccessIcon(acceso.tipo_acceso);
                        const accesibleIcon = acceso.accesible_silla_ruedas ? '‚ôø' : '‚ùå';
                        const accesibleText = acceso.accesible_silla_ruedas ? 'S√≠' : 'No';
                        
                        html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${acceso.vestibulo}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre_acceso}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${accesibleIcon} ${accesibleText}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // A√±adir informaci√≥n de la estaci√≥n
                    html += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">`;
                    html += `<strong>Informaci√≥n de la estaci√≥n:</strong><br>`;
                    html += `üìç Coordenadas: ${data.estacion.latitud}, ${data.estacion.longitud}<br>`;
                    html += `‚ôø Accesibilidad general: ${data.estacion.accesible_silla_ruedas ? 'S√≠' : 'No'}<br>`;
                    html += `üö™ Total de accesos: ${data.estacion.total_accesos}<br>`;
                    html += `üìä Fuente: ${data.fuente}`;
                    html += '</div>';
                    
                    accessesContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error cargando accesos GTFS:', error);
                    accessesContent.innerHTML = '<div class="no-data">Error al cargar los accesos.</div>';
                });
        }

        function getServiceIcon(tipoServicio) {
            const iconMap = {
                'Ascensores': 'üõó',
                'Escaleras mec√°nicas': 'üõó',
                'Desfibrilador': 'üíì',
                'Cobertura m√≥vil': 'üì±',
                'Bibliometro': 'üìö',
                'Tiendas': 'üõçÔ∏è',
                'Estaci√≥n accesible': '‚ôø',
                'Oficina Objetos Perdidos': 'üìã',
                'Oficina de gesti√≥n TTP': 'üí≥',
                'Parking disuasorio de pago': 'üöó',
                'Quioscos ONCE': 'üì∞',
                'adaptada para discapacitados': '‚ôø',
                'escaleras': 'üõó'
            };
            
            return iconMap[tipoServicio] || 'üîß';
        }

        // Funciones legacy para compatibilidad
        function loadServices(services, linea) {
            const servicesContent = document.getElementById('servicesContent');
            if (!servicesContent) return;
            
            if (!services || Object.keys(services).length === 0) {
                servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles.</div>';
                return;
            }
            
            let html = '<div class="services-grid">';
            Object.entries(services).forEach(([service, available]) => {
                const icon = getServiceIcon(service);
                const statusClass = available ? 'service-available' : 'service-unavailable';
                const statusText = available ? 'Disponible' : 'No disponible';
                
                html += `
                    <div class="service-item">
                        <div class="service-icon ${statusClass}">${icon}</div>
                        <div class="service-info">
                            <div class="service-name">${service}</div>
                            <div class="service-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            servicesContent.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES PARA MODELOS 3D
        // ============================================================================

        // Funci√≥n para cargar y mostrar la vista 3D de una estaci√≥n
        async function loadModel3D(stationName, lineNumber) {
            const model3dSection = document.getElementById('model3dSection');
            const model3dImage = document.getElementById('model3dImage');
            
            if (!model3dSection || !model3dImage) {
                console.warn('Elementos de vista 3D no encontrados');
                return;
            }
            
            // Mostrar secci√≥n
            model3dSection.style.display = 'block';
            
            // Normalizar nombre de estaci√≥n para la URL
            function normalizarNombre(nombre) {
                if (!nombre) return "";
                nombre = nombre.toLowerCase();
                nombre = nombre.replace('√°', 'a').replace('√©', 'e').replace('√≠', 'i').replace('√≥', 'o').replace('√∫', 'u').replace('√±', 'n');
                nombre = nombre.replace('√º', 'u').replace('√ß', 'c');
                nombre = nombre.replace(/[^a-z0-9\s]/g, '');
                nombre = nombre.replace(/\s+/g, '_');
                return nombre;
            }
            
            const normalizedName = normalizarNombre(stationName);
            const originalUrl = `http://estacions.albertguillaumes.cat/img/madrid/${normalizedName}.png`;
            
            // Cargar directamente desde la URL original
            model3dImage.src = originalUrl;
            model3dImage.alt = `Vista 3D de ${stationName}`;
            model3dImage.style.display = 'block';
            
            // Actualizar informaci√≥n
            const stationNameSpan = document.querySelector('.model-3d-station-name');
            const lineInfoSpan = document.querySelector('.model-3d-line-info');
            if (stationNameSpan) stationNameSpan.textContent = stationName;
            if (lineInfoSpan) lineInfoSpan.textContent = `L√≠nea ${lineNumber}`;
            
            console.log(`‚úÖ Vista 3D cargada desde: ${originalUrl}`);
            
            // Manejar errores de carga
            model3dImage.onerror = function() {
                console.log(`‚ùå Error cargando vista 3D para ${stationName}`);
                showModel3DPlaceholder(stationName, originalUrl);
            };
        }
        
        // Funci√≥n para mostrar placeholder cuando no hay vista 3D
        function showModel3DPlaceholder(stationName, downloadUrl = null) {
            const model3dSection = document.getElementById('model3dSection');
            if (!model3dSection) return;
            
            const placeholderHTML = `
                <div class="model-3d-not-available">
                    <div class="model-3d-placeholder">
                        <div class="model-3d-icon">üèóÔ∏è</div>
                        <h4>Vista 3D no disponible</h4>
                        <p>No hay una vista 3D disponible para la estaci√≥n <strong>${stationName}</strong>.</p>
                        ${downloadUrl ? `
                            <button class="btn btn-primary" onclick="downloadModel3D('${stationName}')">
                                üì• Descargar Vista 3D
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            model3dSection.innerHTML = placeholderHTML;
            console.log(`‚ö†Ô∏è Vista 3D no disponible para ${stationName}`);
        }
        
        // Funci√≥n para descargar vista 3D
        async function downloadModel3D(stationName) {
            try {
                console.log(`üì• Descargando vista 3D para ${stationName}...`);
                
                const response = await fetch(`/api/station/model3d/download/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Vista 3D descargada: ${data.local_path}`);
                    // Recargar la vista 3D despu√©s de descargar
                    const stationData = await getStationData(stationName);
                    if (stationData && stationData.lines && stationData.lines.length > 0) {
                        loadModel3D(stationName, stationData.lines[0].short_name);
                    }
                } else {
                    console.error('Error descargando vista 3D:', data.error);
                    alert('Error al descargar la vista 3D. Int√©ntalo de nuevo.');
                }
                
            } catch (error) {
                console.error('Error en descarga:', error);
                alert('Error al descargar la vista 3D.');
            }
        }

        // Funci√≥n para rotar la vista del modelo 3D
        function rotateModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            // A√±adir clase de rotaci√≥n
            model3dImage.style.transition = 'transform 0.5s ease';
            model3dImage.style.transform = 'rotateY(180deg)';
            
            // Restaurar despu√©s de la animaci√≥n
            setTimeout(() => {
                model3dImage.style.transform = 'rotateY(0deg)';
            }, 500);
            
            console.log('üîÑ Rotando vista del modelo 3D');
        }

        // Funci√≥n para hacer zoom en el modelo 3D
        function zoomModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            const currentScale = model3dImage.style.transform.includes('scale') 
                ? parseFloat(model3dImage.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1)
                : 1;
            
            const newScale = currentScale === 1 ? 1.5 : 1;
            
            model3dImage.style.transition = 'transform 0.3s ease';
            model3dImage.style.transform = `scale(${newScale})`;
            
            console.log(`üîç Zoom del modelo 3D: ${newScale}x`);
        }

        // Funci√≥n para actualizar el modelo 3D cuando se selecciona una estaci√≥n
        function updateModel3D(stationName, lineNumber) {
            if (!stationName || !lineNumber) {
                const model3dSection = document.getElementById('model3dSection');
                if (model3dSection) {
                    model3dSection.style.display = 'none';
                }
                return;
            }
            
            loadModel3D(stationName, lineNumber);
        }

        // Modificar la funci√≥n existente para incluir el modelo 3D
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName) return;
            
            currentStationName = stationName;
            const stationInfo = document.getElementById('stationInfo');
            const refreshBtn = document.getElementById('refreshButton');
            
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            if (refreshBtn) {
                refreshBtn.style.display = 'inline-flex';
            }
            
            // Actualizar nombre de estaci√≥n
            const stationNameElement = document.getElementById('stationName');
            if (stationNameElement) {
                stationNameElement.textContent = stationName;
            }
            
            // Buscar datos de la estaci√≥n para obtener la l√≠nea
            try {
                const searchResponse = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const searchData = await searchResponse.json();
                
                if (searchData && searchData.length > 0) {
                    const stationData = searchData[0];
                    const lineNumber = stationData.linea;
                    
                    // Actualizar ID de estaci√≥n
                    const stationIdElement = document.getElementById('stationId');
                    if (stationIdElement) {
                        stationIdElement.textContent = `ID: ${stationData.id_fijo}`;
                    }
                    
                    // Cargar modelo 3D
                    updateModel3D(stationName, lineNumber);
                    
                    console.log(`üèóÔ∏è Cargando modelo 3D para ${stationName} (L√≠nea ${lineNumber})`);
                }
            } catch (error) {
                console.error('Error obteniendo datos de estaci√≥n para modelo 3D:', error);
            }
            
            // Continuar con el resto de la funcionalidad existente...
            try {
                const response = await fetch(`/api/station/ninjascrap/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                loadIntelligentData(stationName);
                
            } catch (error) {
                console.error('Error en searchStationWithNinjaScrap:', error);
                alert('Error al obtener datos de la estaci√≥n. Int√©ntalo de nuevo.');
            }
        }

        // A√±adir despu√©s de la funci√≥n loadAccessesFromMetroMadrid (l√≠nea 2030):

        function loadAccessesFromGTFS(stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            // Mostrar indicador de carga
            accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde GTFS...</div>';
            
            fetch(`/api/station/accesses/gtfs/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error cargando accesos GTFS:', data.error);
                        accessesContent.innerHTML = '<div class="no-data">No se pudieron cargar los accesos.</div>';
                        return;
                    }
                    
                    if (!data.accesos || data.accesos.length === 0) {
                        accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles para esta estaci√≥n.</div>';
                        return;
                    }
                    
                    // Crear tabla de accesos
                    let html = `<div class="line-data-header">üö™ Accesos - ${data.estacion.nombre}</div>`;
                    html += '<div class="gtfs-badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìä Datos GTFS oficiales</div>';
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ACCESIBLE</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.accesos.forEach(acceso => {
                        const icon = getAccessIcon(acceso.tipo_acceso);
                        const accesibleIcon = acceso.accesible_silla_ruedas ? '‚ôø' : '‚ùå';
                        const accesibleText = acceso.accesible_silla_ruedas ? 'S√≠' : 'No';
                        
                        html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${acceso.vestibulo}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre_acceso}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${accesibleIcon} ${accesibleText}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // A√±adir informaci√≥n de la estaci√≥n
                    html += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">`;
                    html += `<strong>Informaci√≥n de la estaci√≥n:</strong><br>`;
                    html += `üìç Coordenadas: ${data.estacion.latitud}, ${data.estacion.longitud}<br>`;
                    html += `‚ôø Accesibilidad general: ${data.estacion.accesible_silla_ruedas ? 'S√≠' : 'No'}<br>`;
                    html += `üö™ Total de accesos: ${data.estacion.total_accesos}<br>`;
                    html += `üìä Fuente: ${data.fuente}`;
                    html += '</div>';
                    
                    accessesContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error cargando accesos GTFS:', error);
                    accessesContent.innerHTML = '<div class="no-data">Error al cargar los accesos.</div>';
                });
        }

        function getServiceIcon(tipoServicio) {
            const iconMap = {
                'Ascensores': 'üõó',
                'Escaleras mec√°nicas': 'üõó',
                'Desfibrilador': 'üíì',
                'Cobertura m√≥vil': 'üì±',
                'Bibliometro': 'üìö',
                'Tiendas': 'üõçÔ∏è',
                'Estaci√≥n accesible': '‚ôø',
                'Oficina Objetos Perdidos': 'üìã',
                'Oficina de gesti√≥n TTP': 'üí≥',
                'Parking disuasorio de pago': 'üöó',
                'Quioscos ONCE': 'üì∞',
                'adaptada para discapacitados': '‚ôø',
                'escaleras': 'üõó'
            };
            
            return iconMap[tipoServicio] || 'üîß';
        }

        // Funciones legacy para compatibilidad
        function loadServices(services, linea) {
            const servicesContent = document.getElementById('servicesContent');
            if (!servicesContent) return;
            
            if (!services || Object.keys(services).length === 0) {
                servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles.</div>';
                return;
            }
            
            let html = '<div class="services-grid">';
            Object.entries(services).forEach(([service, available]) => {
                const icon = getServiceIcon(service);
                const statusClass = available ? 'service-available' : 'service-unavailable';
                const statusText = available ? 'Disponible' : 'No disponible';
                
                html += `
                    <div class="service-item">
                        <div class="service-icon ${statusClass}">${icon}</div>
                        <div class="service-info">
                            <div class="service-name">${service}</div>
                            <div class="service-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            servicesContent.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES PARA MODELOS 3D
        // ============================================================================

        // Funci√≥n para cargar y mostrar la vista 3D de una estaci√≥n
        async function loadModel3D(stationName, lineNumber) {
            const model3dSection = document.getElementById('model3dSection');
            const model3dImage = document.getElementById('model3dImage');
            
            if (!model3dSection || !model3dImage) {
                console.warn('Elementos de vista 3D no encontrados');
                return;
            }
            
            // Mostrar secci√≥n
            model3dSection.style.display = 'block';
            
            // Normalizar nombre de estaci√≥n para la URL
            function normalizarNombre(nombre) {
                if (!nombre) return "";
                nombre = nombre.toLowerCase();
                nombre = nombre.replace('√°', 'a').replace('√©', 'e').replace('√≠', 'i').replace('√≥', 'o').replace('√∫', 'u').replace('√±', 'n');
                nombre = nombre.replace('√º', 'u').replace('√ß', 'c');
                nombre = nombre.replace(/[^a-z0-9\s]/g, '');
                nombre = nombre.replace(/\s+/g, '_');
                return nombre;
            }
            
            const normalizedName = normalizarNombre(stationName);
            const originalUrl = `http://estacions.albertguillaumes.cat/img/madrid/${normalizedName}.png`;
            
            // Cargar directamente desde la URL original
            model3dImage.src = originalUrl;
            model3dImage.alt = `Vista 3D de ${stationName}`;
            model3dImage.style.display = 'block';
            
            // Actualizar informaci√≥n
            const stationNameSpan = document.querySelector('.model-3d-station-name');
            const lineInfoSpan = document.querySelector('.model-3d-line-info');
            if (stationNameSpan) stationNameSpan.textContent = stationName;
            if (lineInfoSpan) lineInfoSpan.textContent = `L√≠nea ${lineNumber}`;
            
            console.log(`‚úÖ Vista 3D cargada desde: ${originalUrl}`);
            
            // Manejar errores de carga
            model3dImage.onerror = function() {
                console.log(`‚ùå Error cargando vista 3D para ${stationName}`);
                showModel3DPlaceholder(stationName, originalUrl);
            };
        }
        
        // Funci√≥n para mostrar placeholder cuando no hay vista 3D
        function showModel3DPlaceholder(stationName, downloadUrl = null) {
            const model3dSection = document.getElementById('model3dSection');
            if (!model3dSection) return;
            
            const placeholderHTML = `
                <div class="model-3d-not-available">
                    <div class="model-3d-placeholder">
                        <div class="model-3d-icon">üèóÔ∏è</div>
                        <h4>Vista 3D no disponible</h4>
                        <p>No hay una vista 3D disponible para la estaci√≥n <strong>${stationName}</strong>.</p>
                        ${downloadUrl ? `
                            <button class="btn btn-primary" onclick="downloadModel3D('${stationName}')">
                                üì• Descargar Vista 3D
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            model3dSection.innerHTML = placeholderHTML;
            console.log(`‚ö†Ô∏è Vista 3D no disponible para ${stationName}`);
        }
        
        // Funci√≥n para descargar vista 3D
        async function downloadModel3D(stationName) {
            try {
                console.log(`üì• Descargando vista 3D para ${stationName}...`);
                
                const response = await fetch(`/api/station/model3d/download/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Vista 3D descargada: ${data.local_path}`);
                    // Recargar la vista 3D despu√©s de descargar
                    const stationData = await getStationData(stationName);
                    if (stationData && stationData.lines && stationData.lines.length > 0) {
                        loadModel3D(stationName, stationData.lines[0].short_name);
                    }
                } else {
                    console.error('Error descargando vista 3D:', data.error);
                    alert('Error al descargar la vista 3D. Int√©ntalo de nuevo.');
                }
                
            } catch (error) {
                console.error('Error en descarga:', error);
                alert('Error al descargar la vista 3D.');
            }
        }

        // Funci√≥n para rotar la vista del modelo 3D
        function rotateModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            // A√±adir clase de rotaci√≥n
            model3dImage.style.transition = 'transform 0.5s ease';
            model3dImage.style.transform = 'rotateY(180deg)';
            
            // Restaurar despu√©s de la animaci√≥n
            setTimeout(() => {
                model3dImage.style.transform = 'rotateY(0deg)';
            }, 500);
            
            console.log('üîÑ Rotando vista del modelo 3D');
        }

        // Funci√≥n para hacer zoom en el modelo 3D
        function zoomModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            const currentScale = model3dImage.style.transform.includes('scale') 
                ? parseFloat(model3dImage.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1)
                : 1;
            
            const newScale = currentScale === 1 ? 1.5 : 1;
            
            model3dImage.style.transition = 'transform 0.3s ease';
            model3dImage.style.transform = `scale(${newScale})`;
            
            console.log(`üîç Zoom del modelo 3D: ${newScale}x`);
        }

        // Funci√≥n para actualizar el modelo 3D cuando se selecciona una estaci√≥n
        function updateModel3D(stationName, lineNumber) {
            if (!stationName || !lineNumber) {
                const model3dSection = document.getElementById('model3dSection');
                if (model3dSection) {
                    model3dSection.style.display = 'none';
                }
                return;
            }
            
            loadModel3D(stationName, lineNumber);
        }

        // Modificar la funci√≥n existente para incluir el modelo 3D
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName) return;
            
            currentStationName = stationName;
            const stationInfo = document.getElementById('stationInfo');
            const refreshBtn = document.getElementById('refreshButton');
            
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            if (refreshBtn) {
                refreshBtn.style.display = 'inline-flex';
            }
            
            // Actualizar nombre de estaci√≥n
            const stationNameElement = document.getElementById('stationName');
            if (stationNameElement) {
                stationNameElement.textContent = stationName;
            }
            
            // Buscar datos de la estaci√≥n para obtener la l√≠nea
            try {
                const searchResponse = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const searchData = await searchResponse.json();
                
                if (searchData && searchData.length > 0) {
                    const stationData = searchData[0];
                    const lineNumber = stationData.linea;
                    
                    // Actualizar ID de estaci√≥n
                    const stationIdElement = document.getElementById('stationId');
                    if (stationIdElement) {
                        stationIdElement.textContent = `ID: ${stationData.id_fijo}`;
                    }
                    
                    // Cargar modelo 3D
                    updateModel3D(stationName, lineNumber);
                    
                    console.log(`üèóÔ∏è Cargando modelo 3D para ${stationName} (L√≠nea ${lineNumber})`);
                }
            } catch (error) {
                console.error('Error obteniendo datos de estaci√≥n para modelo 3D:', error);
            }
            
            // Continuar con el resto de la funcionalidad existente...
            try {
                const response = await fetch(`/api/station/ninjascrap/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                loadIntelligentData(stationName);
                
            } catch (error) {
                console.error('Error en searchStationWithNinjaScrap:', error);
                alert('Error al obtener datos de la estaci√≥n. Int√©ntalo de nuevo.');
            }
        }

        // A√±adir despu√©s de la funci√≥n loadAccessesFromMetroMadrid (l√≠nea 2030):

        function loadAccessesFromGTFS(stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            // Mostrar indicador de carga
            accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde GTFS...</div>';
            
            fetch(`/api/station/accesses/gtfs/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error cargando accesos GTFS:', data.error);
                        accessesContent.innerHTML = '<div class="no-data">No se pudieron cargar los accesos.</div>';
                        return;
                    }
                    
                    if (!data.accesos || data.accesos.length === 0) {
                        accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles para esta estaci√≥n.</div>';
                        return;
                    }
                    
                    // Crear tabla de accesos
                    let html = `<div class="line-data-header">üö™ Accesos - ${data.estacion.nombre}</div>`;
                    html += '<div class="gtfs-badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìä Datos GTFS oficiales</div>';
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ACCESIBLE</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.accesos.forEach(acceso => {
                        const icon = getAccessIcon(acceso.tipo_acceso);
                        const accesibleIcon = acceso.accesible_silla_ruedas ? '‚ôø' : '‚ùå';
                        const accesibleText = acceso.accesible_silla_ruedas ? 'S√≠' : 'No';
                        
                        html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${acceso.vestibulo}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre_acceso}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${accesibleIcon} ${accesibleText}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // A√±adir informaci√≥n de la estaci√≥n
                    html += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">`;
                    html += `<strong>Informaci√≥n de la estaci√≥n:</strong><br>`;
                    html += `üìç Coordenadas: ${data.estacion.latitud}, ${data.estacion.longitud}<br>`;
                    html += `‚ôø Accesibilidad general: ${data.estacion.accesible_silla_ruedas ? 'S√≠' : 'No'}<br>`;
                    html += `üö™ Total de accesos: ${data.estacion.total_accesos}<br>`;
                    html += `üìä Fuente: ${data.fuente}`;
                    html += '</div>';
                    
                    accessesContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error cargando accesos GTFS:', error);
                    accessesContent.innerHTML = '<div class="no-data">Error al cargar los accesos.</div>';
                });
        }

        function getServiceIcon(tipoServicio) {
            const iconMap = {
                'Ascensores': 'üõó',
                'Escaleras mec√°nicas': 'üõó',
                'Desfibrilador': 'üíì',
                'Cobertura m√≥vil': 'üì±',
                'Bibliometro': 'üìö',
                'Tiendas': 'üõçÔ∏è',
                'Estaci√≥n accesible': '‚ôø',
                'Oficina Objetos Perdidos': 'üìã',
                'Oficina de gesti√≥n TTP': 'üí≥',
                'Parking disuasorio de pago': 'üöó',
                'Quioscos ONCE': 'üì∞',
                'adaptada para discapacitados': '‚ôø',
                'escaleras': 'üõó'
            };
            
            return iconMap[tipoServicio] || 'üîß';
        }

        // Funciones legacy para compatibilidad
        function loadServices(services, linea) {
            const servicesContent = document.getElementById('servicesContent');
            if (!servicesContent) return;
            
            if (!services || Object.keys(services).length === 0) {
                servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles.</div>';
                return;
            }
            
            let html = '<div class="services-grid">';
            Object.entries(services).forEach(([service, available]) => {
                const icon = getServiceIcon(service);
                const statusClass = available ? 'service-available' : 'service-unavailable';
                const statusText = available ? 'Disponible' : 'No disponible';
                
                html += `
                    <div class="service-item">
                        <div class="service-icon ${statusClass}">${icon}</div>
                        <div class="service-info">
                            <div class="service-name">${service}</div>
                            <div class="service-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            servicesContent.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES PARA MODELOS 3D
        // ============================================================================

        // Funci√≥n para cargar y mostrar la vista 3D de una estaci√≥n
        async function loadModel3D(stationName, lineNumber) {
            const model3dSection = document.getElementById('model3dSection');
            const model3dImage = document.getElementById('model3dImage');
            
            if (!model3dSection || !model3dImage) {
                console.warn('Elementos de vista 3D no encontrados');
                return;
            }
            
            // Mostrar secci√≥n
            model3dSection.style.display = 'block';
            
            // Normalizar nombre de estaci√≥n para la URL
            function normalizarNombre(nombre) {
                if (!nombre) return "";
                nombre = nombre.toLowerCase();
                nombre = nombre.replace('√°', 'a').replace('√©', 'e').replace('√≠', 'i').replace('√≥', 'o').replace('√∫', 'u').replace('√±', 'n');
                nombre = nombre.replace('√º', 'u').replace('√ß', 'c');
                nombre = nombre.replace(/[^a-z0-9\s]/g, '');
                nombre = nombre.replace(/\s+/g, '_');
                return nombre;
            }
            
            const normalizedName = normalizarNombre(stationName);
            const originalUrl = `http://estacions.albertguillaumes.cat/img/madrid/${normalizedName}.png`;
            
            // Cargar directamente desde la URL original
            model3dImage.src = originalUrl;
            model3dImage.alt = `Vista 3D de ${stationName}`;
            model3dImage.style.display = 'block';
            
            // Actualizar informaci√≥n
            const stationNameSpan = document.querySelector('.model-3d-station-name');
            const lineInfoSpan = document.querySelector('.model-3d-line-info');
            if (stationNameSpan) stationNameSpan.textContent = stationName;
            if (lineInfoSpan) lineInfoSpan.textContent = `L√≠nea ${lineNumber}`;
            
            console.log(`‚úÖ Vista 3D cargada desde: ${originalUrl}`);
            
            // Manejar errores de carga
            model3dImage.onerror = function() {
                console.log(`‚ùå Error cargando vista 3D para ${stationName}`);
                showModel3DPlaceholder(stationName, originalUrl);
            };
        }
        
        // Funci√≥n para mostrar placeholder cuando no hay vista 3D
        function showModel3DPlaceholder(stationName, downloadUrl = null) {
            const model3dSection = document.getElementById('model3dSection');
            if (!model3dSection) return;
            
            const placeholderHTML = `
                <div class="model-3d-not-available">
                    <div class="model-3d-placeholder">
                        <div class="model-3d-icon">üèóÔ∏è</div>
                        <h4>Vista 3D no disponible</h4>
                        <p>No hay una vista 3D disponible para la estaci√≥n <strong>${stationName}</strong>.</p>
                        ${downloadUrl ? `
                            <button class="btn btn-primary" onclick="downloadModel3D('${stationName}')">
                                üì• Descargar Vista 3D
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            model3dSection.innerHTML = placeholderHTML;
            console.log(`‚ö†Ô∏è Vista 3D no disponible para ${stationName}`);
        }
        
        // Funci√≥n para descargar vista 3D
        async function downloadModel3D(stationName) {
            try {
                console.log(`üì• Descargando vista 3D para ${stationName}...`);
                
                const response = await fetch(`/api/station/model3d/download/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Vista 3D descargada: ${data.local_path}`);
                    // Recargar la vista 3D despu√©s de descargar
                    const stationData = await getStationData(stationName);
                    if (stationData && stationData.lines && stationData.lines.length > 0) {
                        loadModel3D(stationName, stationData.lines[0].short_name);
                    }
                } else {
                    console.error('Error descargando vista 3D:', data.error);
                    alert('Error al descargar la vista 3D. Int√©ntalo de nuevo.');
                }
                
            } catch (error) {
                console.error('Error en descarga:', error);
                alert('Error al descargar la vista 3D.');
            }
        }

        // Funci√≥n para rotar la vista del modelo 3D
        function rotateModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            // A√±adir clase de rotaci√≥n
            model3dImage.style.transition = 'transform 0.5s ease';
            model3dImage.style.transform = 'rotateY(180deg)';
            
            // Restaurar despu√©s de la animaci√≥n
            setTimeout(() => {
                model3dImage.style.transform = 'rotateY(0deg)';
            }, 500);
            
            console.log('üîÑ Rotando vista del modelo 3D');
        }

        // Funci√≥n para hacer zoom en el modelo 3D
        function zoomModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            const currentScale = model3dImage.style.transform.includes('scale') 
                ? parseFloat(model3dImage.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1)
                : 1;
            
            const newScale = currentScale === 1 ? 1.5 : 1;
            
            model3dImage.style.transition = 'transform 0.3s ease';
            model3dImage.style.transform = `scale(${newScale})`;
            
            console.log(`üîç Zoom del modelo 3D: ${newScale}x`);
        }

        // Funci√≥n para actualizar el modelo 3D cuando se selecciona una estaci√≥n
        function updateModel3D(stationName, lineNumber) {
            if (!stationName || !lineNumber) {
                const model3dSection = document.getElementById('model3dSection');
                if (model3dSection) {
                    model3dSection.style.display = 'none';
                }
                return;
            }
            
            loadModel3D(stationName, lineNumber);
        }

        // Modificar la funci√≥n existente para incluir el modelo 3D
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName) return;
            
            currentStationName = stationName;
            const stationInfo = document.getElementById('stationInfo');
            const refreshBtn = document.getElementById('refreshButton');
            
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            if (refreshBtn) {
                refreshBtn.style.display = 'inline-flex';
            }
            
            // Actualizar nombre de estaci√≥n
            const stationNameElement = document.getElementById('stationName');
            if (stationNameElement) {
                stationNameElement.textContent = stationName;
            }
            
            // Buscar datos de la estaci√≥n para obtener la l√≠nea
            try {
                const searchResponse = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const searchData = await searchResponse.json();
                
                if (searchData && searchData.length > 0) {
                    const stationData = searchData[0];
                    const lineNumber = stationData.linea;
                    
                    // Actualizar ID de estaci√≥n
                    const stationIdElement = document.getElementById('stationId');
                    if (stationIdElement) {
                        stationIdElement.textContent = `ID: ${stationData.id_fijo}`;
                    }
                    
                    // Cargar modelo 3D
                    updateModel3D(stationName, lineNumber);
                    
                    console.log(`üèóÔ∏è Cargando modelo 3D para ${stationName} (L√≠nea ${lineNumber})`);
                }
            } catch (error) {
                console.error('Error obteniendo datos de estaci√≥n para modelo 3D:', error);
            }
            
            // Continuar con el resto de la funcionalidad existente...
            try {
                const response = await fetch(`/api/station/ninjascrap/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                loadIntelligentData(stationName);
                
            } catch (error) {
                console.error('Error en searchStationWithNinjaScrap:', error);
                alert('Error al obtener datos de la estaci√≥n. Int√©ntalo de nuevo.');
            }
        }

        // A√±adir despu√©s de la funci√≥n loadAccessesFromMetroMadrid (l√≠nea 2030):

        function loadAccessesFromGTFS(stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            // Mostrar indicador de carga
            accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde GTFS...</div>';
            
            fetch(`/api/station/accesses/gtfs/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error cargando accesos GTFS:', data.error);
                        accessesContent.innerHTML = '<div class="no-data">No se pudieron cargar los accesos.</div>';
                        return;
                    }
                    
                    if (!data.accesos || data.accesos.length === 0) {
                        accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles para esta estaci√≥n.</div>';
                        return;
                    }
                    
                    // Crear tabla de accesos
                    let html = `<div class="line-data-header">üö™ Accesos - ${data.estacion.nombre}</div>`;
                    html += '<div class="gtfs-badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìä Datos GTFS oficiales</div>';
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ACCESIBLE</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.accesos.forEach(acceso => {
                        const icon = getAccessIcon(acceso.tipo_acceso);
                        const accesibleIcon = acceso.accesible_silla_ruedas ? '‚ôø' : '‚ùå';
                        const accesibleText = acceso.accesible_silla_ruedas ? 'S√≠' : 'No';
                        
                        html += '<tr style="border-bottom: 1px solid #eee;">';
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${acceso.vestibulo}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre_acceso}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                        html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;">${accesibleIcon} ${accesibleText}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    
                    // A√±adir informaci√≥n de la estaci√≥n
                    html += `<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9em;">`;
                    html += `<strong>Informaci√≥n de la estaci√≥n:</strong><br>`;
                    html += `üìç Coordenadas: ${data.estacion.latitud}, ${data.estacion.longitud}<br>`;
                    html += `‚ôø Accesibilidad general: ${data.estacion.accesible_silla_ruedas ? 'S√≠' : 'No'}<br>`;
                    html += `üö™ Total de accesos: ${data.estacion.total_accesos}<br>`;
                    html += `üìä Fuente: ${data.fuente}`;
                    html += '</div>';
                    
                    accessesContent.innerHTML = html;
                })
                .catch(error => {
                    console.error('Error cargando accesos GTFS:', error);
                    accessesContent.innerHTML = '<div class="no-data">Error al cargar los accesos.</div>';
                });
        }

        function getServiceIcon(tipoServicio) {
            const iconMap = {
                'Ascensores': 'üõó',
                'Escaleras mec√°nicas': 'üõó',
                'Desfibrilador': 'üíì',
                'Cobertura m√≥vil': 'üì±',
                'Bibliometro': 'üìö',
                'Tiendas': 'üõçÔ∏è',
                'Estaci√≥n accesible': '‚ôø',
                'Oficina Objetos Perdidos': 'üìã',
                'Oficina de gesti√≥n TTP': 'üí≥',
                'Parking disuasorio de pago': 'üöó',
                'Quioscos ONCE': 'üì∞',
                'adaptada para discapacitados': '‚ôø',
                'escaleras': 'üõó'
            };
            
            return iconMap[tipoServicio] || 'üîß';
        }

        // Funciones legacy para compatibilidad
        function loadServices(services, linea) {
            const servicesContent = document.getElementById('servicesContent');
            if (!servicesContent) return;
            
            if (!services || Object.keys(services).length === 0) {
                servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles.</div>';
                return;
            }
            
            let html = '<div class="services-grid">';
            Object.entries(services).forEach(([service, available]) => {
                const icon = getServiceIcon(service);
                const statusClass = available ? 'service-available' : 'service-unavailable';
                const statusText = available ? 'Disponible' : 'No disponible';
                
                html += `
                    <div class="service-item">
                        <div class="service-icon ${statusClass}">${icon}</div>
                        <div class="service-info">
                            <div class="service-name">${service}</div>
                            <div class="service-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            servicesContent.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES PARA MODELOS 3D
        // ============================================================================

        // Funci√≥n para cargar y mostrar la vista 3D de una estaci√≥n
        async function loadModel3D(stationName, lineNumber) {
            const model3dSection = document.getElementById('model3dSection');
            const model3dImage = document.getElementById('model3dImage');
            
            if (!model3dSection || !model3dImage) {
                console.warn('Elementos de vista 3D no encontrados');
                return;
            }
            
            // Mostrar secci√≥n
            model3dSection.style.display = 'block';
            
            // Normalizar nombre de estaci√≥n para la URL
            function normalizarNombre(nombre) {
                if (!nombre) return "";
                nombre = nombre.toLowerCase();
                nombre = nombre.replace('√°', 'a').replace('√©', 'e').replace('√≠', 'i').replace('√≥', 'o').replace('√∫', 'u').replace('√±', 'n');
                nombre = nombre.replace('√º', 'u').replace('√ß', 'c');
                nombre = nombre.replace(/[^a-z0-9\s]/g, '');
                nombre = nombre.replace(/\s+/g, '_');
                return nombre;
            }
            
            const normalizedName = normalizarNombre(stationName);
            const originalUrl = `http://estacions.albertguillaumes.cat/img/madrid/${normalizedName}.png`;
            
            // Cargar directamente desde la URL original
            model3dImage.src = originalUrl;
            model3dImage.alt = `Vista 3D de ${stationName}`;
            model3dImage.style.display = 'block';
            
            // Actualizar informaci√≥n
            const stationNameSpan = document.querySelector('.model-3d-station-name');
            const lineInfoSpan = document.querySelector('.model-3d-line-info');
            if (stationNameSpan) stationNameSpan.textContent = stationName;
            if (lineInfoSpan) lineInfoSpan.textContent = `L√≠nea ${lineNumber}`;
            
            console.log(`‚úÖ Vista 3D cargada desde: ${originalUrl}`);
            
            // Manejar errores de carga
            model3dImage.onerror = function() {
                console.log(`‚ùå Error cargando vista 3D para ${stationName}`);
                showModel3DPlaceholder(stationName, originalUrl);
            };
        }
        
        // Funci√≥n para mostrar placeholder cuando no hay vista 3D
        function showModel3DPlaceholder(stationName, downloadUrl = null) {
            const model3dSection = document.getElementById('model3dSection');
            if (!model3dSection) return;
            
            const placeholderHTML = `
                <div class="model-3d-not-available">
                    <div class="model-3d-placeholder">
                        <div class="model-3d-icon">üèóÔ∏è</div>
                        <h4>Vista 3D no disponible</h4>
                        <p>No hay una vista 3D disponible para la estaci√≥n <strong>${stationName}</strong>.</p>
                        ${downloadUrl ? `
                            <button class="btn btn-primary" onclick="downloadModel3D('${stationName}')">
                                üì• Descargar Vista 3D
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            model3dSection.innerHTML = placeholderHTML;
            console.log(`‚ö†Ô∏è Vista 3D no disponible para ${stationName}`);
        }
        
        // Funci√≥n para descargar vista 3D
        async function downloadModel3D(stationName) {
            try {
                console.log(`üì• Descargando vista 3D para ${stationName}...`);
                
                const response = await fetch(`/api/station/model3d/download/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Vista 3D descargada: ${data.local_path}`);
                    // Recargar la vista 3D despu√©s de descargar
                    const stationData = await getStationData(stationName);
                    if (stationData && stationData.lines && stationData.lines.length > 0) {
                        loadModel3D(stationName, stationData.lines[0].short_name);
                    }
                } else {
                    console.error('Error descargando vista 3D:', data.error);
                    alert('Error al descargar la vista 3D. Int√©ntalo de nuevo.');
                }
                
            } catch (error) {
                console.error('Error en descarga:', error);
                alert('Error al descargar la vista 3D.');
            }
        }

        // Funci√≥n para rotar la vista del modelo 3D
        function rotateModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            // A√±adir clase de rotaci√≥n
            model3dImage.style.transition = 'transform 0.5s ease';
            model3dImage.style.transform = 'rotateY(180deg)';
            
            // Restaurar despu√©s de la animaci√≥n
            setTimeout(() => {
                model3dImage.style.transform = 'rotateY(0deg)';
            }, 500);
            
            console.log('üîÑ Rotando vista del modelo 3D');
        }

        // Funci√≥n para hacer zoom en el modelo 3D
        function zoomModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            const currentScale = model3dImage.style.transform.includes('scale') 
                ? parseFloat(model3dImage.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1)
                : 1;
            
            const newScale = currentScale === 1 ? 1.5 : 1;
            
            model3dImage.style.transition = 'transform 0.3s ease';
            model3dImage.style.transform = `scale(${newScale})`;
            
            console.log(`üîç Zoom del modelo 3D: ${newScale}x`);
        }

        // Funci√≥n para actualizar el modelo 3D cuando se selecciona una estaci√≥n
        function updateModel3D(stationName, lineNumber) {
            if (!stationName || !lineNumber) {
                const model3dSection = document.getElementById('model3dSection');
                if (model3dSection) {
                    model3dSection.style.display = 'none';
                }
                return;
            }
            
            loadModel3D(stationName, lineNumber);
        }

        // Modificar la funci√≥n existente para incluir el modelo 3D
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName) return;
            
            currentStationName = stationName;
            const stationInfo = document.getElementById('stationInfo');
            const refreshBtn = document.getElementById('refreshButton');
            
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            if (refreshBtn) {
                refreshBtn.style.display = 'inline-flex';
            }
            
            // Actualizar nombre de estaci√≥n
            const stationNameElement = document.getElementById('stationName');
            if (stationNameElement) {
                stationNameElement.textContent = stationName;
            }
            
            // Buscar datos de la estaci√≥n para obtener la l√≠nea
            try {
                const searchResponse = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const searchData = await searchResponse.json();
                
                if (searchData && searchData.length > 0) {
                    const stationData = searchData[0];
                    const lineNumber = stationData.linea;
                    
                    // Actualizar ID de estaci√≥n
                    const stationIdElement = document.getElementById('stationId');
                    if (stationIdElement) {
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metro Madrid - Informaci√≥n de Estaci√≥n</title>
    
    <!-- Favicon con logo del Metro de Madrid -->
    <link rel="icon" type="image/png" href="/static/logos/Logomarca_azul.png">
    <link rel="shortcut icon" type="image/png" href="/static/logos/Logomarca_azul.png">
    <link rel="apple-touch-icon" href="/static/logos/Logomarca_azul.png">
    
    <!-- Archivos CSS -->
    <link rel="stylesheet" href="/static/css/modern-trains.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/train_times.css') }}">
    
    <style>
        /* Variables CSS para temas */
        :root {
            --bg-primary: #f7f7f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f8f9fa;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #e9ecef;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --metro-main: #0065FE;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .main-content {
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-header h1 {
            font-size: 2.5em;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .page-header p {
            font-size: 1.2em;
            color: var(--text-secondary);
        }

        /* Secci√≥n de b√∫squeda */
        .search-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .search-container-centered {
            max-width: 600px;
            margin: 0 auto;
            text-align: center;
        }

        .search-title {
            color: var(--metro-main);
            margin-bottom: 25px;
            font-size: 2em;
            font-weight: 700;
        }

        .search-form-centered {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .search-input-container {
            position: relative;
            flex: 1;
            max-width: 400px;
        }

        .search-input-container input {
            width: 100%;
            padding: 18px 20px;
            border: 3px solid var(--border-color);
            border-radius: 25px;
            font-size: 18px;
            transition: all 0.3s ease;
            background: var(--bg-tertiary);
            box-shadow: var(--shadow);
            color: var(--text-primary);
        }

        .search-input-container input:focus {
            outline: none;
            border-color: var(--metro-main);
            background: var(--bg-secondary);
            box-shadow: 0 4px 20px rgba(0,174,239,0.2);
            transform: translateY(-2px);
        }

        .search-btn-rocket {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--metro-main) 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .search-btn-rocket:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .search-tips {
            color: var(--text-secondary);
            font-size: 0.95em;
            line-height: 1.5;
            margin: 0;
            opacity: 0.8;
        }

        /* Autocompletado */
        .autocomplete-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 3px solid var(--metro-main);
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: none;
        }

        .autocomplete-item {
            padding: 18px 20px;
            cursor: pointer;
            border-bottom: 2px solid var(--border-color);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            color: var(--text-primary);
        }

        .autocomplete-item:hover {
            background: var(--bg-tertiary);
        }

        .autocomplete-item.selected {
            background: var(--metro-main);
            color: white;
        }

        .autocomplete-item .station-name {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .autocomplete-item .station-lines {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* Informaci√≥n de estaci√≥n */
        .station-info {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            display: none;
            border: 1px solid var(--border-color);
        }

        .station-info.show {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .station-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .station-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-right: 20px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .station-details {
            flex: 1;
        }

        .station-actions {
            margin-left: auto;
        }

        .refresh-btn {
            background: #333333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-btn:hover {
            background: #555555;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .station-details h3 {
            font-size: 1.8em;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-weight: 700;
        }

        .station-details p {
            color: var(--text-secondary);
            font-size: 1.1em;
            margin: 0;
        }

        .station-status {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .status-operativa {
            background: #4CAF50;
        }

        .status-cerrada {
            background: #f44336;
        }

        /* Resultados de b√∫squeda */
        .search-results-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid var(--metro-main);
        }

        .search-results-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .search-results-header h3 {
            color: var(--metro-main);
            font-size: 1.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .search-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .search-result-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 80px;
        }

        .search-result-item:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: var(--metro-main);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .result-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .result-icon img {
            width: 35px;
            height: 35px;
            filter: drop-shadow(0 1px 3px rgba(0,0,0,0.2));
        }

        .line-number {
            background: var(--metro-main);
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .result-info {
            flex: 1;
            min-width: 0;
        }

        .result-info h4 {
            color: var(--text-primary);
            font-size: 1.2em;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .result-info p {
            color: var(--text-secondary);
            font-size: 0.95em;
            margin: 0;
        }

        .result-arrow {
            font-size: 24px;
            color: var(--metro-main);
            font-weight: bold;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .search-result-item:hover .result-arrow {
            opacity: 1;
            transform: translateX(5px);
        }

        /* Informaci√≥n detallada */
        .detailed-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .info-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--metro-main);
        }

        .info-card h5 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
        }

        .line-data-header {
            background: var(--metro-main);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        /* L√≠neas */
        .lines-section {
            margin-bottom: 25px;
        }

        .lines-section h4 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .lines-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .line-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .line-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .line-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .line-header .line-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .line-header .line-info img {
            width: 24px;
            height: 24px;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        .line-header .line-info strong {
            font-size: 1.2em;
            font-weight: 700;
        }

        .directions-count {
            background: var(--metro-main);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .directions-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .line-direction {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid;
            transition: all 0.3s ease;
        }

        .line-direction:hover {
            background: var(--bg-secondary);
            transform: translateX(5px);
        }

        .direction-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .direction-icon {
            font-size: 1.1em;
        }

        .direction-name {
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .line-name {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .line-name img {
            width: 18px;
            height: 18px;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        .line-destination {
            font-size: 0.95em;
            color: var(--text-secondary);
        }

        .line-destination strong {
            color: var(--text-primary);
        }

        /* Estados y utilidades */
        .no-data {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--metro-main);
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--metro-main);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #ffe6e6;
            border: 1px solid #ffcccc;
            color: #cc0000;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .last-updated {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            color: #0066cc;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .footer {
            text-align: center;
            margin-top: 60px;
            padding: 20px;
            color: var(--text-secondary);
            border-top: 1px solid var(--border-color);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-content {
                padding: 20px;
            }
            
            .search-form-centered {
                flex-direction: column;
            }
            
            .station-header {
                flex-direction: column;
                text-align: center;
            }
            
            .station-icon {
                margin-right: 0;
                margin-bottom: 15px;
            }

            .detailed-info {
                grid-template-columns: 1fr;
            }

            .search-results-grid {
                grid-template-columns: 1fr;
            }
            
            .search-result-item {
                padding: 15px;
                min-height: 70px;
            }
            
            .result-icon {
                width: 40px;
                height: 40px;
            }
            
            .result-icon img {
                width: 28px;
                height: 28px;
            }

            .lines-grid {
                grid-template-columns: 1fr;
            }
            
            .line-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .directions-container {
                gap: 10px;
            }
            
            .line-direction {
                padding: 12px;
            }
        }

        /* Secci√≥n de Modelo 3D */
        .model-3d-section {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 30px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .model-3d-section h4 {
            color: var(--text-primary);
            font-size: 1.5em;
            margin-bottom: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .model-3d-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .model-3d-image-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            background: #f0f2f5;
            border-radius: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .model-3d-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
            border-radius: 0;
            box-shadow: none;
        }

     

        .model-3d-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .model-3d-station-name {
            font-size: 1.1em;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0,0,0,0.7);
        }

        .model-3d-line-info {
            font-size: 0.85em;
            opacity: 0.95;
            text-shadow: 0 1px 2px rgba(0,0,0,0.7);
        }

        .model-3d-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .model-3d-btn {
            background: var(--metro-main);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }

        .model-3d-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .model-3d-btn:active {
            transform: translateY(0);
        }

        .model-3d-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Responsive para modelos 3D */
        @media (max-width: 768px) {
            .model-3d-image-container {
                aspect-ratio: 1 / 1; /* Mantiene el cuadrado en m√≥vil */
            }
            
            .model-3d-image {
                height: 300px;
            }
            
            .model-3d-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .model-3d-btn {
                width: 100%;
                max-width: 200px;
            }
        }

        /* Animaci√≥n de carga para modelo 3D */
        .model-3d-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .model-3d-loading::after {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--metro-main);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Estilos adicionales para modelos 3D */
        .model-3d-not-available {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 400px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 2px dashed var(--border-color);
        }

        .model-3d-placeholder {
            text-align: center;
            padding: 40px;
            max-width: 400px;
        }

        .model-3d-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.7;
        }

        .model-3d-placeholder h4 {
            color: var(--text-primary);
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .model-3d-placeholder p {
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.5;
        }

        .model-3d-download-btn {
            background: var(--metro-main);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .model-3d-download-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .model-3d-source {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-top: 15px;
        }

        .model-3d-source a {
            color: var(--metro-main);
            text-decoration: none;
            font-weight: 600;
        }

        .model-3d-source a:hover {
            text-decoration: underline;
        }

        .model-3d-error {
            text-align: center;
            padding: 40px;
            max-width: 400px;
        }

        .model-3d-error .model-3d-icon {
            font-size: 3em;
            margin-bottom: 20px;
            color: #f44336;
        }

        .model-3d-error h4 {
            color: #f44336;
            font-size: 1.3em;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .model-3d-error p {
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    {% include 'header.html' %}

    <div class="main-content">
        <div class="page-header">
            <h1>
                <img src="/static/logos/MetroMadridLogo_10.svg" alt="Metro de Madrid" class="header-icon">
                Informaci√≥n de Estaci√≥n
            </h1>
            <p>Consulta datos en tiempo real de cualquier estaci√≥n del Metro de Madrid</p>
        </div>

        <!-- Secci√≥n de b√∫squeda -->
        <div class="search-section">
            <div class="search-container-centered">
                <h2 class="search-title">Buscar Estaci√≥n</h2>
                <form id="searchForm" class="search-form-centered">
                    <div class="search-input-container">
                        <input type="text" id="stationSearch" placeholder="Escribe el nombre de una estaci√≥n..." autocomplete="off">
                        <div class="autocomplete-results" id="autocompleteResults"></div>
                    </div>
                    <button type="submit" class="search-btn-rocket">üöÄ</button>
                </form>
                <p class="search-tips">
                    üí° Ejemplos: "Sol", "Callao", "Gran V√≠a", "Alonso Mart√≠nez"<br>
                    ‚ö° Al hacer clic en "Cargar" se ejecutar√° el scraper para obtener datos actualizados
                </p>
            </div>
        </div>

        <!-- Resultados de b√∫squeda -->
        {% if search_results %}
        <div class="search-results-section">
            <div class="search-results-header">
                <h3>üîç Resultados de b√∫squeda para "{{ search_query }}"</h3>
                <p>Se encontraron {{ search_results|length }} estaciones. Selecciona una para ver sus datos:</p>
            </div>
            <div class="search-results-grid">
                {% for estacion in search_results %}
                <div class="search-result-item" onclick="selectStationById({{ estacion|tojson }})">
                    <div class="result-icon">
                        <img src="{{ LINE_LOGOS.get(estacion.linea, '/static/logos/lineas/_ml.svg') }}" alt="L√≠nea {{ estacion.linea }}">
                    </div>
                    <div class="result-info">
                        <h4>{{ estacion.nombre }}</h4>
                        <p>L√≠nea {{ estacion.linea }} ‚Ä¢ ID: {{ estacion.id_fijo }}</p>
                    </div>
                    <div class="result-arrow">‚Üí</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Informaci√≥n de la estaci√≥n -->
        <div class="station-info" id="stationInfo" style="display:none;">
            <div class="station-header">
                <div class="station-icon" id="stationIcon">üöâ</div>
                <div class="station-details">
                    <h3 id="stationName">Nombre de la Estaci√≥n</h3>
                    <p id="stationId">ID: --</p>
                    <span class="station-status" id="stationStatus"></span>
                </div>
                <div class="station-actions">
                    <button id="refreshButton" class="refresh-btn" style="display: none;" onclick="refreshStationData()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                        Actualizar
                    </button>
                </div>
            </div>

            <div class="last-updated" id="lastUpdated" style="display: none;">
                √öltima actualizaci√≥n: <span id="updateTime"></span>
            </div>

            <!-- Pr√≥ximos trenes -->
            <div class="schedules-section">
                <h4>Pr√≥ximos Trenes</h4>
                <div id="modernTrainsContainer"></div> 
                </div>
            
            <!-- Vista 3D de la estaci√≥n -->
            <div class="model-3d-section" id="model3dSection" style="display: none;">
                <h4>üèóÔ∏è Vista 3D de la Estaci√≥n</h4>
                <div class="model-3d-container">
                    <div id="model3dContent" class="model-3d-image-container">
                        <img id="model3dImage" src="" alt="Vista 3D de la estaci√≥n" class="model-3d-image" style="display: none;">
                        <!-- El estado de carga o error se manejar√° aqu√≠ por JS -->
                </div> 
                    <div class="model-3d-actions">
                        <button id="downloadModel3dBtn" class="model-3d-btn" style="display: none;">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="currentColor"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                            Descargar
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Informaci√≥n detallada -->
            <div class="detailed-info" id="detailedInfo" style="display: none;">
                <div class="info-card services-card">
                    <h5>üõ†Ô∏è Servicios Disponibles</h5>
                    <div id="servicesContent"></div>
                </div>

                <div class="info-card accesses-card">
                    <h5>üö™ Accesos</h5>
                    <div id="accessesContent"></div>
                </div>

                <div class="info-card connections-card">
                    <h5>üîó Conexiones</h5>
                    <div id="connectionsContent"></div>
                    </div>
                </div>

            <!-- L√≠neas -->
            <div class="lines-section">
                <h4>L√≠neas que pasan por esta estaci√≥n</h4>
                <div class="lines-grid" id="linesGrid"></div>
                </div>
        </div>

        <div class="footer">
            <p>¬© 2025 Metro de Madrid - Sistema de Informaci√≥n de Estaciones</p>
            <p>Datos actualizados en tiempo real</p>
        </div>
    </div>

    <!-- Script del sistema moderno de trenes -->
    <script src="/static/js/modern-trains.js"></script>

    <script>
        // Variables globales
        let currentStationName = '';
        let currentIdModal = null;
        let autocompleteTimeout;
        let selectedIndex = -1;
        let autocompleteData = [];

        // Configuraci√≥n de l√≠neas
        const LINE_COLORS = {
            '1': '#00AEEF', '2': '#FF0000', '3': '#FFDF00', '4': '#824100',
            '5': '#339900', '6': '#999999', '7': '#FF6600', '8': '#FF69B4',
            '9': '#990066', '10': '#000099', '11': '#006600', '12': '#999933',
            'Ramal': '#FF0000'
        };

        const LINE_LOGOS = {
            '1': '/static/logos/lineas/linea-1.svg',
            '2': '/static/logos/lineas/linea-2.svg',
            '3': '/static/logos/lineas/linea-3.svg',
            '4': '/static/logos/lineas/linea-4.svg',
            '5': '/static/logos/lineas/linea-5.svg',
            '6': '/static/logos/lineas/linea-6-circular.svg',
            '7': '/static/logos/lineas/linea-7.svg',
            '8': '/static/logos/lineas/linea-8.svg',
            '9': '/static/logos/lineas/linea-9.svg',
            '10': '/static/logos/lineas/linea-10.svg',
            '11': '/static/logos/lineas/linea-11.svg',
            '12': '/static/logos/lineas/linea-12-metrosur.svg',
            'Ramal': '/static/logos/lineas/ramal.svg'
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Script de station.html cargado');
            initializeEventListeners();
            handleAutoLoad();
        });

        // Inicializar event listeners
        function initializeEventListeners() {
            const searchInput = document.getElementById('stationSearch');
            const searchForm = document.getElementById('searchForm');

            if (searchInput) {
                searchInput.addEventListener('input', handleSearchInput);
                searchInput.addEventListener('keydown', handleSearchKeydown);
            }

            if (searchForm) {
                searchForm.addEventListener('submit', handleSearchSubmit);
            }

            // Cerrar autocompletado al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    hideAutocomplete();
                }
            });
        }

        // Manejar auto-load de estaci√≥n
        function handleAutoLoad() {
            {% if auto_load and station_id %}
            window.currentStationId = {{ station_id }};
            const stationName = "{{ station_data['nombre'] if station_data else '' }}";
            document.getElementById('stationSearch').value = stationName;
            
            if (stationName) {
                currentStationName = stationName;
                // Cargar datos de la estaci√≥n por ID
                loadStationDataById(window.currentStationId, stationName);
            }
            
            if (typeof updateModernTrainsById === 'function') {
                updateModernTrainsById(window.currentStationId, 'modernTrainsContainer');
            }
        {% elif auto_load and station_name and station_data %}
            currentStationName = "{{ station_name }}";
            document.getElementById('stationSearch').value = "{{ station_name }}";
            
            // Mostrar la informaci√≥n de la estaci√≥n inmediatamente
            const stationInfo = document.getElementById('stationInfo');
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            // Cargar datos inmediatamente
            searchStationWithNinjaScrap(currentStationName);
            
            // Cargar trenes modernos si est√° disponible
            if (typeof updateModernTrains === 'function') {
                updateModernTrains(currentStationName, 'modernTrainsContainer');
            }
            
            // Actualizar datos en tiempo real despu√©s de 1 segundo
            setTimeout(() => {
                console.log('üîÑ Ejecutando actualizaci√≥n autom√°tica de datos...');
                if (typeof refreshStationData === 'function') {
                    refreshStationData();
                } else {
                    // Fallback: ejecutar scraping directamente
                    executeNinjaScrap(currentStationName);
                }
            }, 1000);
        {% elif station_name and not station_data %}
            document.getElementById('stationSearch').value = "{{ station_name }}";
            console.log('üîç Mostrando opciones de b√∫squeda para: {{ station_name }}');
        {% endif %}
        }
        
        // Funci√≥n para cargar datos de estaci√≥n por ID
        async function loadStationDataById(stationId, stationName) {
            try {
                console.log(`üîç Cargando datos para estaci√≥n ID ${stationId}: ${stationName}`);
                
                // Buscar la estaci√≥n en la base de datos
                const response = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error || !Array.isArray(data) || data.length === 0) {
                    console.error('No se encontraron datos para la estaci√≥n');
                    return;
                }
                
                const groupedStations = groupStationsByName(data);
                const firstStation = groupedStations[0];
                
                const station = {
                    name: firstStation.nombre,
                    id: firstStation.nombre,
                    lines: firstStation.lines.map(result => ({
                        short_name: result.linea,
                        long_name: `L√≠nea ${result.linea}`,
                        color: getLineColor(result.linea),
                        url: result.url || null
                    }))
                };
                
                // Actualizar informaci√≥n de la estaci√≥n
                updateStationInfo(station);
                
                // Cargar datos en tiempo real
                await executeNinjaScrap(stationName);
                
                console.log(`‚úÖ Datos cargados para ${stationName}`);
                
            } catch (error) {
                console.error('Error cargando datos de estaci√≥n por ID:', error);
            }
        }

        // Manejar input de b√∫squeda
        function handleSearchInput(e) {
            const query = e.target.value.trim();
            
            if (autocompleteTimeout) {
                clearTimeout(autocompleteTimeout);
            }
            
            if (query.length < 2) {
                hideAutocomplete();
                return;
            }
            
            autocompleteTimeout = setTimeout(() => {
                searchAutocomplete(query);
            }, 300);
        }

        // Manejar teclas en b√∫squeda
        function handleSearchKeydown(e) {
            const results = document.getElementById('autocompleteResults');
            const items = results.querySelectorAll('.autocomplete-item');
            
            if (items.length === 0) return;
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
                    updateSelection(items);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedIndex = Math.max(selectedIndex - 1, -1);
                    updateSelection(items);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedIndex >= 0 && autocompleteData[selectedIndex]) {
                        selectStationById(autocompleteData[selectedIndex]);
                    } else if (autocompleteData.length > 0) {
                        selectStationById(autocompleteData[0]);
                    } else {
                        document.getElementById('searchForm').submit();
                    }
                    break;
                case 'Escape':
                    hideAutocomplete();
                    break;
            }
        }

        // Manejar env√≠o de formulario
        async function handleSearchSubmit(e) {
            e.preventDefault();
            const searchTerm = document.getElementById('stationSearch').value.trim();
            if (!searchTerm) return;
            await searchStationWithNinjaScrap(searchTerm);
        }

        // B√∫squeda de autocompletado
        async function searchAutocomplete(query) {
            const resultsDiv = document.getElementById('autocompleteResults');
            
            resultsDiv.innerHTML = '<div class="loading-indicator">üîç Buscando estaciones...</div>';
            resultsDiv.style.display = 'block';
            
            try {
                const response = await fetch(`/api/station/search?q=${encodeURIComponent(query)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                autocompleteData = Array.isArray(data) ? data : [];
                
                if (autocompleteData.length === 0) {
                    resultsDiv.innerHTML = '<div class="loading-indicator">No se encontraron estaciones</div>';
                    return;
                }
                
                const groupedStations = groupStationsByName(autocompleteData);
                const resultsHTML = groupedStations.map(station => {
                    const lines = station.lines.map(line => `L${line.linea}`).join(', ');
                    const lineImages = station.lines.map(line => {
                        const lineInfo = getLineInfo(line.linea);
                        return `<img src="${lineInfo.logo}" alt="L√≠nea ${line.linea}" style="width: 16px; height: 16px; margin-right: 2px;">`;
                    }).join('');
                    
                    const lineObj = station.lines[0];
                    const lineObjEscaped = encodeURIComponent(JSON.stringify(lineObj));
                    
                    return `
                        <div class="autocomplete-item" onclick="selectStationById(JSON.parse(decodeURIComponent('${lineObjEscaped}')))">
                            <div class="station-icon-small" style="background: #333; display: flex; gap: 2px; padding: 4px;">
                                ${lineImages}
                            </div>
                            <div class="station-info-autocomplete">
                                <div class="station-name">${station.nombre}</div>
                                <div class="station-lines">L√≠neas: ${lines}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                resultsDiv.innerHTML = resultsHTML;
                selectedIndex = -1;
                
            } catch (error) {
                console.error('‚ùå Error en autocompletado:', error);
                resultsDiv.innerHTML = '<div class="loading-indicator">Error al buscar estaciones</div>';
            }
        }

        // Agrupar estaciones por nombre
        function groupStationsByName(stations) {
            const grouped = {};
            
            stations.forEach(station => {
                const nombre = station.value || station.nombre;
                const linea = station.linea;
                
                if (!grouped[nombre]) {
                    grouped[nombre] = {
                        nombre: nombre,
                        lines: []
                    };
                }
                
                const lineExists = grouped[nombre].lines.some(line => line.linea === linea);
                if (!lineExists) {
                    grouped[nombre].lines.push({
                        linea: linea,
                        id_fijo: station.id_fijo,
                        id_modal: station.id_modal
                    });
                }
            });
            
            return Object.values(grouped);
        }

        // Actualizar selecci√≥n en autocompletado
        function updateSelection(items) {
            items.forEach((item, index) => {
                if (index === selectedIndex) {
                    item.classList.add('selected');
                    item.scrollIntoView({ block: 'nearest' });
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Ocultar autocompletado
        function hideAutocomplete() {
            const resultsDiv = document.getElementById('autocompleteResults');
            resultsDiv.style.display = 'none';
            selectedIndex = -1;
        }

        // Seleccionar estaci√≥n por ID
        async function selectStationById(station) {
            console.log('üéØ selectStationById llamada con:', station);
            
            if (typeof station === 'object' && station.id_fijo) {
                console.log('üöÄ Redirigiendo a /station/id/' + station.id_fijo);
                window.location.href = '/station/id/' + station.id_fijo;
                return;
            }
            
            if (!isNaN(station)) {
                console.log('üöÄ Redirigiendo a /station/id/' + station);
                window.location.href = '/station/id/' + station;
                return;
            }
            
            if (typeof station === 'string') {
                console.log('üéØ Seleccionando estaci√≥n por nombre:', station);
                
                if (!station || station === 'undefined' || station.trim() === '') {
                    console.error('‚ùå Nombre de estaci√≥n inv√°lido en selectStation:', station);
                    return;
                }
                
                hideAutocomplete();
                document.getElementById('stationSearch').value = station;
                await searchStationWithNinjaScrap(station);
                return;
            }
            
            console.error('‚ùå No se pudo identificar la estaci√≥n:', station);
            alert('No se pudo identificar la estaci√≥n.');
        }

        // B√∫squeda principal con NinjaScrap
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName || stationName === 'undefined' || stationName.trim() === '') {
                console.error('‚ùå Nombre de estaci√≥n inv√°lido:', stationName);
                return;
            }
            
            currentStationName = stationName;
            
            const stationInfo = document.getElementById('stationInfo');
            const linesGrid = document.getElementById('linesGrid');
            const detailedInfo = document.getElementById('detailedInfo');
            const lastUpdated = document.getElementById('lastUpdated');
            const refreshButton = document.getElementById('refreshButton');
            
            // Mostrar la informaci√≥n de la estaci√≥n inmediatamente
            stationInfo.style.display = 'block';
            stationInfo.classList.add('show');
            linesGrid.innerHTML = '<div class="loading">üöÄ Ejecutando NinjaScrap para obtener datos en tiempo real...</div>';
            detailedInfo.style.display = 'none';
            lastUpdated.style.display = 'none';
            refreshButton.style.display = 'inline-block';
            
            try {
                console.log(`üîç Buscando estaci√≥n: ${stationName}`);
                const response = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const results = Array.isArray(data) ? data : [];
                
                if (results.length === 0) {
                    linesGrid.innerHTML = '<div class="no-data">No se encontr√≥ la estaci√≥n especificada</div>';
                    refreshButton.style.display = 'none';
                    return;
                }
                
                const groupedStations = groupStationsByName(results);
                const firstStation = groupedStations[0];
                
                const station = {
                    name: firstStation.nombre,
                    id: firstStation.nombre,
                    lines: firstStation.lines.map(result => ({
                        short_name: result.linea,
                        long_name: `L√≠nea ${result.linea}`,
                        color: getLineColor(result.linea),
                        url: result.url || null
                    }))
                };
                
                console.log(`‚úÖ Estaci√≥n encontrada: ${station.name} con ${station.lines.length} l√≠neas`);
                
                // Actualizar informaci√≥n de la estaci√≥n
                updateStationInfo(station);
                
                // Ejecutar scraping inmediatamente
                await executeNinjaScrap(stationName);
                
                console.log(`‚úÖ Datos cargados para ${stationName}`);
                
            } catch (error) {
                console.error('‚ùå Error en NinjaScrap:', error);
                linesGrid.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                refreshButton.style.display = 'none';
            }
        }

        // Ejecutar NinjaScrap
        async function executeNinjaScrap(stationName) {
            try {
                const response = await fetch(`/api/station/realtime/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    console.warn('Error en tiempo real:', data.error);
                    await loadIntelligentData(stationName);
                    return;
                }
                
                displayRealtimeData(data);
                
            } catch (error) {
                console.warn('Error ejecutando scraping en tiempo real:', error);
                await loadIntelligentData(stationName);
            }
        }

        // Mostrar datos en tiempo real
        function displayRealtimeData(data) {
            console.log('Datos en tiempo real recibidos:', data);
            const detailedInfo = document.getElementById('detailedInfo');
            const lastUpdated = document.getElementById('lastUpdated');
            const updateTime = document.getElementById('updateTime');
            const modernTrainsContainer = document.getElementById('modernTrainsContainer');
            const servicesContent = document.getElementById('servicesContent');
            const accessesContent = document.getElementById('accessesContent');
            const connectionsContent = document.getElementById('connectionsContent');
            
            servicesContent.innerHTML = '';
            accessesContent.innerHTML = '';
            connectionsContent.innerHTML = '';

            if (data.timestamp) {
                const updateDate = new Date(data.timestamp);
                updateTime.textContent = updateDate.toLocaleString('es-ES');
                lastUpdated.style.display = 'block';
            }
            
            const stationStatus = determineStationStatus(data);
            updateStationStatus(stationStatus);
            
            if (data.next_trains_html) {
                // Si hay datos de trenes, mostrarlos
                if (typeof modernTrainsRenderer !== 'undefined' && modernTrainsRenderer.renderTrains) {
                    modernTrainsRenderer.renderTrains('modernTrainsContainer', data.next_trains_html);
                } else {
                    // Fallback: mostrar HTML directamente
                    modernTrainsContainer.innerHTML = data.next_trains_html;
                }
            } else {
                // Si no hay datos de trenes
                if (typeof modernTrainsRenderer !== 'undefined' && modernTrainsRenderer.renderNoTrains) {
                    modernTrainsRenderer.renderNoTrains('modernTrainsContainer');
                } else {
                    modernTrainsContainer.innerHTML = '<div class="no-data">No hay informaci√≥n de pr√≥ximos trenes disponible</div>';
                }
            }
            
            if (data.stored_data && data.stored_data.length > 0) {
                const stationData = data.stored_data[0];
                currentIdModal = stationData.id_modal || null;
                
                if (stationData.modulos) {
                    if (stationData.modulos.servicios && stationData.modulos.servicios.disponible) {
                        const serviciosHTML = loadServicesFromRelational(stationData.modulos.servicios.datos, stationData.nombre);
                        servicesContent.innerHTML = serviciosHTML;
                    } else {
                        servicesContent.innerHTML = '<div class="no-data">No hay informaci√≥n de servicios disponible.</div>';
                    }
                    
                    // Cargar accesos desde GTFS (nueva base de datos)
                    loadAccessesFromGTFS(stationData.nombre);
                    
                    if (stationData.modulos.conexiones && stationData.modulos.conexiones.disponible) {
                        const conexionesHTML = loadConnectionsFromRelational(stationData.modulos.conexiones.datos, stationData.nombre);
                        if (conexionesHTML && !conexionesHTML.includes('No hay conexiones disponibles')) {
                            connectionsContent.innerHTML = conexionesHTML;
                            document.querySelector('.connections-card').style.display = 'block';
                        } else {
                            document.querySelector('.connections-card').style.display = 'none';
                        }
                    } else {
                        document.querySelector('.connections-card').style.display = 'none';
                    }
                }
            } else {
                servicesContent.innerHTML = '<div class="no-data">No hay informaci√≥n de servicios disponible.</div>';
                accessesContent.innerHTML = '<div class="no-data">No hay informaci√≥n de accesos disponible.</div>';
                document.querySelector('.connections-card').style.display = 'none';
            }
            
            detailedInfo.style.display = 'grid';

            const stationName = data.station_name || currentStationName;
            fetch(`/api/station/closed-status/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(statusData => {
                    if (statusData.cerrada) {
                        updateStationStatus('Cerrada');
                    } else {
                        const stationStatus = determineStationStatus(data);
                        updateStationStatus(stationStatus);
                    }
                })
                .catch(() => {
                    const stationStatus = determineStationStatus(data);
                    updateStationStatus(stationStatus);
                });
        }

        // Funci√≥n para cargar accesos desde datos reales del scraping
        function loadAccessesFromRealData(accesos, stationName) {
            if (!accesos || accesos.length === 0) return '<div class="no-data">No hay accesos disponibles.</div>';
            
            let html = `<div class="line-data-header">${stationName}</div>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">TIPO DE ACCESO</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
            html += '</tr></thead><tbody>';
            
            accesos.forEach(acceso => {
                const icon = getAccessIcon(acceso.tipo);
                    html += '<tr style="border-bottom: 1px solid #eee;">';
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${acceso.tipo}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.vestibulo || 'No especificado'}</td>`;
                    html += '</tr>';
            });
            
            html += '</tbody></table>';
            return html;
        }

        // Funci√≥n para obtener icono de acceso
        function getAccessIcon(tipoAcceso) {
            const iconMap = {
                'Ascensor': 'üõó',
                'Escalera': 'üõó',
                'Acceso': 'üö™',
                'Entrada': 'üö™',
                'Salida': 'üö™',
                'Escaleras mec√°nicas': 'üõó',
                'Rampa': '‚ôø'
            };
            
            return iconMap[tipoAcceso] || 'üö™';
        }

        // Funciones de utilidad
        function getLineColor(lineNumber) {
            return LINE_COLORS[lineNumber] || '#666';
        }

        function getLineLogo(lineNumber) {
            return LINE_LOGOS[lineNumber] || '/static/logos/lineas/_ml.svg';
        }

        function getLineInfo(lineNumber) {
            return {
                color: getLineColor(lineNumber),
                logo: getLineLogo(lineNumber)
            };
        }

        function determineStationStatus(stationData) {
            if (!stationData || !stationData.realtime) {
                return 'Operativa';
            }
            
            const realtimeData = stationData.realtime;
            
            const hasTrainData = realtimeData.proximos_trenes_html && 
                                realtimeData.proximos_trenes_html.length > 0 &&
                                !realtimeData.proximos_trenes_html.includes('No se pudieron obtener');
            
            const ascensoresStatus = realtimeData.estado_ascensores || '';
            const escalerasStatus = realtimeData.estado_escaleras || '';
            
            if (!hasTrainData) {
                return 'Cerrada';
            }
            
            const serviciosCriticos = ascensoresStatus.toLowerCase().includes('fuera de servicio') &&
                                     escalerasStatus.toLowerCase().includes('fuera de servicio');
            
            if (serviciosCriticos) {
                return 'Cerrada';
            }
            
            return 'Operativa';
        }

        function updateStationStatus(status) {
            const statusElement = document.getElementById('stationStatus');
            if (status) {
                const statusClass = status.toLowerCase().includes('operativa') ? 'status-operativa' : 'status-cerrada';
                statusElement.textContent = '';
                statusElement.className = `station-status ${statusClass}`;
            }
        }

        // Actualizar informaci√≥n de estaci√≥n
        function updateStationInfo(station) {
            document.getElementById('stationName').textContent = station.name;
            document.getElementById('stationId').textContent = `Estaci√≥n: ${station.name}`;
            
            if (station.lines && station.lines.length > 0) {
                if (station.lines.length === 1) {
                    const lineInfo = getLineInfo(station.lines[0].short_name);
                    document.body.style.background = `linear-gradient(135deg, ${lineInfo.color}40 0%, ${lineInfo.color}20 50%, #f7f7f7 100%)`;
                } else if (station.lines.length >= 2) {
                    const line1Info = getLineInfo(station.lines[0].short_name);
                    const line2Info = getLineInfo(station.lines[1].short_name);
                    document.body.style.background = `linear-gradient(135deg, ${line1Info.color}40 0%, ${line2Info.color}40 50%, #f7f7f7 100%)`;
                }
            } else {
                document.body.style.background = '#f7f7f7';
            }
            
            const stationIcon = document.getElementById('stationIcon');
            if (station.lines && station.lines.length > 0) {
                if (station.lines.length === 1) {
                    const lineInfo = getLineInfo(station.lines[0].short_name);
                    stationIcon.style.background = lineInfo.color;
                    stationIcon.innerHTML = `<img src="${lineInfo.logo}" alt="L√≠nea ${station.lines[0].short_name}" style="width: 30px; height: 30px;">`;
                } else if (station.lines.length === 2) {
                    const line1Info = getLineInfo(station.lines[0].short_name);
                    const line2Info = getLineInfo(station.lines[1].short_name);
                    stationIcon.style.background = `linear-gradient(45deg, ${line1Info.color} 50%, ${line2Info.color} 50%)`;
                    stationIcon.innerHTML = `
                        <div style="display: flex; gap: 2px;">
                            <img src="${line1Info.logo}" alt="L√≠nea ${station.lines[0].short_name}" style="width: 15px; height: 15px;">
                            <img src="${line2Info.logo}" alt="L√≠nea ${station.lines[1].short_name}" style="width: 15px; height: 15px;">
                        </div>
                    `;
                } else {
                    stationIcon.style.background = '#808080';
                    stationIcon.textContent = station.lines.length;
                }
            } else {
                stationIcon.style.background = '#666';
                stationIcon.textContent = '?';
            }
            
            updateLinesGrid(station);
            
            // Cargar vista 3D de la estaci√≥n
            if (station.lines && station.lines.length > 0) {
                const lineNumber = station.lines[0].short_name;
                console.log(`üèóÔ∏è Cargando vista 3D para ${station.name} (L√≠nea ${lineNumber})`);
                updateModel3D(station.name, lineNumber);
            }
        }

        // Actualizar grid de l√≠neas
        function updateLinesGrid(station) {
            const linesGrid = document.getElementById('linesGrid');
            const lineDestinations = {
                '1': { ida: 'Valdecarros', vuelta: 'Pinar de Chamart√≠n' },
                '2': { ida: 'Las Rosas', vuelta: 'Cuatro Caminos' },
                '3': { ida: 'Villaverde Alto', vuelta: 'Moncloa' },
                '4': { ida: 'Pinar de Chamart√≠n', vuelta: 'Arg√ºelles' },
                '5': { ida: 'Casa de Campo', vuelta: 'Alameda de Osuna' },
                '6': { ida: 'Laguna', vuelta: 'Lucero' },
                '7': { ida: 'Pitis', vuelta: 'Hospital del Henares' },
                '8': { ida: 'Aeropuerto T4', vuelta: 'Nuevos Ministerios' },
                '9': { ida: 'Paco de Luc√≠a', vuelta: 'Mirasierra' },
                '10': { ida: 'Hospital Infanta Sof√≠a', vuelta: 'Puerta del Sur' },
                '11': { ida: 'La Fortuna', vuelta: 'Plaza El√≠ptica' },
                '12': { ida: 'Puerta del Sur', vuelta: 'Hospital Infanta Sof√≠a' },
                'Ramal': { ida: '√ìpera', vuelta: 'Pr√≠ncipe P√≠o' }
            };
            
            if (station.lines && station.lines.length > 0) {
                const linesHTML = station.lines.map(line => {
                    const destinations = lineDestinations[line.short_name] || { ida: 'Destino', vuelta: 'Origen' };
                    const lineInfo = getLineInfo(line.short_name);
                    
                    return `
                        <div class="line-card" style="border-left-color: ${lineInfo.color}">
                            <div class="line-header">
                                <div class="line-info">
                                    <img src="${lineInfo.logo}" alt="L√≠nea ${line.short_name}">
                                    <strong>L√≠nea ${line.short_name}</strong>
                                </div>
                                <span class="directions-count">2 sentidos</span>
                            </div>
                            <div class="directions-container">
                                <div class="line-direction" style="border-left-color: ${lineInfo.color}">
                                    <div class="direction-header">
                                        <span class="direction-icon">‚û°Ô∏è</span>
                                        <span class="direction-name">IDA</span>
                                    </div>
                                    <div class="line-name">
                                        <img src="${lineInfo.logo}" alt="L√≠nea ${line.short_name}">
                                        L√≠nea ${line.short_name}
                                    </div>
                                    <div class="line-destination">
                                        <strong>Destino:</strong> ${destinations.ida}
                                    </div>
                                </div>
                                <div class="line-direction" style="border-left-color: ${lineInfo.color}">
                                    <div class="direction-header">
                                        <span class="direction-icon">‚¨ÖÔ∏è</span>
                                        <span class="direction-name">VUELTA</span>
                                    </div>
                                    <div class="line-name">
                                        <img src="${lineInfo.logo}" alt="L√≠nea ${line.short_name}">
                                        L√≠nea ${line.short_name}
                                    </div>
                                    <div class="line-destination">
                                        <strong>Destino:</strong> ${destinations.vuelta}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                linesGrid.innerHTML = linesHTML;
            } else {
                linesGrid.innerHTML = '<div class="no-data">No hay informaci√≥n de l√≠neas disponible</div>';
            }
        }

        // Actualizar datos de estaci√≥n
        async function refreshStationData() {
            if (!currentStationName) {
                console.warn('No hay estaci√≥n seleccionada para actualizar');
                return;
            }
            
            console.log('üöÄ Actualizando datos en tiempo real de:', currentStationName);
            
            const refreshBtn = document.getElementById('refreshButton');
            const originalText = refreshBtn.textContent;
            refreshBtn.textContent = '‚è≥ Actualizando...';
            refreshBtn.disabled = true;
            
            try {
                const response = await fetch(`/api/station/realtime/${encodeURIComponent(currentStationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                
                const updateTime = document.getElementById('updateTime');
                updateTime.textContent = new Date().toLocaleString('es-ES');
                
                console.log('‚úÖ Datos en tiempo real actualizados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error actualizando datos en tiempo real:', error);
                alert('Error al actualizar los datos en tiempo real. Int√©ntalo de nuevo.');
            } finally {
                refreshBtn.textContent = originalText;
                refreshBtn.disabled = false;
            }
        }

        // Cargar datos inteligentes
        async function loadIntelligentData(stationName) {
            const detailedInfo = document.getElementById('detailedInfo');
            const lastUpdated = document.getElementById('lastUpdated');
            const updateTime = document.getElementById('updateTime');
            
            try {
                const response = await fetch(`/api/station/intelligent/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    console.warn('No se encontraron datos inteligentes:', data.error);
                    return;
                }
                
                if (!data.stations || data.stations.length === 0) {
                    console.warn('No se encontraron estaciones en datos inteligentes');
                    return;
                }
                
                const stationData = data.stations[0];
                
                if (stationData.ultima_actualizacion) {
                    const updateDate = new Date(stationData.ultima_actualizacion);
                    updateTime.textContent = updateDate.toLocaleString('es-ES');
                    lastUpdated.style.display = 'block';
                }
                
                updateStationStatus('Operativa');
                loadServices(stationData.services);
                loadAccesses(stationData.access);
                loadConnections([], stationData.intercambiadores ? [stationData.intercambiadores] : []);
                
                detailedInfo.style.display = 'grid';
                
            } catch (error) {
                console.warn('Error cargando datos inteligentes:', error);
            }
        }

        // Funciones para cargar datos relacionales
        function loadServicesFromRelational(servicios, stationName) {
            if (!servicios || servicios.length === 0) return '<div class="no-data">No hay servicios disponibles.</div>';
            let html = `<div class="line-data-header">${stationName}</div>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">SERVICIO</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: center;">ESTADO</th>';
            html += '</tr></thead><tbody>';
            servicios.forEach(servicio => {
                const icon = getServiceIcon(servicio.tipo_servicio || servicio.nombre);
                const statusClass = servicio.disponible ? 'service-available' : 'service-unavailable';
                const statusText = servicio.disponible ? 'Disponible' : 'No disponible';
                html += '<tr style="border-bottom: 1px solid #eee;">';
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${icon} ${servicio.tipo_servicio || servicio.nombre}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd; text-align: center;"><span class="service-icon ${statusClass}" style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; font-size: 10px; line-height: 16px; text-align: center; color: white;">${servicio.disponible ? '‚úì' : '‚úó'}</span> ${statusText}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        }

        function loadAccessesFromRelational(accesos, stationName) {
            if (!accesos || accesos.length === 0) return '<div class="no-data">No hay accesos disponibles.</div>';
            let html = `<div class="line-data-header">${stationName}</div>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
            html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
            html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
            html += '</tr></thead><tbody>';
            accesos.forEach(acceso => {
                html += '<tr style="border-bottom: 1px solid #eee;">';
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.vestibulo || 'No especificado'}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.nombre_acceso || acceso.nombre || 'No especificado'}</td>`;
                html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            return html;
        }

        function loadConnectionsFromRelational(conexiones, stationName) {
            if (!conexiones || conexiones.length === 0) return '<div class="no-data">No hay conexiones disponibles.</div>';
            let html = `<div class="line-data-header">${stationName}</div>`;
            conexiones.forEach(conexion => {
                html += `<div class="connection-item">${conexion.detalle || conexion}</div>`;
            });
            return html;
        }

        // Funci√≥n para cargar accesos desde MetroMadrid
        async function loadAccessesFromMetroMadrid(stationId, stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            try {
                console.log(`üîó Cargando accesos desde MetroMadrid para estaci√≥n ${stationName} (ID: ${stationId})`);
                
                // Mostrar indicador de carga
                accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde MetroMadrid...</div>';
                
                const response = await fetch(`/api/station/accesses/metromadrid/${stationId}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error cargando accesos desde MetroMadrid:', data.error);
                    accessesContent.innerHTML = '<div class="no-data">No hay informaci√≥n de accesos disponible.</div>';
                    return;
                }
                
                if (!data.accesos || data.accesos.length === 0) {
                    accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles en MetroMadrid.</div>';
                    return;
                }
                
                // Generar HTML con los accesos de MetroMadrid
                let html = `<div class="line-data-header">${stationName} - Accesos Oficiales</div>`;
                html += '<div class="metro-madrid-badge" style="background: #0065FE; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìã Datos oficiales de MetroMadrid</div>';
                html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
                html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">NOMBRE DE ACCESO</th>';
                html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">DIRECCI√ìN</th>';
                html += '</tr></thead><tbody>';
                
                data.accesos.forEach(acceso => {
                    html += '<tr style="border-bottom: 1px solid #eee;">';
                    html += `<td style="padding: 8px; border: 1px solid #ddd;"><strong>${acceso.vestibulo || 'No especificado'}</strong></td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.acceso || 'No especificado'}</td>`;
                    html += `<td style="padding: 8px; border: 1px solid #ddd;">${acceso.direccion || 'No especificada'}</td>`;
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                html += `<div style="margin-top: 10px; font-size: 12px; color: #666;">√öltima actualizaci√≥n: ${new Date().toLocaleString('es-ES')}</div>`;
                
                accessesContent.innerHTML = html;
                console.log(`‚úÖ Accesos cargados desde MetroMadrid: ${data.total} accesos`);
                
            } catch (error) {
                console.error('Error cargando accesos desde MetroMadrid:', error);
                accessesContent.innerHTML = '<div class="no-data">Error cargando accesos desde MetroMadrid.</div>';
            }
        }

        function getServiceIcon(tipoServicio) {
            const iconMap = {
                'Ascensores': 'üõó',
                'Escaleras mec√°nicas': 'üõó',
                'Desfibrilador': 'üíì',
                'Cobertura m√≥vil': 'üì±',
                'Bibliometro': 'üìö',
                'Tiendas': 'üõçÔ∏è',
                'Estaci√≥n accesible': '‚ôø',
                'Oficina Objetos Perdidos': 'üìã',
                'Oficina de gesti√≥n TTP': 'üí≥',
                'Parking disuasorio de pago': 'üöó',
                'Quioscos ONCE': 'üì∞',
                'adaptada para discapacitados': '‚ôø',
                'escaleras': 'üõó'
            };
            
            return iconMap[tipoServicio] || 'üîß';
        }

        // Funciones legacy para compatibilidad
        function loadServices(services, linea) {
            const servicesContent = document.getElementById('servicesContent');
            if (!servicesContent) return;
            
            if (!services || Object.keys(services).length === 0) {
                servicesContent.innerHTML = '<div class="no-data">No hay servicios disponibles.</div>';
                return;
            }
            
            let html = '<div class="services-grid">';
            Object.entries(services).forEach(([service, available]) => {
                const icon = getServiceIcon(service);
                const statusClass = available ? 'service-available' : 'service-unavailable';
                const statusText = available ? 'Disponible' : 'No disponible';
                
                html += `
                    <div class="service-item">
                        <div class="service-icon ${statusClass}">${icon}</div>
                        <div class="service-info">
                            <div class="service-name">${service}</div>
                            <div class="service-status">${statusText}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            servicesContent.innerHTML = html;
        }

        // ============================================================================
        // FUNCIONES PARA MODELOS 3D
        // ============================================================================

        // Funci√≥n para cargar y mostrar la vista 3D de una estaci√≥n
        async function loadModel3D(stationName, lineNumber) {
            const model3dSection = document.getElementById('model3dSection');
            const model3dImage = document.getElementById('model3dImage');
            
            if (!model3dSection || !model3dImage) {
                console.warn('Elementos de vista 3D no encontrados');
                return;
            }
            
            // Mostrar secci√≥n
            model3dSection.style.display = 'block';
            
            // Normalizar nombre de estaci√≥n para la URL
            function normalizarNombre(nombre) {
                if (!nombre) return "";
                nombre = nombre.toLowerCase();
                nombre = nombre.replace('√°', 'a').replace('√©', 'e').replace('√≠', 'i').replace('√≥', 'o').replace('√∫', 'u').replace('√±', 'n');
                nombre = nombre.replace('√º', 'u').replace('√ß', 'c');
                nombre = nombre.replace(/[^a-z0-9\s]/g, '');
                nombre = nombre.replace(/\s+/g, '_');
                return nombre;
            }
            
            const normalizedName = normalizarNombre(stationName);
            const originalUrl = `http://estacions.albertguillaumes.cat/img/madrid/${normalizedName}.png`;
            
            // Cargar directamente desde la URL original
            model3dImage.src = originalUrl;
            model3dImage.alt = `Vista 3D de ${stationName}`;
            model3dImage.style.display = 'block';
            
            // Actualizar informaci√≥n
            const stationNameSpan = document.querySelector('.model-3d-station-name');
            const lineInfoSpan = document.querySelector('.model-3d-line-info');
            if (stationNameSpan) stationNameSpan.textContent = stationName;
            if (lineInfoSpan) lineInfoSpan.textContent = `L√≠nea ${lineNumber}`;
            
            console.log(`‚úÖ Vista 3D cargada desde: ${originalUrl}`);
            
            // Manejar errores de carga
            model3dImage.onerror = function() {
                console.log(`‚ùå Error cargando vista 3D para ${stationName}`);
                showModel3DPlaceholder(stationName, originalUrl);
            };
        }
        
        // Funci√≥n para mostrar placeholder cuando no hay vista 3D
        function showModel3DPlaceholder(stationName, downloadUrl = null) {
            const model3dSection = document.getElementById('model3dSection');
            if (!model3dSection) return;
            
            const placeholderHTML = `
                <div class="model-3d-not-available">
                    <div class="model-3d-placeholder">
                        <div class="model-3d-icon">üèóÔ∏è</div>
                        <h4>Vista 3D no disponible</h4>
                        <p>No hay una vista 3D disponible para la estaci√≥n <strong>${stationName}</strong>.</p>
                        ${downloadUrl ? `
                            <button class="btn btn-primary" onclick="downloadModel3D('${stationName}')">
                                üì• Descargar Vista 3D
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            model3dSection.innerHTML = placeholderHTML;
            console.log(`‚ö†Ô∏è Vista 3D no disponible para ${stationName}`);
        }
        
        // Funci√≥n para descargar vista 3D
        async function downloadModel3D(stationName) {
            try {
                console.log(`üì• Descargando vista 3D para ${stationName}...`);
                
                const response = await fetch(`/api/station/model3d/download/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`‚úÖ Vista 3D descargada: ${data.local_path}`);
                    // Recargar la vista 3D despu√©s de descargar
                    const stationData = await getStationData(stationName);
                    if (stationData && stationData.lines && stationData.lines.length > 0) {
                        loadModel3D(stationName, stationData.lines[0].short_name);
                    }
                } else {
                    console.error('Error descargando vista 3D:', data.error);
                    alert('Error al descargar la vista 3D. Int√©ntalo de nuevo.');
                }
                
            } catch (error) {
                console.error('Error en descarga:', error);
                alert('Error al descargar la vista 3D.');
            }
        }

        // Funci√≥n para rotar la vista del modelo 3D
        function rotateModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            // A√±adir clase de rotaci√≥n
            model3dImage.style.transition = 'transform 0.5s ease';
            model3dImage.style.transform = 'rotateY(180deg)';
            
            // Restaurar despu√©s de la animaci√≥n
            setTimeout(() => {
                model3dImage.style.transform = 'rotateY(0deg)';
            }, 500);
            
            console.log('üîÑ Rotando vista del modelo 3D');
        }

        // Funci√≥n para hacer zoom en el modelo 3D
        function zoomModel3D() {
            const model3dImage = document.getElementById('model3dImage');
            if (!model3dImage) return;
            
            const currentScale = model3dImage.style.transform.includes('scale') 
                ? parseFloat(model3dImage.style.transform.match(/scale\(([^)]+)\)/)?.[1] || 1)
                : 1;
            
            const newScale = currentScale === 1 ? 1.5 : 1;
            
            model3dImage.style.transition = 'transform 0.3s ease';
            model3dImage.style.transform = `scale(${newScale})`;
            
            console.log(`üîç Zoom del modelo 3D: ${newScale}x`);
        }

        // Funci√≥n para actualizar el modelo 3D cuando se selecciona una estaci√≥n
        function updateModel3D(stationName, lineNumber) {
            if (!stationName || !lineNumber) {
                const model3dSection = document.getElementById('model3dSection');
                if (model3dSection) {
                    model3dSection.style.display = 'none';
                }
                return;
            }
            
            loadModel3D(stationName, lineNumber);
        }

        // Modificar la funci√≥n existente para incluir el modelo 3D
        async function searchStationWithNinjaScrap(stationName) {
            if (!stationName) return;
            
            currentStationName = stationName;
            const stationInfo = document.getElementById('stationInfo');
            const refreshBtn = document.getElementById('refreshButton');
            
            if (stationInfo) {
                stationInfo.style.display = 'block';
                stationInfo.classList.add('show');
            }
            
            if (refreshBtn) {
                refreshBtn.style.display = 'inline-flex';
            }
            
            // Actualizar nombre de estaci√≥n
            const stationNameElement = document.getElementById('stationName');
            if (stationNameElement) {
                stationNameElement.textContent = stationName;
            }
            
            // Buscar datos de la estaci√≥n para obtener la l√≠nea
            try {
                const searchResponse = await fetch(`/api/station/search?q=${encodeURIComponent(stationName)}`);
                const searchData = await searchResponse.json();
                
                if (searchData && searchData.length > 0) {
                    const stationData = searchData[0];
                    const lineNumber = stationData.linea;
                    
                    // Actualizar ID de estaci√≥n
                    const stationIdElement = document.getElementById('stationId');
                    if (stationIdElement) {
                        stationIdElement.textContent = `ID: ${stationData.id_fijo}`;
                    }
                    
                    // Cargar modelo 3D
                    updateModel3D(stationName, lineNumber);
                    
                    console.log(`üèóÔ∏è Cargando modelo 3D para ${stationName} (L√≠nea ${lineNumber})`);
                }
            } catch (error) {
                console.error('Error obteniendo datos de estaci√≥n para modelo 3D:', error);
            }
            
            // Continuar con el resto de la funcionalidad existente...
            try {
                const response = await fetch(`/api/station/ninjascrap/${encodeURIComponent(stationName)}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayRealtimeData(data);
                loadIntelligentData(stationName);
                
            } catch (error) {
                console.error('Error en searchStationWithNinjaScrap:', error);
                alert('Error al obtener datos de la estaci√≥n. Int√©ntalo de nuevo.');
            }
        }

        // A√±adir despu√©s de la funci√≥n loadAccessesFromMetroMadrid (l√≠nea 2030):

        function loadAccessesFromGTFS(stationName) {
            const accessesContent = document.getElementById('accessesContent');
            if (!accessesContent) return;
            
            // Mostrar indicador de carga
            accessesContent.innerHTML = '<div class="loading">üîÑ Cargando accesos desde GTFS...</div>';
            
            fetch(`/api/station/accesses/gtfs/${encodeURIComponent(stationName)}`)
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error cargando accesos GTFS:', data.error);
                        accessesContent.innerHTML = '<div class="no-data">No se pudieron cargar los accesos.</div>';
                        return;
                    }
                    
                    if (!data.accesos || data.accesos.length === 0) {
                        accessesContent.innerHTML = '<div class="no-data">No hay accesos disponibles para esta estaci√≥n.</div>';
                        return;
                    }
                    
                    // Crear tabla de accesos
                    let html = `<div class="line-data-header">üö™ Accesos - ${data.estacion.nombre}</div>`;
                    html += '<div class="gtfs-badge" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px; margin-bottom: 10px; display: inline-block;">üìä Datos GTFS oficiales</div>';
                    html += '<table style="width: 100%; border-collapse: collapse; margin-top: 10px;">';
                    html += '<thead><tr style="background: #f8f9fa; font-weight: bold;">';
                    html += '<th style="padding: 8px; border: 1px solid #ddd; text-align: left;">VEST√çBULO</th>';
    </script>
</body>
</html>